name: Trigger Cali Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  trigger-cali-bot:
    runs-on: ubuntu-latest

    # Ignore PR comments (we only want issues)
    if: >
      (github.event_name == 'issues') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request == null)

    steps:
      - name: Print debug info
        run: |
          echo "Event:        ${{ github.event_name }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Comment ID:   ${{ github.event.comment.id }}"
          echo "Author:       ${{ github.event.comment.user.login }}"

      - name: Trigger Cali Bot
        run: |
          EVENT_TYPE=""
          COMMENT_ID=""
          COMMENT_AUTHOR=""

          if [ "${{ github.event_name }}" = "issues" ]; then
            EVENT_TYPE="issue_opened"
          else
            EVENT_TYPE="comment_created"
            COMMENT_ID="${{ github.event.comment.id }}"
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          fi

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.CALI_BOT_PAT }}" \
            https://api.github.com/repos/tigera/cali-bot/actions/workflows/process-issue.yml/dispatches \
            -d @- <<EOF
          {
            "ref": "main",
            "inputs": {
              "TRIGGER_EVENT": "$EVENT_TYPE",
              "ISSUE_NUMBER": "${{ github.event.issue.number }}",
              "COMMENT_ID": "$COMMENT_ID",
              "COMMENT_AUTHOR": "$COMMENT_AUTHOR",
              "TARGET_REPO": "${{ github.repository }}"
            }
          }
          EOF
