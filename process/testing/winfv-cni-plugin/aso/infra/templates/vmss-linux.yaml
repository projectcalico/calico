{{- $count := conv.ToInt .Env.LINUX_NODE_COUNT -}}
{{- range $i := seq 0 (sub $count 1) -}}
{{- $nodeNum := add $i 1 -}}
{{- $nodeName := printf "vm-linux-%d" $nodeNum -}}
{{- $nicName := printf "nic-linux-%d" $nodeNum -}}
{{- $pipName := printf "pip-linux-%d" $nodeNum -}}
{{- $extSetupName := printf "vm-linux-%d-setup" $nodeNum -}}
{{- $computerName := printf "winfv-linux-%d" $nodeNum }}
---
apiVersion: compute.azure.com/v1api20220301
kind: VirtualMachine
metadata:
  name: {{$nodeName}}
  namespace: winfv
spec:
  location: {{$.Env.AZURE_LOCATION}}
  owner:
    name: {{$.Env.AZURE_RESOURCE_GROUP}}
  hardwareProfile:
    vmSize: Standard_D4s_v3
  networkProfile:
    networkInterfaces:
      - reference:
          group: network.azure.com
          kind: NetworkInterface
          name: {{$nicName}}
  osProfile:
    computerName: {{$computerName}}
    adminUsername: winfv
    adminPassword:
      key: password
      name: winfv-secret-windows
    linuxConfiguration:
      disablePasswordAuthentication: true
      ssh:
        publicKeys:
          - keyData: {{$.Env.PUBLIC_KEY}}
            path: /home/winfv/.ssh/authorized_keys
  storageProfile:
    imageReference:
      publisher: Canonical
      offer: 0001-com-ubuntu-server-jammy
      sku: 22_04-lts
      version: latest
    osDisk:
      createOption: FromImage
      managedDisk:
        storageAccountType: Premium_LRS
---
apiVersion: compute.azure.com/v1api20220301
kind: VirtualMachinesExtension
metadata:
  name: {{$extSetupName}}
  namespace: winfv
spec:
  location: {{$.Env.AZURE_LOCATION}}
  owner:
    name: {{$nodeName}}
  publisher: Microsoft.Azure.Extensions
  type: CustomScript
  typeHandlerVersion: "2.1"
  autoUpgradeMinorVersion: true
  settings:
    commandToExecute: |
      /bin/bash -c '
      set -e
      echo "=== Starting Linux VM setup ==="
      
      # ============================================
      # Part 1: Install containerd and Docker
      # ============================================
      echo "Installing containerd and Docker..."
      
      # Update package list
      apt-get update
      
      # Install prerequisites
      apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
      
      # Install Docker (includes containerd)
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io
      
      # Configure containerd for Kubernetes
      mkdir -p /etc/containerd
      containerd config default | tee /etc/containerd/config.toml
      
      # Enable systemd cgroup driver (required for Kubernetes)
      sed -i "s/SystemdCgroup = false/SystemdCgroup = true/g" /etc/containerd/config.toml
      
      # Restart containerd
      systemctl restart containerd
      systemctl enable containerd
      
      # Enable and start Docker
      systemctl enable docker
      systemctl start docker
      
      # Verify installations
      containerd --version
      docker --version
      
      echo "Containerd and Docker installation completed successfully"
      
      # ============================================
      # Part 2: Install kubeadm, kubelet, kubectl
      # ============================================
      echo "Installing kubeadm, kubelet, and kubectl..."

      # Disable swap (required for Kubernetes)
      swapoff -a
      sed -i "/ swap / s/^/#/" /etc/fstab

      # Load required kernel modules
      cat <<MODULES | tee /etc/modules-load.d/k8s.conf
      overlay
      br_netfilter
      MODULES

      modprobe overlay
      modprobe br_netfilter

      # Set sysctl params required by Kubernetes
      cat <<SYSCTL | tee /etc/sysctl.d/k8s.conf
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
      SYSCTL

      sysctl --system

      # Install kubeadm, kubelet, and kubectl for Kubernetes v{{$.Env.KUBE_VERSION}}
      echo "Installing kubeadm, kubelet, and kubectl v{{$.Env.KUBE_VERSION}}..."
      apt-get update
      apt-get install -y apt-transport-https ca-certificates curl gpg

      curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{$.Env.KUBE_VERSION}}/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{$.Env.KUBE_VERSION}}/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list

      apt-get update
      apt-get install -y kubelet kubeadm kubectl
      apt-mark hold kubelet kubeadm kubectl

      # Enable kubelet
      systemctl enable kubelet

      echo "Kubeadm installation completed"
      
      echo "=== Linux VM setup completed successfully ==="
      '
---
apiVersion: network.azure.com/v1api20240301
kind: NetworkInterface
metadata:
  name: {{$nicName}}
  namespace: winfv
spec:
  location: {{$.Env.AZURE_LOCATION}}
  owner:
    name: {{$.Env.AZURE_RESOURCE_GROUP}}
  networkSecurityGroup:
    reference:
      group: network.azure.com
      kind: NetworkSecurityGroup
      name: winfv-sg
  ipConfigurations:
    - name: ipconfig-linux-{{$nodeNum}}
      subnet:
        reference:
          group: network.azure.com
          kind: VirtualNetworksSubnet
          name: subnet-winfv
      publicIPAddress:
        reference:
          group: network.azure.com
          kind: PublicIPAddress
          name: {{$pipName}}
---
apiVersion: network.azure.com/v1api20240301
kind: PublicIPAddress
metadata:
  name: {{$pipName}}
  namespace: winfv
spec:
  location: {{$.Env.AZURE_LOCATION}}
  owner:
    name: {{$.Env.AZURE_RESOURCE_GROUP}}
  publicIPAllocationMethod: Static
  sku:
    name: Standard
{{- end}}
