version: v1.0
name: Rerun failed jobs
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204

execution_time_limit:
  minutes: 10

global_job_config:
  secrets:
    - name: semaphore-api

blocks:
  - name: Rerun failed jobs
    dependencies: []
    task:
      jobs:
        - name: Rerun failed jobs
          commands:
            - curl https://storage.googleapis.com/sem-cli-releases/get.sh | bash
            - sudo sem connect ${SEMAPHORE_ORGANIZATION_URL#"https://"} $SEMAPHORE_API_TOKEN
            - export PIPELINE=$(sudo sem get workflows $SEMAPHORE_WORKFLOW_ID -i $SEMAPHORE_PROJECT_ID | tail -n 1 | awk '{print $1}')
            - sudo sem rebuild pipeline $PIPELINE
