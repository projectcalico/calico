# !! WARNING, DO NOT EDIT !! This file is generated from the templates
# in /.semaphore/semaphore.yml.d. To update, modify the relevant
# template and then run 'make gen-semaphore-yaml'.
version: v1.0
name: Calico
execution_time_limit:
  hours: 4
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
auto_cancel:
  running:
    when: "branch != 'master'"
  queued:
    when: "branch != 'master'"
global_job_config:
  secrets:
    - name: docker-hub
    - name: google-service-account-for-gce
  env_vars:
    - name: GOOGLE_PROJECT
      value: unique-caldron-775
    - name: GCS_BUILD_CACHE_BUCKET
      value: calico-transient-build-artifacts-europe-west3
    - name: BUILDKIT_PROGRESS
      value: plain
  prologue:
    commands:
      - export CALICO_DIR_NAME=${SEMAPHORE_GIT_DIR}
      - export GCS_CACHE_DIR=gs://$GCS_BUILD_CACHE_BUCKET/cache/${CALICO_DIR_NAME}
      - export GCS_WORKFLOW_DIR=gs://$GCS_BUILD_CACHE_BUCKET/workflow/${SEMAPHORE_WORKFLOW_ID}
      - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
      - |-
        if [[ $(uname -m) != "x86_64" || -n "$ARCH" ]]; then
          echo "Non-x86_64 build: $(uname -m) / $ARCH";
          export BUILD_CACHE_GROUP=$BUILD_CACHE_GROUP-$(uname -m)-$ARCH;
        fi
      - gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS" || true
      - gcloud config set project ${GOOGLE_PROJECT} || true
      # Try to restore the working copy from the cache, if available. Then,
      # for PRs, also try to restore the build cache.  (We skip this on branch
      # builds to ensure branches build cleanly.)
      - sudo apt-get install -y zstd || true
      - restored_wc_cache=false
      - |-
        if [[ -n "${SEMAPHORE_GIT_BRANCH}" && -z "$SKIP_CACHE_RESTORE" ]]; then
          echo "Looking for cached working copy for branch ${SEMAPHORE_GIT_BRANCH}"
          gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
          if gcloud storage cp "$gcs_branch_cache_dir/working-copy.tar.zstd" /tmp/working-copy.tar.zstd; then
            echo "Restoring cache for branch ${SEMAPHORE_GIT_BRANCH}"
            tar --use-compress-program=zstd -xf /tmp/working-copy.tar.zstd & tar_pid=$!
            downloaded_build_cache=false
            if [[ -n "$BUILD_CACHE_GROUP" && -n "${SEMAPHORE_GIT_PR_NUMBER}" ]]; then
              if gcloud storage cp "$gcs_branch_cache_dir/build-cache-${BUILD_CACHE_GROUP}.tar.zstd" /tmp/build-cache.tar.zstd; then
                echo "Found build cache for group ${BUILD_CACHE_GROUP}"
                downloaded_build_cache=true
              fi
            fi
            if wait $tar_pid; then
              restored_wc_cache=true
            else
              echo "ERROR: Failed to extract working copy"
              restored_wc_cache=false
            fi
            if ${downloaded_build_cache}; then
              echo "Extracting build cache"
              tar --use-compress-program=zstd -xf /tmp/build-cache.tar.zstd -C .
              rm /tmp/build-cache.tar.zstd
            fi
            cd "${CALICO_DIR_NAME}"
          fi
        fi || true
      - |-
        if [[ ${restored_wc_cache} != true && -z "$SKIP_CHECKOUT" ]]; then
          echo "No cache restored, doing a fresh checkout..."
          cd $HOME
          rm -rf "${CALICO_DIR_NAME}"
          git clone --filter=blob:none $SEMAPHORE_GIT_URL $CALICO_DIR_NAME
          cd "${CALICO_DIR_NAME}" || exit 1
        fi
      - |-
        if [[ -z "$SKIP_CHECKOUT" ]]; then
          git fetch origin --tags --prune-tags ${SEMAPHORE_GIT_SHA}
          if [ "$SEMAPHORE_GIT_REF_TYPE" = "branch" ]; then
            git checkout ${SEMAPHORE_GIT_SHA} -B "${SEMAPHORE_GIT_BRANCH}"
          else
            git checkout ${SEMAPHORE_GIT_SHA}
          fi
          CALICO_DIR="$(pwd)"
          export CALICO_DIR
          mkdir -p artifacts
        fi
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  epilogue:
    commands:
      - cd $HOME
      - |-
        if [[ -z "${SEMAPHORE_GIT_PR_NUMBER}" && -n "$BUILD_CACHE_GROUP" && "$STORE_BUILD_CACHE" = "true" ]]; then
          echo "On branch, storing build cache group ${BUILD_CACHE_GROUP}"
          tar --use-compress-program="zstd -3" -cf /tmp/build-cache.tar.zstd go ${CALICO_DIR_NAME}/.go-pkg-cache
          gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
          gcloud storage cp /tmp/build-cache.tar.zstd "$gcs_branch_cache_dir/build-cache-${BUILD_CACHE_GROUP}.tar.zstd"
        fi
      - cd "$CALICO_DIR"
      - .semaphore/publish-artifacts
promotions:
  # Manual promotion for publishing a hashrelease.
  - name: Publish hashrelease
    pipeline_file: release/hashrelease.yml
    parameters:
      env_vars:
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "Build container images. If 'true', container images will be built as part of the hashrelease process."
          name: BUILD_CONTAINER_IMAGES
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "create tarball of images. If 'true', a tarball of images will be added to the release.tgz. Requires BUILD_CONTAINER_IMAGES to also be 'true'."
          name: ARCHIVE_IMAGES
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "publish images. If 'true', images will be pushed to the container registry/registries as part of the hashrelease process. Requires BUILD_CONTAINER_IMAGES to also be 'true'."
          name: PUBLISH_IMAGES
  # Manual promotion for publishing a release.
  - name: Publish official release
    pipeline_file: release/release.yml
  # Cleanup after ourselves if we are stopped-short.
  - name: Cleanup
    pipeline_file: cleanup.yml
    auto_promote:
      when: "result = 'stopped'"
  # Have separate promotions for publishing images so we can re-run
  # them individually if they fail, and so we can run them in parallel.
  - name: Push apiserver images
    pipeline_file: push-images/apiserver.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push ALP images
    pipeline_file: push-images/alp.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push calicoctl images
    pipeline_file: push-images/calicoctl.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push calico-node images
    pipeline_file: push-images/node.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push mock calico-node images
    pipeline_file: push-images/mock-node.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push cni-plugin images
    pipeline_file: push-images/cni-plugin.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push istio images
    pipeline_file: push-images/istio.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push key-cert-provisioner images
    pipeline_file: push-images/key-cert-provisioner.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push kube-controllers images
    pipeline_file: push-images/kube-controllers.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push pod2daemon images
    pipeline_file: push-images/pod2daemon.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push typha images
    pipeline_file: push-images/typha.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Goldmane images
    pipeline_file: push-images/goldmane.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Whisker images
    pipeline_file: push-images/whisker.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Whisker Backend images
    pipeline_file: push-images/whisker-backend.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Guardian images
    pipeline_file: push-images/guardian.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Envoy images
    pipeline_file: push-images/envoy.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Publish openstack packages
    pipeline_file: push-images/packaging.yaml
    auto_promote:
      when: "branch =~ 'master'"
  - name: Push third-party istio-ztunnel images
    pipeline_file: push-images/third_party/istio-ztunnel.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Run Fossa scans
    pipeline_file: license-scanning/fossa-scan.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push E2E images
    pipeline_file: push-images/e2e-test.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
blocks:
  - name: Check images availability
    run:
      when: "true or (branch !~ 'build-v.*' and change_in(['/charts/', '/manifests/'], {pipeline_file: 'ignore'}))"
    dependencies: []
    task:
      jobs:
        - name: Check images availability
          commands:
            - make check-images-availability
  - name: Check SemaphoreCI files
    run:
      when: >-
        true or
        change_in(['/.semaphore', '/hack', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'track'})
    dependencies: []
    task:
      jobs:
        - name: Check semaphore files
          commands:
            - make gen-semaphore-yaml
            - make check-dirty
  - name: Check YAML files
    run:
      when: >-
        true or
        change_in(['/**/*.yml', '/**/*.yaml', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'track'})
    dependencies: []
    task:
      jobs:
        - name: Check YAML files
          commands:
            - make yaml-lint
  - name: Check Go
    run:
      when: >-
        true or
        change_in(['/go.mod', '/go.sum', '/**/*.go', '/**/deps.txt', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "preflight-go-checks"
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      jobs:
        - name: Check Go files
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
          commands:
            - make check-go-mod
            - make verify-go-mods
            - make gen-deps-files
            - make go-vet
            - >-
              if [ -n "$SEMAPHORE_GIT_PR_NUMBER" ]; then
                make fix-changed
              else
                make fix-all
              fi
            - make check-dirty
  - name: Check Python
    run:
      when: >-
        true or
        change_in(['/networking-calico', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check Python files
          commands:
            - make -C networking-calico fmtpy
            - make -C networking-calico flake8
            - make check-dirty
  - name: Check language/Dockerfiles
    run:
      when: >-
        true or
        change_in(['/**/*'], {pipeline_file: 'track', exclude: ['libbpf', '.[a-z]*']})
    dependencies: []
    task:
      jobs:
        - name: Check language/Dockerfiles
          commands:
            # Both of these are very quick grep checks so we combine them into one job.
            - make check-language
            - make check-dockerfiles
  - name: Check protobufs
    run:
      when: >-
        true or
        change_in(['/**/*.pb.go', '/**/*.proto', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check protobufs
          commands:
            - make protobuf fix-changed
            - make check-dirty
  - name: Manifests and API docs
    run:
      when: >-
        true or
        change_in(['/api', '/manifests', '/charts', '/libcalico-go/lib/apis', '/libcalico-go/config', '/libcalico-go/Makefile', '/felix/config', '/felix/docs', '/felix/Makefile', '/goldmane', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check manifests and API docs
          commands:
            - make -C lib gen-files
            - make -C api gen-files
            - make -C libcalico-go gen-files
            - make -C felix gen-files
            - make -C goldmane gen-files
            - make gen-manifests
            - make fix-changed
            - make check-ocp-no-crds
            - make check-dirty
  - name: Store working copy
    run:
      when: "branch =~ '.*'"
    dependencies: []
    task:
      env_vars:
        - name: SKIP_CACHE_RESTORE
          value: "true"
      jobs:
        - name: Save working copy to cache
          commands:
            - cd ..
            - tar --use-compress-program="zstd -3" -cf /tmp/working-copy.tar.zstd $CALICO_DIR_NAME
            - gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
            - gcloud storage cp /tmp/working-copy.tar.zstd "$gcs_branch_cache_dir/working-copy.tar.zstd"
  - name: Prerequisites
    skip:
      # Always skip, this is a dummy job used to group prerequisite checks.
      when: "true"
    dependencies:
      - Check SemaphoreCI files
      - Check YAML files
      - Check Go
      - Check Python
      - Check language/Dockerfiles
      - Check protobufs
      - Manifests and API docs
      - Store working copy
    task:
      jobs:
        - name: Pre-flight checks
          commands:
            - "true"
  - name: Publish tigera/istio-ztunnel images
    run:
      when: "change_in(['/third_party/istio-ztunnel'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE'], pipeline_file: 'ignore'})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: DEV_REGISTRIES
          value: docker.io/calico
      prologue:
        commands:
          - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      jobs:
        - name: Linux amd64
          commands:
            - make -C third_party/istio-ztunnel ci ARCHES=amd64
            - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make -C third_party/istio-ztunnel cd ARCHES=amd64 CONFIRM=true; fi
  - name: Publish tigera/istio-ztunnel images - native arm64 runner
    run:
      when: "change_in(['/third_party/istio-ztunnel'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE'], pipeline_file: 'ignore'})"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: s1-aws-arm64-2
      env_vars:
        - name: DEV_REGISTRIES
          value: docker.io/calico
      prologue:
        commands:
          - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      jobs:
        - name: Linux arm64
          commands:
            - make -C third_party/istio-ztunnel ci ARCHES=arm64
            - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make -C third_party/istio-ztunnel cd ARCHES=arm64 CONFIRM=true; fi
  - name: Publish tigera/istio-ztunnel multi-arch manifests
    run:
      when: "change_in(['/third_party/istio-ztunnel'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE'], pipeline_file: 'ignore'})"
    dependencies:
      - Publish tigera/istio-ztunnel images
      - Publish tigera/istio-ztunnel images - native arm64 runner
    task:
      env_vars:
        - name: DEV_REGISTRIES
          value: docker.io/calico
      prologue:
        commands:
          - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      jobs:
        - name: Linux multi-arch manifests
          commands:
            - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make -C third_party/istio-ztunnel push-manifest CONFIRM=true; fi
  - name: Istio
    run:
      when: "true"
    dependencies:
      - Publish tigera/istio-ztunnel multi-arch manifests
    task:
      prologue:
        commands:
          - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
          - cd istio
      jobs:
        - name: "Istio: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
        - name: "Istio: build arm64"
          matrix:
            - env_var: ARCH
              values:
                - arm64
          commands:
            - ../.semaphore/run-and-monitor build-$ARCH.log make build ARCH=$ARCH
  - name: Release tooling
    run:
      when: "true"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd release
      jobs:
        - name: "Release tooling: CI"
          commands:
            - ../.semaphore/run-and-monitor release-ci.log make ci
            - 'test-results publish --name "Release tool: UT" ./report/*.xml || true'
        - name: "Release tooling: build"
          commands:
            - ../.semaphore/run-and-monitor release-build.log make build
            - cache store release-${SEMAPHORE_GIT_SHA} bin
after_pipeline:
  task:
    jobs:
      - name: Reports
        commands:
          - test-results gen-pipeline-report --force
