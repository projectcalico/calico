#!/bin/bash

set -e

job_tag="$1"

my_dir="$(dirname $0)"
repo_dir="$my_dir/../.."
artifacts_dir="${repo_dir}/artifacts"

echo "Publishing any reports from the artifacts directory."

cd "$artifacts_dir"

# Combine the reports
n=0
tmp_dir=$(mktemp -d -t ci-XXXXXXXXXX)
while IFS= read -r -d '' xml_file
do
  echo "Compiling $xml_file"
  test-results compile "$xml_file" "$tmp_dir/$n.json"
  (( n++ ))
done < <(find . -name '*.xml' -print0)

echo "Combining..."
test-results combine "$tmp_dir/"*.json "$tmp_dir/combined.json"
echo "Publishing..."
test-results publish "$tmp_dir/combined.json" --name "UT/FV felix $job_tag"
echo "Done"
