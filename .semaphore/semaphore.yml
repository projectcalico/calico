# !! WARNING, DO NOT EDIT !! This file is generated from semaphore.yml.tpl.
# To update, modify the template and then run 'make gen-semaphore-yaml'.
version: v1.0
name: Calico
execution_time_limit:
  hours: 4
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
auto_cancel:
  running:
    when: "branch != 'master'"
  queued:
    when: "branch != 'master'"
global_job_config:
  secrets:
    - name: docker-hub
  prologue:
    commands:
      - checkout
      - export REPO_DIR="$(pwd)"
      - mkdir artifacts
      # Semaphore is doing shallow clone on a commit without tags.
      # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always)
      - if [[ "${SEMAPHORE_BLOCK_NAME}" != "Prerequisites" ]]; then retry git fetch --unshallow; fi
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  epilogue:
    commands:
      - cd "$REPO_DIR"
      - .semaphore/publish-artifacts
promotions:
  # Manual promotion for publishing a hashrelease.
  - name: Publish hashrelease
    pipeline_file: release/hashrelease.yml
  # Manual promotion for publishing a release.
  - name: Publish official release
    pipeline_file: release/release.yml
  # Cleanup after ourselves if we are stopped-short.
  - name: Cleanup
    pipeline_file: cleanup.yml
    auto_promote:
      when: "result = 'stopped'"
  # Have separate promotions for publishing images so we can re-run
  # them individually if they fail, and so we can run them in parallel.
  - name: Push apiserver images
    pipeline_file: push-images/apiserver.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push ALP images
    pipeline_file: push-images/alp.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push calicoctl images
    pipeline_file: push-images/calicoctl.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push calico-node images
    pipeline_file: push-images/node.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push mock calico-node images
    pipeline_file: push-images/mock-node.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push cni-plugin images
    pipeline_file: push-images/cni-plugin.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push key-cert-provisioner images
    pipeline_file: push-images/key-cert-provisioner.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push kube-controllers images
    pipeline_file: push-images/kube-controllers.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push pod2daemon images
    pipeline_file: push-images/pod2daemon.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push typha images
    pipeline_file: push-images/typha.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push Goldmane images
    pipeline_file: push-images/goldmane.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push Whisker images
    pipeline_file: push-images/whisker.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push Whisker Backend images
    pipeline_file: push-images/whisker-backend.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push Guardian images
    pipeline_file: push-images/guardian.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push Envoy images
    pipeline_file: push-images/envoy.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Publish openstack packages
    pipeline_file: push-images/packaging.yaml
    auto_promote:
      when: "branch =~ 'master'"
  - name: Run Fossa scans
    pipeline_file: license-scanning/fossa-scan.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
blocks:
  - name: Check images availability
    run:
      when: "false or change_in(['/charts/', '/manifests/'])"
    dependencies: []
    task:
      jobs:
        - name: Check images availability
          commands:
            - make check-images-availability
  - name: Prerequisites
    dependencies: []
    task:
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      jobs:
        - name: Pre-flight checks
          commands:
            - make ci-preflight-checks
  - name: API
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/api/'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd api
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: apiserver
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/client/clientset_generated/clientset/*.go','api/pkg/client/clientset_generated/clientset/scheme/*.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','api/pkg/openapi/*.go','apiserver','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/client/clientset_generated/clientset/*_test.go','api/pkg/client/clientset_generated/clientset/scheme/*_test.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','api/pkg/openapi/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd apiserver
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: app-policy
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy','crypto/pkg/tls/*.go','felix/bpf/tc/defs/*.go','felix/calc/*.go','felix/config/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/nftables/*.go','felix/proto/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/stringutils/*.go','felix/types/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/bpf/tc/defs/*_test.go','felix/calc/*_test.go','felix/config/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/nftables/*_test.go','felix/proto/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/stringutils/*_test.go','felix/types/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd app-policy
      jobs:
        - name: app-policy tests
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: calicoctl
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','calicoctl','crypto/pkg/tls/*.go','felix/proto/*.go','kube-controllers/pkg/config/*.go','kube-controllers/pkg/controllers/loadbalancer/*.go','kube-controllers/pkg/controllers/utils/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','kube-controllers/pkg/config/*_test.go','kube-controllers/pkg/controllers/loadbalancer/*_test.go','kube-controllers/pkg/controllers/utils/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd calicoctl
      jobs:
        - name: calicoctl tests
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: cni-plugin
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','cni-plugin','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/cni/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/cni/*_test.go','pkg/buildinfo/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd cni-plugin
      jobs:
        - name: cni-plugin tests
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
        - name: build windows cni-plugin images
          commands:
            - ../.semaphore/run-and-monitor ci.log make image-windows
  - name: "cni-plugin: Windows"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','cni-plugin','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/cni/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/cni/*_test.go','pkg/buildinfo/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      secrets:
        - name: banzai-secrets
      prologue:
        commands:
          # Prepare azure configuration.
          - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
          - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
          - export AZURE_TENANT_ID=$AZ_TENANT_ID
          - export AZURE_CLIENT_ID=$AZ_SP_ID
          - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
          - export REPORT_DIR=/home/semaphore/calico/process/testing/winfv-cni-plugin/report
          - export LOGS_DIR=~/fv.log
          - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
          - export CLUSTER_NAME=sem-${SEMAPHORE_PROJECT_NAME}-pr${SEMAPHORE_GIT_PR_NUMBER}-${SHORT_WORKFLOW_ID}
          - export SUFFIX=${CLUSTER_NAME}
          - cd cni-plugin
          - ../.semaphore/run-and-monitor build.log make bin/windows/calico.exe bin/windows/calico-ipam.exe bin/windows/win-fv.exe
      epilogue:
        always:
          commands:
            - artifact push job ${REPORT_DIR} --destination semaphore/test-results || true
            - artifact push job ${LOGS_DIR} --destination semaphore/logs || true
            - cd ~/calico/process/testing/winfv-cni-plugin/aso && make dist-clean
      env_vars:
        - name: SEMAPHORE_ARTIFACT_EXPIRY
          value: 2w
        - name: AZURE_LOCATION
          value: eastus2
        - name: KUBE_VERSION
          value: v1.29.7
      jobs:
        - name: Containerd - Windows FV - overlay
          execution_time_limit:
            minutes: 60
          commands:
            - export BACKEND=overlay
            - export AZURE_RESOURCE_GROUP=${USER}-capz-win-cni-${SEMAPHORE_WORKFLOW_ID:0:8}-${BACKEND}-rg
            - ../.semaphore/run-and-monitor win-fv-containerd.log ./.semaphore/run-win-fv.sh
        - name: Containerd - Windows FV - l2bridge
          execution_time_limit:
            minutes: 60
          commands:
            - export BACKEND=l2bridge
            - export AZURE_RESOURCE_GROUP=${USER}-capz-win-cni-${SEMAPHORE_WORKFLOW_ID:0:8}-${BACKEND}-rg
            - ../.semaphore/run-and-monitor win-fv-containerd.log ./.semaphore/run-win-fv.sh
  - name: confd
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','confd','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','pkg/buildinfo/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd confd
      jobs:
        - name: "confd: CI"
          execution_time_limit:
            minutes: 60
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: crypto
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','crypto'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd crypto
      jobs:
        - name: "crypto tests"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: e2e script & pipeline validations
    run:
      when: "false or change_in(['/.semaphore/end-to-end/'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 5
    dependencies:
      - Prerequisites
    task:
      jobs:
        - name: Test Pipeline files are valid yaml
          commands:
            - ./.semaphore/end-to-end/scripts/test_scripts/e2e-validation.sh
  - name: e2e tests
    run:
      when: "change_in(['/confd/etc','/felix/bpf-apache','/felix/bpf-gpl','/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/client/clientset_generated/clientset/*.go','api/pkg/client/clientset_generated/clientset/scheme/*.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','api/pkg/openapi/*.go','apiserver/Makefile','apiserver/cmd/apiserver/*.go','apiserver/cmd/apiserver/server/*.go','apiserver/deps.txt','apiserver/pkg/apiserver/*.go','apiserver/pkg/printers/projectcalico/*.go','apiserver/pkg/rbac/*.go','apiserver/pkg/rbac/mock/*.go','apiserver/pkg/registry/projectcalico/authorizer/*.go','apiserver/pkg/registry/projectcalico/bgpconfiguration/*.go','apiserver/pkg/registry/projectcalico/bgpfilter/*.go','apiserver/pkg/registry/projectcalico/bgppeer/*.go','apiserver/pkg/registry/projectcalico/blockaffinity/*.go','apiserver/pkg/registry/projectcalico/caliconodestatus/*.go','apiserver/pkg/registry/projectcalico/clusterinformation/*.go','apiserver/pkg/registry/projectcalico/felixconfig/*.go','apiserver/pkg/registry/projectcalico/globalnetworkset/*.go','apiserver/pkg/registry/projectcalico/globalpolicy/*.go','apiserver/pkg/registry/projectcalico/hostendpoint/*.go','apiserver/pkg/registry/projectcalico/ipamconfig/*.go','apiserver/pkg/registry/projectcalico/ippool/*.go','apiserver/pkg/registry/projectcalico/ipreservation/*.go','apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*.go','apiserver/pkg/registry/projectcalico/networkpolicy/*.go','apiserver/pkg/registry/projectcalico/networkset/*.go','apiserver/pkg/registry/projectcalico/profile/*.go','apiserver/pkg/registry/projectcalico/rest/*.go','apiserver/pkg/registry/projectcalico/server/*.go','apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/tier/*.go','apiserver/pkg/registry/projectcalico/util/*.go','apiserver/pkg/storage/calico/*.go','apiserver/pkg/storage/etcd/*.go','apiserver/test/integration/*.go','apiserver/test/util/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','calicoctl/Makefile','calicoctl/calicoctl/*.go','calicoctl/calicoctl/commands/*.go','calicoctl/calicoctl/commands/argutils/*.go','calicoctl/calicoctl/commands/clientmgr/*.go','calicoctl/calicoctl/commands/cluster/*.go','calicoctl/calicoctl/commands/common/*.go','calicoctl/calicoctl/commands/constants/*.go','calicoctl/calicoctl/commands/datastore/*.go','calicoctl/calicoctl/commands/datastore/migrate/*.go','calicoctl/calicoctl/commands/file/*.go','calicoctl/calicoctl/commands/ipam/*.go','calicoctl/calicoctl/commands/node/*.go','calicoctl/calicoctl/commands/resourceloader/*.go','calicoctl/calicoctl/resourcemgr/*.go','calicoctl/calicoctl/util/*.go','calicoctl/calicoctl/util/yaml/*.go','calicoctl/deps.txt','calicoctl/tests/fv/*.go','calicoctl/tests/fv/helper/*.go','calicoctl/tests/fv/utils/*.go','cni-plugin/Makefile','cni-plugin/cmd/calico/*.go','cni-plugin/cmd/install/*.go','cni-plugin/deps.txt','cni-plugin/internal/pkg/azure/*.go','cni-plugin/internal/pkg/testutils/*.go','cni-plugin/internal/pkg/utils/*.go','cni-plugin/internal/pkg/utils/cri/*.go','cni-plugin/internal/pkg/utils/hcn/*.go','cni-plugin/internal/pkg/utils/winpol/*.go','cni-plugin/pkg/dataplane/*.go','cni-plugin/pkg/dataplane/grpc/*.go','cni-plugin/pkg/dataplane/grpc/proto/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/install/*.go','cni-plugin/pkg/ipamplugin/*.go','cni-plugin/pkg/k8s/*.go','cni-plugin/pkg/plugin/*.go','cni-plugin/pkg/types/*.go','cni-plugin/pkg/upgrade/*.go','cni-plugin/pkg/wait/*.go','cni-plugin/tests/*.go','cni-plugin/win_tests/*.go','confd/pkg/backends/*.go','confd/pkg/backends/calico/*.go','confd/pkg/config/*.go','confd/pkg/log/*.go','confd/pkg/resource/template/*.go','confd/pkg/run/*.go','crypto/pkg/tls/*.go','e2e','felix/aws/*.go','felix/bpf/*.go','felix/bpf/arp/*.go','felix/bpf/asm/*.go','felix/bpf/bpfdefs/*.go','felix/bpf/bpfmap/*.go','felix/bpf/conntrack/*.go','felix/bpf/conntrack/cleanupv1/*.go','felix/bpf/conntrack/timeouts/*.go','felix/bpf/conntrack/v2/*.go','felix/bpf/conntrack/v3/*.go','felix/bpf/conntrack/v4/*.go','felix/bpf/counters/*.go','felix/bpf/events/*.go','felix/bpf/failsafes/*.go','felix/bpf/filter/*.go','felix/bpf/hook/*.go','felix/bpf/ifstate/*.go','felix/bpf/ipsets/*.go','felix/bpf/jump/*.go','felix/bpf/legacy/*.go','felix/bpf/libbpf/*.go','felix/bpf/maps/*.go','felix/bpf/nat/*.go','felix/bpf/perf/*.go','felix/bpf/polprog/*.go','felix/bpf/profiling/*.go','felix/bpf/proxy/*.go','felix/bpf/qos/*.go','felix/bpf/routes/*.go','felix/bpf/state/*.go','felix/bpf/tc/*.go','felix/bpf/tc/defs/*.go','felix/bpf/utils/*.go','felix/bpf/xdp/*.go','felix/cachingmap/*.go','felix/calc/*.go','felix/cmd/calico-bpf/commands/*.go','felix/collector/*.go','felix/collector/flowlog/*.go','felix/collector/goldmane/*.go','felix/collector/local/*.go','felix/collector/types/*.go','felix/collector/types/counter/*.go','felix/collector/types/endpoint/*.go','felix/collector/types/metric/*.go','felix/collector/types/tuple/*.go','felix/collector/utils/*.go','felix/config/*.go','felix/conntrack/*.go','felix/daemon/*.go','felix/dataplane/*.go','felix/dataplane/common/*.go','felix/dataplane/external/*.go','felix/dataplane/inactive/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/dataplane/linux/qos/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/ethtool/*.go','felix/fv/connectivity/*.go','felix/fv/containers/*.go','felix/fv/tcpdump/*.go','felix/fv/utils/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ifacemonitor/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/jitter/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/linkaddrs/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/netlinkshim/handlemgr/*.go','felix/nfnetlink/*.go','felix/nfnetlink/nfnl/*.go','felix/nfnetlink/pkt/*.go','felix/nftables/*.go','felix/policysync/*.go','felix/proto/*.go','felix/routerule/*.go','felix/routetable/*.go','felix/routetable/ownershippol/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/statusrep/*.go','felix/stringutils/*.go','felix/throttle/*.go','felix/timeshim/*.go','felix/types/*.go','felix/usagerep/*.go','felix/vxlanfdb/*.go','felix/wireguard/*.go','goldmane/Makefile','goldmane/cmd/*.go','goldmane/cmd/flowgen/*.go','goldmane/cmd/health/*.go','goldmane/cmd/stream/*.go','goldmane/deps.txt','goldmane/fv/*.go','goldmane/pkg/client/*.go','goldmane/pkg/client/mocks/*.go','goldmane/pkg/daemon/*.go','goldmane/pkg/emitter/*.go','goldmane/pkg/flowgen/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/internal/utils/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/testutils/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','goldmane/proto/mocks/*.go','kube-controllers/Makefile','kube-controllers/cmd/check-status/*.go','kube-controllers/cmd/kube-controllers/*.go','kube-controllers/cmd/wrapper/*.go','kube-controllers/deps.txt','kube-controllers/pkg/cache/*.go','kube-controllers/pkg/config/*.go','kube-controllers/pkg/controllers/controller/*.go','kube-controllers/pkg/controllers/flannelmigration/*.go','kube-controllers/pkg/controllers/loadbalancer/*.go','kube-controllers/pkg/controllers/namespace/*.go','kube-controllers/pkg/controllers/networkpolicy/*.go','kube-controllers/pkg/controllers/node/*.go','kube-controllers/pkg/controllers/pod/*.go','kube-controllers/pkg/controllers/serviceaccount/*.go','kube-controllers/pkg/controllers/utils/*.go','kube-controllers/pkg/converter/*.go','kube-controllers/pkg/status/*.go','kube-controllers/tests/testutils/*.go','lib/httpmachinery/pkg/apiutil/*.go','lib/httpmachinery/pkg/codec/*.go','lib/httpmachinery/pkg/context/*.go','lib/httpmachinery/pkg/header/*.go','lib/httpmachinery/pkg/server/*.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','lib/std/chanutil/*.go','lib/std/cryptoutils/*.go','lib/std/testutils/json/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node/Makefile','node/cmd/calico-ipam/*.go','node/cmd/calico-node/*.go','node/cmd/calico-node/bpf/*.go','node/cmd/calico/*.go','node/cmd/mountns/*.go','node/deps.txt','node/pkg/allocateip/*.go','node/pkg/calicoclient/*.go','node/pkg/cni/*.go','node/pkg/flowlogs/*.go','node/pkg/health/*.go','node/pkg/health/bird/*.go','node/pkg/hostpathinit/*.go','node/pkg/lifecycle/shutdown/*.go','node/pkg/lifecycle/startup/*.go','node/pkg/lifecycle/startup/autodetection/*.go','node/pkg/lifecycle/startup/autodetection/ipv4/*.go','node/pkg/lifecycle/utils/*.go','node/pkg/nodeinit/*.go','node/pkg/status/*.go','node/pkg/status/populators/*.go','node/windows-packaging/tests/*.go','pkg/buildinfo/*.go','pkg/cmdwrapper/*.go','pod2daemon/Makefile','pod2daemon/binder/*.go','pod2daemon/csidriver/*.go','pod2daemon/csidriver/driver/*.go','pod2daemon/deps.txt','pod2daemon/flexvol/*.go','pod2daemon/flexvol/creds/*.go','pod2daemon/nodeagent/*.go','pod2daemon/proto/*.go','pod2daemon/workloadapi/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go','whisker-backend/Makefile','whisker-backend/cmd/*.go','whisker-backend/cmd/app/*.go','whisker-backend/deps.txt','whisker-backend/pkg/apis/v1/*.go','whisker-backend/pkg/config/*.go','whisker-backend/pkg/handlers/v1/*.go','whisker-backend/test/fv/*.go','whisker/Makefile','whisker/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/client/clientset_generated/clientset/*_test.go','api/pkg/client/clientset_generated/clientset/scheme/*_test.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','api/pkg/openapi/*_test.go','apiserver/cmd/apiserver/*_test.go','apiserver/cmd/apiserver/server/*_test.go','apiserver/pkg/apiserver/*_test.go','apiserver/pkg/printers/projectcalico/*_test.go','apiserver/pkg/rbac/*_test.go','apiserver/pkg/rbac/mock/*_test.go','apiserver/pkg/registry/projectcalico/authorizer/*_test.go','apiserver/pkg/registry/projectcalico/bgpconfiguration/*_test.go','apiserver/pkg/registry/projectcalico/bgpfilter/*_test.go','apiserver/pkg/registry/projectcalico/bgppeer/*_test.go','apiserver/pkg/registry/projectcalico/blockaffinity/*_test.go','apiserver/pkg/registry/projectcalico/caliconodestatus/*_test.go','apiserver/pkg/registry/projectcalico/clusterinformation/*_test.go','apiserver/pkg/registry/projectcalico/felixconfig/*_test.go','apiserver/pkg/registry/projectcalico/globalnetworkset/*_test.go','apiserver/pkg/registry/projectcalico/globalpolicy/*_test.go','apiserver/pkg/registry/projectcalico/hostendpoint/*_test.go','apiserver/pkg/registry/projectcalico/ipamconfig/*_test.go','apiserver/pkg/registry/projectcalico/ippool/*_test.go','apiserver/pkg/registry/projectcalico/ipreservation/*_test.go','apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*_test.go','apiserver/pkg/registry/projectcalico/networkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/networkset/*_test.go','apiserver/pkg/registry/projectcalico/profile/*_test.go','apiserver/pkg/registry/projectcalico/rest/*_test.go','apiserver/pkg/registry/projectcalico/server/*_test.go','apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/tier/*_test.go','apiserver/pkg/registry/projectcalico/util/*_test.go','apiserver/pkg/storage/calico/*_test.go','apiserver/pkg/storage/etcd/*_test.go','apiserver/test/integration/*_test.go','apiserver/test/util/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','calicoctl/calicoctl/*_test.go','calicoctl/calicoctl/commands/*_test.go','calicoctl/calicoctl/commands/argutils/*_test.go','calicoctl/calicoctl/commands/clientmgr/*_test.go','calicoctl/calicoctl/commands/cluster/*_test.go','calicoctl/calicoctl/commands/common/*_test.go','calicoctl/calicoctl/commands/constants/*_test.go','calicoctl/calicoctl/commands/datastore/*_test.go','calicoctl/calicoctl/commands/datastore/migrate/*_test.go','calicoctl/calicoctl/commands/file/*_test.go','calicoctl/calicoctl/commands/ipam/*_test.go','calicoctl/calicoctl/commands/node/*_test.go','calicoctl/calicoctl/commands/resourceloader/*_test.go','calicoctl/calicoctl/resourcemgr/*_test.go','calicoctl/calicoctl/util/*_test.go','calicoctl/calicoctl/util/yaml/*_test.go','calicoctl/tests/fv/*_test.go','calicoctl/tests/fv/helper/*_test.go','calicoctl/tests/fv/utils/*_test.go','cni-plugin/cmd/calico/*_test.go','cni-plugin/cmd/install/*_test.go','cni-plugin/internal/pkg/azure/*_test.go','cni-plugin/internal/pkg/testutils/*_test.go','cni-plugin/internal/pkg/utils/*_test.go','cni-plugin/internal/pkg/utils/cri/*_test.go','cni-plugin/internal/pkg/utils/hcn/*_test.go','cni-plugin/internal/pkg/utils/winpol/*_test.go','cni-plugin/pkg/dataplane/*_test.go','cni-plugin/pkg/dataplane/grpc/*_test.go','cni-plugin/pkg/dataplane/grpc/proto/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/install/*_test.go','cni-plugin/pkg/ipamplugin/*_test.go','cni-plugin/pkg/k8s/*_test.go','cni-plugin/pkg/plugin/*_test.go','cni-plugin/pkg/types/*_test.go','cni-plugin/pkg/upgrade/*_test.go','cni-plugin/pkg/wait/*_test.go','cni-plugin/tests/*_test.go','cni-plugin/win_tests/*_test.go','confd/pkg/backends/*_test.go','confd/pkg/backends/calico/*_test.go','confd/pkg/config/*_test.go','confd/pkg/log/*_test.go','confd/pkg/resource/template/*_test.go','confd/pkg/run/*_test.go','crypto/pkg/tls/*_test.go','felix/aws/*_test.go','felix/bpf/*_test.go','felix/bpf/arp/*_test.go','felix/bpf/asm/*_test.go','felix/bpf/bpfdefs/*_test.go','felix/bpf/bpfmap/*_test.go','felix/bpf/conntrack/*_test.go','felix/bpf/conntrack/cleanupv1/*_test.go','felix/bpf/conntrack/timeouts/*_test.go','felix/bpf/conntrack/v2/*_test.go','felix/bpf/conntrack/v3/*_test.go','felix/bpf/conntrack/v4/*_test.go','felix/bpf/counters/*_test.go','felix/bpf/events/*_test.go','felix/bpf/failsafes/*_test.go','felix/bpf/filter/*_test.go','felix/bpf/hook/*_test.go','felix/bpf/ifstate/*_test.go','felix/bpf/ipsets/*_test.go','felix/bpf/jump/*_test.go','felix/bpf/legacy/*_test.go','felix/bpf/libbpf/*_test.go','felix/bpf/maps/*_test.go','felix/bpf/nat/*_test.go','felix/bpf/perf/*_test.go','felix/bpf/polprog/*_test.go','felix/bpf/profiling/*_test.go','felix/bpf/proxy/*_test.go','felix/bpf/qos/*_test.go','felix/bpf/routes/*_test.go','felix/bpf/state/*_test.go','felix/bpf/tc/*_test.go','felix/bpf/tc/defs/*_test.go','felix/bpf/utils/*_test.go','felix/bpf/xdp/*_test.go','felix/cachingmap/*_test.go','felix/calc/*_test.go','felix/cmd/calico-bpf/commands/*_test.go','felix/collector/*_test.go','felix/collector/flowlog/*_test.go','felix/collector/goldmane/*_test.go','felix/collector/local/*_test.go','felix/collector/types/*_test.go','felix/collector/types/counter/*_test.go','felix/collector/types/endpoint/*_test.go','felix/collector/types/metric/*_test.go','felix/collector/types/tuple/*_test.go','felix/collector/utils/*_test.go','felix/config/*_test.go','felix/conntrack/*_test.go','felix/daemon/*_test.go','felix/dataplane/*_test.go','felix/dataplane/common/*_test.go','felix/dataplane/external/*_test.go','felix/dataplane/inactive/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/dataplane/linux/qos/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/ethtool/*_test.go','felix/fv/connectivity/*_test.go','felix/fv/containers/*_test.go','felix/fv/tcpdump/*_test.go','felix/fv/utils/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ifacemonitor/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/jitter/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/linkaddrs/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/netlinkshim/handlemgr/*_test.go','felix/nfnetlink/*_test.go','felix/nfnetlink/nfnl/*_test.go','felix/nfnetlink/pkt/*_test.go','felix/nftables/*_test.go','felix/policysync/*_test.go','felix/proto/*_test.go','felix/routerule/*_test.go','felix/routetable/*_test.go','felix/routetable/ownershippol/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/statusrep/*_test.go','felix/stringutils/*_test.go','felix/throttle/*_test.go','felix/timeshim/*_test.go','felix/types/*_test.go','felix/usagerep/*_test.go','felix/vxlanfdb/*_test.go','felix/wireguard/*_test.go','goldmane/cmd/*_test.go','goldmane/cmd/flowgen/*_test.go','goldmane/cmd/health/*_test.go','goldmane/cmd/stream/*_test.go','goldmane/fv/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/client/mocks/*_test.go','goldmane/pkg/daemon/*_test.go','goldmane/pkg/emitter/*_test.go','goldmane/pkg/flowgen/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/internal/utils/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/testutils/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','goldmane/proto/mocks/*_test.go','kube-controllers/cmd/check-status/*_test.go','kube-controllers/cmd/kube-controllers/*_test.go','kube-controllers/cmd/wrapper/*_test.go','kube-controllers/pkg/cache/*_test.go','kube-controllers/pkg/config/*_test.go','kube-controllers/pkg/controllers/controller/*_test.go','kube-controllers/pkg/controllers/flannelmigration/*_test.go','kube-controllers/pkg/controllers/loadbalancer/*_test.go','kube-controllers/pkg/controllers/namespace/*_test.go','kube-controllers/pkg/controllers/networkpolicy/*_test.go','kube-controllers/pkg/controllers/node/*_test.go','kube-controllers/pkg/controllers/pod/*_test.go','kube-controllers/pkg/controllers/serviceaccount/*_test.go','kube-controllers/pkg/controllers/utils/*_test.go','kube-controllers/pkg/converter/*_test.go','kube-controllers/pkg/status/*_test.go','kube-controllers/tests/testutils/*_test.go','lib/httpmachinery/pkg/apiutil/*_test.go','lib/httpmachinery/pkg/codec/*_test.go','lib/httpmachinery/pkg/context/*_test.go','lib/httpmachinery/pkg/header/*_test.go','lib/httpmachinery/pkg/server/*_test.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*_test.go','lib/std/chanutil/*_test.go','lib/std/cryptoutils/*_test.go','lib/std/testutils/json/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','node/cmd/calico-ipam/*_test.go','node/cmd/calico-node/*_test.go','node/cmd/calico-node/bpf/*_test.go','node/cmd/calico/*_test.go','node/cmd/mountns/*_test.go','node/pkg/allocateip/*_test.go','node/pkg/calicoclient/*_test.go','node/pkg/cni/*_test.go','node/pkg/flowlogs/*_test.go','node/pkg/health/*_test.go','node/pkg/health/bird/*_test.go','node/pkg/hostpathinit/*_test.go','node/pkg/lifecycle/shutdown/*_test.go','node/pkg/lifecycle/startup/*_test.go','node/pkg/lifecycle/startup/autodetection/*_test.go','node/pkg/lifecycle/startup/autodetection/ipv4/*_test.go','node/pkg/lifecycle/utils/*_test.go','node/pkg/nodeinit/*_test.go','node/pkg/status/*_test.go','node/pkg/status/populators/*_test.go','node/windows-packaging/tests/*_test.go','pkg/buildinfo/*_test.go','pkg/cmdwrapper/*_test.go','pod2daemon/binder/*_test.go','pod2daemon/csidriver/*_test.go','pod2daemon/csidriver/driver/*_test.go','pod2daemon/flexvol/*_test.go','pod2daemon/flexvol/creds/*_test.go','pod2daemon/nodeagent/*_test.go','pod2daemon/proto/*_test.go','pod2daemon/workloadapi/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go','whisker-backend/cmd/*_test.go','whisker-backend/cmd/app/*_test.go','whisker-backend/pkg/apis/v1/*_test.go','whisker-backend/pkg/config/*_test.go','whisker-backend/pkg/handlers/v1/*_test.go','whisker-backend/test/fv/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2004
      jobs:
        - name: Conformance e2e tests
          commands:
            - .semaphore/run-and-monitor e2e-test.log make e2e-test
  - name: envoy-gateway
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-gateway'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-gateway
      jobs:
        - name: make ci
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: envoy-proxy
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-proxy'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-proxy
      jobs:
        - name: make ci
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: envoy-ratelimit
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-ratelimit'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-ratelimit
      jobs:
        - name: make ci
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: "Felix: Build"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','felix/proto/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd felix
          - cache restore go-pkg-cache
          - cache restore go-mod-cache
      jobs:
        - name: Build and run UT, k8sfv
          execution_time_limit:
            minutes: 60
          commands:
            - make build image fv-prereqs
            - "cache store bin-${SEMAPHORE_GIT_SHA} bin"
            - "cache store fv.test-${SEMAPHORE_GIT_SHA} fv/fv.test"
            - cache store go-pkg-cache .go-pkg-cache
            - "cache store go-mod-cache ${HOME}/go/pkg/mod/cache"
            - docker save -o /tmp/calico-felix-test.tar calico/felix-test:latest-amd64
            - "cache store felix-image-${SEMAPHORE_GIT_SHA} /tmp/calico-felix-test.tar"
            - docker save -o /tmp/felixtest-typha.tar felix-test/typha:latest-amd64
            - "cache store felixtest-typha-image-${SEMAPHORE_GIT_SHA} /tmp/felixtest-typha.tar"
            - ../.semaphore/run-and-monitor ut.log make ut
            - ../.semaphore/run-and-monitor k8sfv-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=true
            - ../.semaphore/run-and-monitor k8sfv-no-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=false
        - name: Static checks
          execution_time_limit:
            minutes: 60
          commands:
            - ../.semaphore/run-and-monitor static-checks.log make static-checks
  - name: "Felix: multi-arch build"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      prologue:
        commands:
          - cd felix
          - cache restore go-pkg-cache
          - cache restore go-mod-cache
      jobs:
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - ppc64le
                - s390x
          commands:
            # Only building the code, not the image here because the felix image is now only used for FV tests, which
            # only run on AMD64 at the moment.
            - ../.semaphore/run-and-monitor build-$ARCH.log make build ARCH=$ARCH
  - name: "Felix: Build - native arm64 runner"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      agent:
        machine:
          type: s1-aws-arm64-2
      prologue:
        commands:
          - cd felix
          - cache restore go-pkg-cache
          - cache restore go-mod-cache
      jobs:
        - name: Build binary
          commands:
            - ../.semaphore/run-and-monitor build-arm64.log make build ARCH=arm64
  - name: "Felix: Build Windows binaries"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      jobs:
        - name: Build Windows binaries
          commands:
            - cd felix
            - make bin/calico-felix.exe fv/win-fv.exe
  - name: "Felix: Windows FV capz"
    run:
      when: "false or change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies: ["Felix: Build Windows binaries"]
    task:
      secrets:
        - name: banzai-secrets
        - name: private-repo
      prologue:
        commands:
          - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
          - export REPORT_DIR=/home/semaphore/report
          - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
          - export AZURE_TENANT_ID=$AZ_TENANT_ID
          - export AZURE_CLIENT_ID=$AZ_SP_ID
          - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
          - export AZURE_SUBSCRIPTION_ID_B64="$(echo -n "$AZ_SUBSCRIPTION_ID" | base64 | tr -d '\n')"
          - export AZURE_TENANT_ID_B64="$(echo -n "$AZ_TENANT_ID" | base64 | tr -d '\n')"
          - export AZURE_CLIENT_ID_B64="$(echo -n "$AZ_SP_ID" | base64 | tr -d '\n')"
          - export AZURE_CLIENT_SECRET_B64="$(echo -n "$AZ_SP_PASSWORD" | base64 | tr -d '\n')"
          - cd felix
      epilogue:
        always:
          commands:
            - artifact push job ${REPORT_DIR} --destination test-results || true
      env_vars:
        - name: FV_PROVISIONER
          value: "capz"
        - name: FV_TYPE
          value: "calico-felix"
        - name: SEMAPHORE_ARTIFACT_EXPIRY
          value: 2w
        - name: CONTAINERD_VERSION
          value: 1.7.22
      jobs:
        - name: CAPZ - Windows FV
          commands:
            - ./.semaphore/run-win-fv
  - name: "Felix: FV Tests"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','felix/proto/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      prologue:
        commands:
          - cd felix
          - cache restore go-pkg-cache
          - cache restore go-mod-cache
          - "cache restore bin-${SEMAPHORE_GIT_SHA}"
          - "cache restore fv.test-${SEMAPHORE_GIT_SHA}"
          - "cache restore felix-image-${SEMAPHORE_GIT_SHA}"
          - "cache restore felixtest-typha-image-${SEMAPHORE_GIT_SHA}"
          - |-
            if [ -s /etc/docker/daemon.json  ]; then
            sudo sed -i '$d' /etc/docker/daemon.json && sudo sed -i '$s/$/,/' /etc/docker/daemon.json && sudo bash -c ' cat >> /etc/docker/daemon.json << EOF
              "ipv6": true,
              "fixed-cidr-v6": "2001:db8:1::/64"
            }
            EOF
            ' ; else sudo bash -c ' cat > /etc/docker/daemon.json << EOF
            {
              "ipv6": true,
              "fixed-cidr-v6": "2001:db8:1::/64"
            }
            EOF
            ' ; fi
          - sudo systemctl restart docker
          # Load in the docker images pre-built by the build job.
          - docker load -i /tmp/calico-felix-test.tar
          - docker tag calico/felix-test:latest-amd64 felix-test:latest-amd64
          - rm /tmp/calico-felix-test.tar
          - docker load -i /tmp/felixtest-typha.tar
          - docker tag felix-test/typha:latest-amd64 typha:latest-amd64
          - rm /tmp/felixtest-typha.tar
          # Pre-loading the IPIP module prevents a flake where the first felix to use IPIP loads the module and
          # routing in that first felix container chooses different source IPs than the tests are expecting.
          - sudo modprobe ipip
      jobs:
        - name: FV Test matrix
          execution_time_limit:
            minutes: 120
          commands:
            - make check-wireguard
            - ../.semaphore/run-and-monitor fv-${SEMAPHORE_JOB_INDEX}.log make fv-no-prereqs FV_BATCHES_TO_RUN="${SEMAPHORE_JOB_INDEX}" FV_NUM_BATCHES=${SEMAPHORE_JOB_COUNT}
          parallelism: 3
        - name: nftables FV Test matrix
          execution_time_limit:
            minutes: 120
          env_vars:
            - name: FELIX_FV_NFTABLES
              value: "Enabled"
          commands:
            - make check-wireguard
            - ../.semaphore/run-and-monitor fv-${SEMAPHORE_JOB_INDEX}.log make fv-no-prereqs FV_BATCHES_TO_RUN="${SEMAPHORE_JOB_INDEX}" FV_NUM_BATCHES=${SEMAPHORE_JOB_COUNT}
          parallelism: 3
      epilogue:
        always:
          commands:
            - ./.semaphore/collect-artifacts
            - ./.semaphore/publish-artifacts
            - test-results publish /home/semaphore/calico/felix/report/fv_suite.xml --name "felix-fv-${SEMAPHORE_JOB_INDEX}" || true
            - test-results publish /home/semaphore/calico/felix/report/fv_nft_suite.xml --name "felix-fv-nft-${SEMAPHORE_JOB_INDEX}" || true
  - name: "Felix: BPF UT/FV tests on Ubuntu 24.04"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','felix/proto/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd felix
          - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
          - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
          - export ZONE=europe-west3-c
          - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-felix-ipt-
          - echo VM_PREFIX=${VM_PREFIX}
          - export REPO_NAME=$(basename $(pwd))
          - export NUM_FV_BATCHES=8
          - export RUN_UT=true
          - export FV_FOCUS=BPF-SAFE
          - export IMAGE=ubuntu-2404-noble-amd64-v20250502a
          - export UBUNTU_VERSION=noble
          - export DOCKER_VERSION=5:27.5.1-1~ubuntu.24.04~noble
          - mkdir artifacts
          - ./.semaphore/create-test-vms ${VM_PREFIX}
      jobs:
        - name: UT/FV tests on new kernel
          execution_time_limit:
            minutes: 180
          commands:
            - ./.semaphore/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - ./.semaphore/collect-artifacts-from-vms ${VM_PREFIX}
            - ./.semaphore/publish-artifacts
            - ./.semaphore/clean-up-vms ${VM_PREFIX}
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: BPF UT/FV tests on Ubuntu 22.04 (nftables)"
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/types/*.go','crypto/pkg/tls/*.go','felix','felix/proto/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/types/*_test.go','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd felix
          - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
          - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
          - export ZONE=europe-west3-c
          - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-felix-nft-
          - echo VM_PREFIX=${VM_PREFIX}
          - export REPO_NAME=$(basename $(pwd))
          - export NUM_FV_BATCHES=4
          - export RUN_UT=true
          - export FV_FOCUS='_BPF_.*ct=true'
          - mkdir artifacts
          - ./.semaphore/create-test-vms ${VM_PREFIX}
      jobs:
        - name: UT/FV tests on new kernel
          env_vars:
            - name: FELIX_FV_NFTABLES
              value: "Enabled"
            - name: FELIX_FV_BPFATTACHTYPE
              value: "tc"
          execution_time_limit:
            minutes: 180
          commands:
            - ./.semaphore/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - ./.semaphore/collect-artifacts-from-vms ${VM_PREFIX}
            - ./.semaphore/publish-artifacts
            - ./.semaphore/clean-up-vms ${VM_PREFIX}
      secrets:
        - name: google-service-account-for-gce
  - name: goldmane
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','crypto/pkg/tls/*.go','goldmane','lib/std/chanutil/*.go','lib/std/time/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/set/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','crypto/pkg/tls/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/set/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          # The Makefile sometimes tries to rebuild the protobuf files on non-amd architectures
          # even when they don't need to be. Touch the file to update the timestamp. We know
          # they will be up-to-date due to preflight checks.
          - touch goldmane/proto/api.pb.go
          - cd goldmane
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: guardian
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','crypto/pkg/tls/*.go','guardian','lib/std/chanutil/*.go','lib/std/cryptoutils/*.go','lib/std/time/*.go','libcalico-go/lib/logutils/*.go','pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','crypto/pkg/tls/*_test.go','lib/std/chanutil/*_test.go','lib/std/cryptoutils/*_test.go','lib/std/time/*_test.go','libcalico-go/lib/logutils/*_test.go','pkg/buildinfo/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd guardian
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: kube-controllers
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','crypto/pkg/tls/*.go','felix/bpf/tc/defs/*.go','felix/calc/*.go','felix/config/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/fv/connectivity/*.go','felix/fv/containers/*.go','felix/fv/tcpdump/*.go','felix/fv/utils/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/nftables/*.go','felix/proto/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/stringutils/*.go','felix/types/*.go','kube-controllers','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pkg/cmdwrapper/*.go','typha/pkg/config/*.go','typha/pkg/logutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/bpf/tc/defs/*_test.go','felix/calc/*_test.go','felix/config/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/fv/connectivity/*_test.go','felix/fv/containers/*_test.go','felix/fv/tcpdump/*_test.go','felix/fv/utils/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/nftables/*_test.go','felix/proto/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/stringutils/*_test.go','felix/types/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','node/pkg/lifecycle/utils/*_test.go','pkg/buildinfo/*_test.go','pkg/cmdwrapper/*_test.go','typha/pkg/config/*_test.go','typha/pkg/logutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd kube-controllers
      jobs:
        - name: "kube-controllers: tests"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: lib
    run:
      when: "false or change_in(['/lib/'])"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd lib
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: libcalico-go
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd libcalico-go
      jobs:
        - name: "libcalico-go: tests"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: "Node: Build"
    run:
      when: "change_in(['/confd/etc','/felix/bpf-apache','/felix/bpf-gpl','/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/internal/pkg/azure/*.go','cni-plugin/internal/pkg/utils/*.go','cni-plugin/internal/pkg/utils/cri/*.go','cni-plugin/pkg/dataplane/*.go','cni-plugin/pkg/dataplane/grpc/*.go','cni-plugin/pkg/dataplane/grpc/proto/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/ipamplugin/*.go','cni-plugin/pkg/k8s/*.go','cni-plugin/pkg/plugin/*.go','cni-plugin/pkg/types/*.go','cni-plugin/pkg/upgrade/*.go','cni-plugin/pkg/wait/*.go','confd/pkg/backends/*.go','confd/pkg/backends/calico/*.go','confd/pkg/config/*.go','confd/pkg/log/*.go','confd/pkg/resource/template/*.go','confd/pkg/run/*.go','crypto/pkg/tls/*.go','felix/aws/*.go','felix/bpf/*.go','felix/bpf/arp/*.go','felix/bpf/asm/*.go','felix/bpf/bpfdefs/*.go','felix/bpf/bpfmap/*.go','felix/bpf/conntrack/*.go','felix/bpf/conntrack/cleanupv1/*.go','felix/bpf/conntrack/timeouts/*.go','felix/bpf/conntrack/v2/*.go','felix/bpf/conntrack/v3/*.go','felix/bpf/conntrack/v4/*.go','felix/bpf/counters/*.go','felix/bpf/events/*.go','felix/bpf/failsafes/*.go','felix/bpf/filter/*.go','felix/bpf/hook/*.go','felix/bpf/ifstate/*.go','felix/bpf/ipsets/*.go','felix/bpf/jump/*.go','felix/bpf/legacy/*.go','felix/bpf/libbpf/*.go','felix/bpf/maps/*.go','felix/bpf/nat/*.go','felix/bpf/perf/*.go','felix/bpf/polprog/*.go','felix/bpf/profiling/*.go','felix/bpf/proxy/*.go','felix/bpf/qos/*.go','felix/bpf/routes/*.go','felix/bpf/state/*.go','felix/bpf/tc/*.go','felix/bpf/tc/defs/*.go','felix/bpf/utils/*.go','felix/bpf/xdp/*.go','felix/cachingmap/*.go','felix/calc/*.go','felix/cmd/calico-bpf/commands/*.go','felix/collector/*.go','felix/collector/flowlog/*.go','felix/collector/goldmane/*.go','felix/collector/local/*.go','felix/collector/types/*.go','felix/collector/types/counter/*.go','felix/collector/types/endpoint/*.go','felix/collector/types/metric/*.go','felix/collector/types/tuple/*.go','felix/collector/utils/*.go','felix/config/*.go','felix/conntrack/*.go','felix/daemon/*.go','felix/dataplane/*.go','felix/dataplane/common/*.go','felix/dataplane/external/*.go','felix/dataplane/inactive/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/dataplane/linux/qos/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/ethtool/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ifacemonitor/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/jitter/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/linkaddrs/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/netlinkshim/handlemgr/*.go','felix/nfnetlink/*.go','felix/nfnetlink/nfnl/*.go','felix/nfnetlink/pkt/*.go','felix/nftables/*.go','felix/policysync/*.go','felix/proto/*.go','felix/routerule/*.go','felix/routetable/*.go','felix/routetable/ownershippol/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/statusrep/*.go','felix/stringutils/*.go','felix/throttle/*.go','felix/timeshim/*.go','felix/types/*.go','felix/usagerep/*.go','felix/vxlanfdb/*.go','felix/wireguard/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/internal/pkg/azure/*_test.go','cni-plugin/internal/pkg/utils/*_test.go','cni-plugin/internal/pkg/utils/cri/*_test.go','cni-plugin/pkg/dataplane/*_test.go','cni-plugin/pkg/dataplane/grpc/*_test.go','cni-plugin/pkg/dataplane/grpc/proto/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/ipamplugin/*_test.go','cni-plugin/pkg/k8s/*_test.go','cni-plugin/pkg/plugin/*_test.go','cni-plugin/pkg/types/*_test.go','cni-plugin/pkg/upgrade/*_test.go','cni-plugin/pkg/wait/*_test.go','confd/pkg/backends/*_test.go','confd/pkg/backends/calico/*_test.go','confd/pkg/config/*_test.go','confd/pkg/log/*_test.go','confd/pkg/resource/template/*_test.go','confd/pkg/run/*_test.go','crypto/pkg/tls/*_test.go','felix/aws/*_test.go','felix/bpf/*_test.go','felix/bpf/arp/*_test.go','felix/bpf/asm/*_test.go','felix/bpf/bpfdefs/*_test.go','felix/bpf/bpfmap/*_test.go','felix/bpf/conntrack/*_test.go','felix/bpf/conntrack/cleanupv1/*_test.go','felix/bpf/conntrack/timeouts/*_test.go','felix/bpf/conntrack/v2/*_test.go','felix/bpf/conntrack/v3/*_test.go','felix/bpf/conntrack/v4/*_test.go','felix/bpf/counters/*_test.go','felix/bpf/events/*_test.go','felix/bpf/failsafes/*_test.go','felix/bpf/filter/*_test.go','felix/bpf/hook/*_test.go','felix/bpf/ifstate/*_test.go','felix/bpf/ipsets/*_test.go','felix/bpf/jump/*_test.go','felix/bpf/legacy/*_test.go','felix/bpf/libbpf/*_test.go','felix/bpf/maps/*_test.go','felix/bpf/nat/*_test.go','felix/bpf/perf/*_test.go','felix/bpf/polprog/*_test.go','felix/bpf/profiling/*_test.go','felix/bpf/proxy/*_test.go','felix/bpf/qos/*_test.go','felix/bpf/routes/*_test.go','felix/bpf/state/*_test.go','felix/bpf/tc/*_test.go','felix/bpf/tc/defs/*_test.go','felix/bpf/utils/*_test.go','felix/bpf/xdp/*_test.go','felix/cachingmap/*_test.go','felix/calc/*_test.go','felix/cmd/calico-bpf/commands/*_test.go','felix/collector/*_test.go','felix/collector/flowlog/*_test.go','felix/collector/goldmane/*_test.go','felix/collector/local/*_test.go','felix/collector/types/*_test.go','felix/collector/types/counter/*_test.go','felix/collector/types/endpoint/*_test.go','felix/collector/types/metric/*_test.go','felix/collector/types/tuple/*_test.go','felix/collector/utils/*_test.go','felix/config/*_test.go','felix/conntrack/*_test.go','felix/daemon/*_test.go','felix/dataplane/*_test.go','felix/dataplane/common/*_test.go','felix/dataplane/external/*_test.go','felix/dataplane/inactive/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/dataplane/linux/qos/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/ethtool/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ifacemonitor/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/jitter/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/linkaddrs/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/netlinkshim/handlemgr/*_test.go','felix/nfnetlink/*_test.go','felix/nfnetlink/nfnl/*_test.go','felix/nfnetlink/pkt/*_test.go','felix/nftables/*_test.go','felix/policysync/*_test.go','felix/proto/*_test.go','felix/routerule/*_test.go','felix/routetable/*_test.go','felix/routetable/ownershippol/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/statusrep/*_test.go','felix/stringutils/*_test.go','felix/throttle/*_test.go','felix/timeshim/*_test.go','felix/types/*_test.go','felix/usagerep/*_test.go','felix/vxlanfdb/*_test.go','felix/wireguard/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2004
      prologue:
        commands:
          - cd node
      jobs:
        - name: "Node: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: "Node: multi-arch build"
    run:
      when: "change_in(['/confd/etc','/felix/bpf-apache','/felix/bpf-gpl','/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/internal/pkg/azure/*.go','cni-plugin/internal/pkg/utils/*.go','cni-plugin/internal/pkg/utils/cri/*.go','cni-plugin/pkg/dataplane/*.go','cni-plugin/pkg/dataplane/grpc/*.go','cni-plugin/pkg/dataplane/grpc/proto/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/ipamplugin/*.go','cni-plugin/pkg/k8s/*.go','cni-plugin/pkg/plugin/*.go','cni-plugin/pkg/types/*.go','cni-plugin/pkg/upgrade/*.go','cni-plugin/pkg/wait/*.go','confd/pkg/backends/*.go','confd/pkg/backends/calico/*.go','confd/pkg/config/*.go','confd/pkg/log/*.go','confd/pkg/resource/template/*.go','confd/pkg/run/*.go','crypto/pkg/tls/*.go','felix/aws/*.go','felix/bpf/*.go','felix/bpf/arp/*.go','felix/bpf/asm/*.go','felix/bpf/bpfdefs/*.go','felix/bpf/bpfmap/*.go','felix/bpf/conntrack/*.go','felix/bpf/conntrack/cleanupv1/*.go','felix/bpf/conntrack/timeouts/*.go','felix/bpf/conntrack/v2/*.go','felix/bpf/conntrack/v3/*.go','felix/bpf/conntrack/v4/*.go','felix/bpf/counters/*.go','felix/bpf/events/*.go','felix/bpf/failsafes/*.go','felix/bpf/filter/*.go','felix/bpf/hook/*.go','felix/bpf/ifstate/*.go','felix/bpf/ipsets/*.go','felix/bpf/jump/*.go','felix/bpf/legacy/*.go','felix/bpf/libbpf/*.go','felix/bpf/maps/*.go','felix/bpf/nat/*.go','felix/bpf/perf/*.go','felix/bpf/polprog/*.go','felix/bpf/profiling/*.go','felix/bpf/proxy/*.go','felix/bpf/qos/*.go','felix/bpf/routes/*.go','felix/bpf/state/*.go','felix/bpf/tc/*.go','felix/bpf/tc/defs/*.go','felix/bpf/utils/*.go','felix/bpf/xdp/*.go','felix/cachingmap/*.go','felix/calc/*.go','felix/cmd/calico-bpf/commands/*.go','felix/collector/*.go','felix/collector/flowlog/*.go','felix/collector/goldmane/*.go','felix/collector/local/*.go','felix/collector/types/*.go','felix/collector/types/counter/*.go','felix/collector/types/endpoint/*.go','felix/collector/types/metric/*.go','felix/collector/types/tuple/*.go','felix/collector/utils/*.go','felix/config/*.go','felix/conntrack/*.go','felix/daemon/*.go','felix/dataplane/*.go','felix/dataplane/common/*.go','felix/dataplane/external/*.go','felix/dataplane/inactive/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/dataplane/linux/qos/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/ethtool/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ifacemonitor/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/jitter/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/linkaddrs/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/netlinkshim/handlemgr/*.go','felix/nfnetlink/*.go','felix/nfnetlink/nfnl/*.go','felix/nfnetlink/pkt/*.go','felix/nftables/*.go','felix/policysync/*.go','felix/proto/*.go','felix/routerule/*.go','felix/routetable/*.go','felix/routetable/ownershippol/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/statusrep/*.go','felix/stringutils/*.go','felix/throttle/*.go','felix/timeshim/*.go','felix/types/*.go','felix/usagerep/*.go','felix/vxlanfdb/*.go','felix/wireguard/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/internal/pkg/azure/*_test.go','cni-plugin/internal/pkg/utils/*_test.go','cni-plugin/internal/pkg/utils/cri/*_test.go','cni-plugin/pkg/dataplane/*_test.go','cni-plugin/pkg/dataplane/grpc/*_test.go','cni-plugin/pkg/dataplane/grpc/proto/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/ipamplugin/*_test.go','cni-plugin/pkg/k8s/*_test.go','cni-plugin/pkg/plugin/*_test.go','cni-plugin/pkg/types/*_test.go','cni-plugin/pkg/upgrade/*_test.go','cni-plugin/pkg/wait/*_test.go','confd/pkg/backends/*_test.go','confd/pkg/backends/calico/*_test.go','confd/pkg/config/*_test.go','confd/pkg/log/*_test.go','confd/pkg/resource/template/*_test.go','confd/pkg/run/*_test.go','crypto/pkg/tls/*_test.go','felix/aws/*_test.go','felix/bpf/*_test.go','felix/bpf/arp/*_test.go','felix/bpf/asm/*_test.go','felix/bpf/bpfdefs/*_test.go','felix/bpf/bpfmap/*_test.go','felix/bpf/conntrack/*_test.go','felix/bpf/conntrack/cleanupv1/*_test.go','felix/bpf/conntrack/timeouts/*_test.go','felix/bpf/conntrack/v2/*_test.go','felix/bpf/conntrack/v3/*_test.go','felix/bpf/conntrack/v4/*_test.go','felix/bpf/counters/*_test.go','felix/bpf/events/*_test.go','felix/bpf/failsafes/*_test.go','felix/bpf/filter/*_test.go','felix/bpf/hook/*_test.go','felix/bpf/ifstate/*_test.go','felix/bpf/ipsets/*_test.go','felix/bpf/jump/*_test.go','felix/bpf/legacy/*_test.go','felix/bpf/libbpf/*_test.go','felix/bpf/maps/*_test.go','felix/bpf/nat/*_test.go','felix/bpf/perf/*_test.go','felix/bpf/polprog/*_test.go','felix/bpf/profiling/*_test.go','felix/bpf/proxy/*_test.go','felix/bpf/qos/*_test.go','felix/bpf/routes/*_test.go','felix/bpf/state/*_test.go','felix/bpf/tc/*_test.go','felix/bpf/tc/defs/*_test.go','felix/bpf/utils/*_test.go','felix/bpf/xdp/*_test.go','felix/cachingmap/*_test.go','felix/calc/*_test.go','felix/cmd/calico-bpf/commands/*_test.go','felix/collector/*_test.go','felix/collector/flowlog/*_test.go','felix/collector/goldmane/*_test.go','felix/collector/local/*_test.go','felix/collector/types/*_test.go','felix/collector/types/counter/*_test.go','felix/collector/types/endpoint/*_test.go','felix/collector/types/metric/*_test.go','felix/collector/types/tuple/*_test.go','felix/collector/utils/*_test.go','felix/config/*_test.go','felix/conntrack/*_test.go','felix/daemon/*_test.go','felix/dataplane/*_test.go','felix/dataplane/common/*_test.go','felix/dataplane/external/*_test.go','felix/dataplane/inactive/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/dataplane/linux/qos/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/ethtool/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ifacemonitor/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/jitter/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/linkaddrs/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/netlinkshim/handlemgr/*_test.go','felix/nfnetlink/*_test.go','felix/nfnetlink/nfnl/*_test.go','felix/nfnetlink/pkt/*_test.go','felix/nftables/*_test.go','felix/policysync/*_test.go','felix/proto/*_test.go','felix/routerule/*_test.go','felix/routetable/*_test.go','felix/routetable/ownershippol/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/statusrep/*_test.go','felix/stringutils/*_test.go','felix/throttle/*_test.go','felix/timeshim/*_test.go','felix/types/*_test.go','felix/usagerep/*_test.go','felix/vxlanfdb/*_test.go','felix/wireguard/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - "Node: Build"
    task:
      prologue:
        commands:
          - cd node
      jobs:
        - name: Build image
          matrix:
            - env_var: ARCH
              values:
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make image ARCH=$ARCH
        - name: Build Windows archive
          commands:
            - ../.semaphore/run-and-monitor build-windows-archive.log make build-windows-archive
        - name: Build Windows image
          commands:
            - ../.semaphore/run-and-monitor build-windows-image.log make image-windows
  - name: "Node: Build - native arm64 runner"
    run:
      when: "change_in(['/confd/etc','/felix/bpf-apache','/felix/bpf-gpl','/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','cni-plugin/internal/pkg/azure/*.go','cni-plugin/internal/pkg/utils/*.go','cni-plugin/internal/pkg/utils/cri/*.go','cni-plugin/pkg/dataplane/*.go','cni-plugin/pkg/dataplane/grpc/*.go','cni-plugin/pkg/dataplane/grpc/proto/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/ipamplugin/*.go','cni-plugin/pkg/k8s/*.go','cni-plugin/pkg/plugin/*.go','cni-plugin/pkg/types/*.go','cni-plugin/pkg/upgrade/*.go','cni-plugin/pkg/wait/*.go','confd/pkg/backends/*.go','confd/pkg/backends/calico/*.go','confd/pkg/config/*.go','confd/pkg/log/*.go','confd/pkg/resource/template/*.go','confd/pkg/run/*.go','crypto/pkg/tls/*.go','felix/aws/*.go','felix/bpf/*.go','felix/bpf/arp/*.go','felix/bpf/asm/*.go','felix/bpf/bpfdefs/*.go','felix/bpf/bpfmap/*.go','felix/bpf/conntrack/*.go','felix/bpf/conntrack/cleanupv1/*.go','felix/bpf/conntrack/timeouts/*.go','felix/bpf/conntrack/v2/*.go','felix/bpf/conntrack/v3/*.go','felix/bpf/conntrack/v4/*.go','felix/bpf/counters/*.go','felix/bpf/events/*.go','felix/bpf/failsafes/*.go','felix/bpf/filter/*.go','felix/bpf/hook/*.go','felix/bpf/ifstate/*.go','felix/bpf/ipsets/*.go','felix/bpf/jump/*.go','felix/bpf/legacy/*.go','felix/bpf/libbpf/*.go','felix/bpf/maps/*.go','felix/bpf/nat/*.go','felix/bpf/perf/*.go','felix/bpf/polprog/*.go','felix/bpf/profiling/*.go','felix/bpf/proxy/*.go','felix/bpf/qos/*.go','felix/bpf/routes/*.go','felix/bpf/state/*.go','felix/bpf/tc/*.go','felix/bpf/tc/defs/*.go','felix/bpf/utils/*.go','felix/bpf/xdp/*.go','felix/cachingmap/*.go','felix/calc/*.go','felix/cmd/calico-bpf/commands/*.go','felix/collector/*.go','felix/collector/flowlog/*.go','felix/collector/goldmane/*.go','felix/collector/local/*.go','felix/collector/types/*.go','felix/collector/types/counter/*.go','felix/collector/types/endpoint/*.go','felix/collector/types/metric/*.go','felix/collector/types/tuple/*.go','felix/collector/utils/*.go','felix/config/*.go','felix/conntrack/*.go','felix/daemon/*.go','felix/dataplane/*.go','felix/dataplane/common/*.go','felix/dataplane/external/*.go','felix/dataplane/inactive/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/dataplane/linux/qos/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/ethtool/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ifacemonitor/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/jitter/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/linkaddrs/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/netlinkshim/handlemgr/*.go','felix/nfnetlink/*.go','felix/nfnetlink/nfnl/*.go','felix/nfnetlink/pkt/*.go','felix/nftables/*.go','felix/policysync/*.go','felix/proto/*.go','felix/routerule/*.go','felix/routetable/*.go','felix/routetable/ownershippol/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/statusrep/*.go','felix/stringutils/*.go','felix/throttle/*.go','felix/timeshim/*.go','felix/types/*.go','felix/usagerep/*.go','felix/vxlanfdb/*.go','felix/wireguard/*.go','goldmane/pkg/client/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/std/chanutil/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','node','pkg/buildinfo/*.go','pod2daemon/binder/*.go','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','cni-plugin/internal/pkg/azure/*_test.go','cni-plugin/internal/pkg/utils/*_test.go','cni-plugin/internal/pkg/utils/cri/*_test.go','cni-plugin/pkg/dataplane/*_test.go','cni-plugin/pkg/dataplane/grpc/*_test.go','cni-plugin/pkg/dataplane/grpc/proto/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/ipamplugin/*_test.go','cni-plugin/pkg/k8s/*_test.go','cni-plugin/pkg/plugin/*_test.go','cni-plugin/pkg/types/*_test.go','cni-plugin/pkg/upgrade/*_test.go','cni-plugin/pkg/wait/*_test.go','confd/pkg/backends/*_test.go','confd/pkg/backends/calico/*_test.go','confd/pkg/config/*_test.go','confd/pkg/log/*_test.go','confd/pkg/resource/template/*_test.go','confd/pkg/run/*_test.go','crypto/pkg/tls/*_test.go','felix/aws/*_test.go','felix/bpf/*_test.go','felix/bpf/arp/*_test.go','felix/bpf/asm/*_test.go','felix/bpf/bpfdefs/*_test.go','felix/bpf/bpfmap/*_test.go','felix/bpf/conntrack/*_test.go','felix/bpf/conntrack/cleanupv1/*_test.go','felix/bpf/conntrack/timeouts/*_test.go','felix/bpf/conntrack/v2/*_test.go','felix/bpf/conntrack/v3/*_test.go','felix/bpf/conntrack/v4/*_test.go','felix/bpf/counters/*_test.go','felix/bpf/events/*_test.go','felix/bpf/failsafes/*_test.go','felix/bpf/filter/*_test.go','felix/bpf/hook/*_test.go','felix/bpf/ifstate/*_test.go','felix/bpf/ipsets/*_test.go','felix/bpf/jump/*_test.go','felix/bpf/legacy/*_test.go','felix/bpf/libbpf/*_test.go','felix/bpf/maps/*_test.go','felix/bpf/nat/*_test.go','felix/bpf/perf/*_test.go','felix/bpf/polprog/*_test.go','felix/bpf/profiling/*_test.go','felix/bpf/proxy/*_test.go','felix/bpf/qos/*_test.go','felix/bpf/routes/*_test.go','felix/bpf/state/*_test.go','felix/bpf/tc/*_test.go','felix/bpf/tc/defs/*_test.go','felix/bpf/utils/*_test.go','felix/bpf/xdp/*_test.go','felix/cachingmap/*_test.go','felix/calc/*_test.go','felix/cmd/calico-bpf/commands/*_test.go','felix/collector/*_test.go','felix/collector/flowlog/*_test.go','felix/collector/goldmane/*_test.go','felix/collector/local/*_test.go','felix/collector/types/*_test.go','felix/collector/types/counter/*_test.go','felix/collector/types/endpoint/*_test.go','felix/collector/types/metric/*_test.go','felix/collector/types/tuple/*_test.go','felix/collector/utils/*_test.go','felix/config/*_test.go','felix/conntrack/*_test.go','felix/daemon/*_test.go','felix/dataplane/*_test.go','felix/dataplane/common/*_test.go','felix/dataplane/external/*_test.go','felix/dataplane/inactive/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/dataplane/linux/qos/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/ethtool/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ifacemonitor/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/jitter/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/linkaddrs/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/netlinkshim/handlemgr/*_test.go','felix/nfnetlink/*_test.go','felix/nfnetlink/nfnl/*_test.go','felix/nfnetlink/pkt/*_test.go','felix/nftables/*_test.go','felix/policysync/*_test.go','felix/proto/*_test.go','felix/routerule/*_test.go','felix/routetable/*_test.go','felix/routetable/ownershippol/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/statusrep/*_test.go','felix/stringutils/*_test.go','felix/throttle/*_test.go','felix/timeshim/*_test.go','felix/types/*_test.go','felix/usagerep/*_test.go','felix/vxlanfdb/*_test.go','felix/wireguard/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/std/chanutil/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go','pod2daemon/binder/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - "Node: Build"
    task:
      agent:
        machine:
          type: s1-aws-arm64-2
      prologue:
        commands:
          - cd node
      jobs:
        - name: Build image
          commands:
            - ../.semaphore/run-and-monitor build-arm64.log make image ARCH=arm64
  - name: "Node: kind-cluster tests"
    run:
      # KinD tests also build and run all the other images.
      when: "change_in(['/confd/etc','/felix/bpf-apache','/felix/bpf-gpl','/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/client/clientset_generated/clientset/*.go','api/pkg/client/clientset_generated/clientset/scheme/*.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','api/pkg/openapi/*.go','apiserver/Makefile','apiserver/cmd/apiserver/*.go','apiserver/cmd/apiserver/server/*.go','apiserver/deps.txt','apiserver/pkg/apiserver/*.go','apiserver/pkg/printers/projectcalico/*.go','apiserver/pkg/rbac/*.go','apiserver/pkg/rbac/mock/*.go','apiserver/pkg/registry/projectcalico/authorizer/*.go','apiserver/pkg/registry/projectcalico/bgpconfiguration/*.go','apiserver/pkg/registry/projectcalico/bgpfilter/*.go','apiserver/pkg/registry/projectcalico/bgppeer/*.go','apiserver/pkg/registry/projectcalico/blockaffinity/*.go','apiserver/pkg/registry/projectcalico/caliconodestatus/*.go','apiserver/pkg/registry/projectcalico/clusterinformation/*.go','apiserver/pkg/registry/projectcalico/felixconfig/*.go','apiserver/pkg/registry/projectcalico/globalnetworkset/*.go','apiserver/pkg/registry/projectcalico/globalpolicy/*.go','apiserver/pkg/registry/projectcalico/hostendpoint/*.go','apiserver/pkg/registry/projectcalico/ipamconfig/*.go','apiserver/pkg/registry/projectcalico/ippool/*.go','apiserver/pkg/registry/projectcalico/ipreservation/*.go','apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*.go','apiserver/pkg/registry/projectcalico/networkpolicy/*.go','apiserver/pkg/registry/projectcalico/networkset/*.go','apiserver/pkg/registry/projectcalico/profile/*.go','apiserver/pkg/registry/projectcalico/rest/*.go','apiserver/pkg/registry/projectcalico/server/*.go','apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*.go','apiserver/pkg/registry/projectcalico/tier/*.go','apiserver/pkg/registry/projectcalico/util/*.go','apiserver/pkg/storage/calico/*.go','apiserver/pkg/storage/etcd/*.go','apiserver/test/integration/*.go','apiserver/test/util/*.go','app-policy/checker/*.go','app-policy/policystore/*.go','app-policy/types/*.go','calicoctl/Makefile','calicoctl/calicoctl/*.go','calicoctl/calicoctl/commands/*.go','calicoctl/calicoctl/commands/argutils/*.go','calicoctl/calicoctl/commands/clientmgr/*.go','calicoctl/calicoctl/commands/cluster/*.go','calicoctl/calicoctl/commands/common/*.go','calicoctl/calicoctl/commands/constants/*.go','calicoctl/calicoctl/commands/datastore/*.go','calicoctl/calicoctl/commands/datastore/migrate/*.go','calicoctl/calicoctl/commands/file/*.go','calicoctl/calicoctl/commands/ipam/*.go','calicoctl/calicoctl/commands/node/*.go','calicoctl/calicoctl/commands/resourceloader/*.go','calicoctl/calicoctl/resourcemgr/*.go','calicoctl/calicoctl/util/*.go','calicoctl/calicoctl/util/yaml/*.go','calicoctl/deps.txt','calicoctl/tests/fv/*.go','calicoctl/tests/fv/helper/*.go','calicoctl/tests/fv/utils/*.go','cni-plugin/Makefile','cni-plugin/cmd/calico/*.go','cni-plugin/cmd/install/*.go','cni-plugin/deps.txt','cni-plugin/internal/pkg/azure/*.go','cni-plugin/internal/pkg/testutils/*.go','cni-plugin/internal/pkg/utils/*.go','cni-plugin/internal/pkg/utils/cri/*.go','cni-plugin/internal/pkg/utils/hcn/*.go','cni-plugin/internal/pkg/utils/winpol/*.go','cni-plugin/pkg/dataplane/*.go','cni-plugin/pkg/dataplane/grpc/*.go','cni-plugin/pkg/dataplane/grpc/proto/*.go','cni-plugin/pkg/dataplane/linux/*.go','cni-plugin/pkg/install/*.go','cni-plugin/pkg/ipamplugin/*.go','cni-plugin/pkg/k8s/*.go','cni-plugin/pkg/plugin/*.go','cni-plugin/pkg/types/*.go','cni-plugin/pkg/upgrade/*.go','cni-plugin/pkg/wait/*.go','cni-plugin/tests/*.go','cni-plugin/win_tests/*.go','confd/pkg/backends/*.go','confd/pkg/backends/calico/*.go','confd/pkg/config/*.go','confd/pkg/log/*.go','confd/pkg/resource/template/*.go','confd/pkg/run/*.go','crypto/pkg/tls/*.go','felix/aws/*.go','felix/bpf/*.go','felix/bpf/arp/*.go','felix/bpf/asm/*.go','felix/bpf/bpfdefs/*.go','felix/bpf/bpfmap/*.go','felix/bpf/conntrack/*.go','felix/bpf/conntrack/cleanupv1/*.go','felix/bpf/conntrack/timeouts/*.go','felix/bpf/conntrack/v2/*.go','felix/bpf/conntrack/v3/*.go','felix/bpf/conntrack/v4/*.go','felix/bpf/counters/*.go','felix/bpf/events/*.go','felix/bpf/failsafes/*.go','felix/bpf/filter/*.go','felix/bpf/hook/*.go','felix/bpf/ifstate/*.go','felix/bpf/ipsets/*.go','felix/bpf/jump/*.go','felix/bpf/legacy/*.go','felix/bpf/libbpf/*.go','felix/bpf/maps/*.go','felix/bpf/nat/*.go','felix/bpf/perf/*.go','felix/bpf/polprog/*.go','felix/bpf/profiling/*.go','felix/bpf/proxy/*.go','felix/bpf/qos/*.go','felix/bpf/routes/*.go','felix/bpf/state/*.go','felix/bpf/tc/*.go','felix/bpf/tc/defs/*.go','felix/bpf/utils/*.go','felix/bpf/xdp/*.go','felix/cachingmap/*.go','felix/calc/*.go','felix/cmd/calico-bpf/commands/*.go','felix/collector/*.go','felix/collector/flowlog/*.go','felix/collector/goldmane/*.go','felix/collector/local/*.go','felix/collector/types/*.go','felix/collector/types/counter/*.go','felix/collector/types/endpoint/*.go','felix/collector/types/metric/*.go','felix/collector/types/tuple/*.go','felix/collector/utils/*.go','felix/config/*.go','felix/conntrack/*.go','felix/daemon/*.go','felix/dataplane/*.go','felix/dataplane/common/*.go','felix/dataplane/external/*.go','felix/dataplane/inactive/*.go','felix/dataplane/ipsets/*.go','felix/dataplane/linux/*.go','felix/dataplane/linux/dataplanedefs/*.go','felix/dataplane/linux/qos/*.go','felix/deltatracker/*.go','felix/dispatcher/*.go','felix/environment/*.go','felix/ethtool/*.go','felix/fv/connectivity/*.go','felix/fv/containers/*.go','felix/fv/tcpdump/*.go','felix/fv/utils/*.go','felix/generictables/*.go','felix/hashutils/*.go','felix/idalloc/*.go','felix/ifacemonitor/*.go','felix/ip/*.go','felix/ipsets/*.go','felix/iptables/*.go','felix/iptables/cmdshim/*.go','felix/jitter/*.go','felix/k8sutils/*.go','felix/labelindex/*.go','felix/labelindex/ipsetmember/*.go','felix/labelindex/labelnamevalueindex/*.go','felix/labelindex/labelrestrictionindex/*.go','felix/linkaddrs/*.go','felix/logutils/*.go','felix/markbits/*.go','felix/multidict/*.go','felix/netlinkshim/*.go','felix/netlinkshim/handlemgr/*.go','felix/nfnetlink/*.go','felix/nfnetlink/nfnl/*.go','felix/nfnetlink/pkt/*.go','felix/nftables/*.go','felix/policysync/*.go','felix/proto/*.go','felix/routerule/*.go','felix/routetable/*.go','felix/routetable/ownershippol/*.go','felix/rules/*.go','felix/serviceindex/*.go','felix/statusrep/*.go','felix/stringutils/*.go','felix/throttle/*.go','felix/timeshim/*.go','felix/types/*.go','felix/usagerep/*.go','felix/vxlanfdb/*.go','felix/wireguard/*.go','goldmane/Makefile','goldmane/cmd/*.go','goldmane/cmd/flowgen/*.go','goldmane/cmd/health/*.go','goldmane/cmd/stream/*.go','goldmane/deps.txt','goldmane/fv/*.go','goldmane/pkg/client/*.go','goldmane/pkg/client/mocks/*.go','goldmane/pkg/daemon/*.go','goldmane/pkg/emitter/*.go','goldmane/pkg/flowgen/*.go','goldmane/pkg/goldmane/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/internal/utils/*.go','goldmane/pkg/server/*.go','goldmane/pkg/storage/*.go','goldmane/pkg/stream/*.go','goldmane/pkg/testutils/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','goldmane/proto/mocks/*.go','kube-controllers/Makefile','kube-controllers/cmd/check-status/*.go','kube-controllers/cmd/kube-controllers/*.go','kube-controllers/cmd/wrapper/*.go','kube-controllers/deps.txt','kube-controllers/pkg/cache/*.go','kube-controllers/pkg/config/*.go','kube-controllers/pkg/controllers/controller/*.go','kube-controllers/pkg/controllers/flannelmigration/*.go','kube-controllers/pkg/controllers/loadbalancer/*.go','kube-controllers/pkg/controllers/namespace/*.go','kube-controllers/pkg/controllers/networkpolicy/*.go','kube-controllers/pkg/controllers/node/*.go','kube-controllers/pkg/controllers/pod/*.go','kube-controllers/pkg/controllers/serviceaccount/*.go','kube-controllers/pkg/controllers/utils/*.go','kube-controllers/pkg/converter/*.go','kube-controllers/pkg/status/*.go','kube-controllers/tests/testutils/*.go','lib/httpmachinery/pkg/apiutil/*.go','lib/httpmachinery/pkg/codec/*.go','lib/httpmachinery/pkg/context/*.go','lib/httpmachinery/pkg/header/*.go','lib/httpmachinery/pkg/server/*.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','lib/std/chanutil/*.go','lib/std/cryptoutils/*.go','lib/std/testutils/json/*.go','lib/std/time/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/config/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/dispatcher/*.go','libcalico-go/lib/epstatusfile/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/netlinkutils/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/packedmap/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','node','node/pkg/cni/*.go','node/pkg/lifecycle/utils/*.go','pkg/buildinfo/*.go','pkg/cmdwrapper/*.go','pod2daemon/Makefile','pod2daemon/binder/*.go','pod2daemon/csidriver/*.go','pod2daemon/csidriver/driver/*.go','pod2daemon/deps.txt','pod2daemon/flexvol/*.go','pod2daemon/flexvol/creds/*.go','pod2daemon/nodeagent/*.go','pod2daemon/proto/*.go','pod2daemon/workloadapi/*.go','typha/Makefile','typha/cmd/calico-typha/*.go','typha/cmd/typha-client/*.go','typha/deps.txt','typha/fv-tests/*.go','typha/pkg/calc/*.go','typha/pkg/config/*.go','typha/pkg/daemon/*.go','typha/pkg/discovery/*.go','typha/pkg/jitter/*.go','typha/pkg/k8s/*.go','typha/pkg/logutils/*.go','typha/pkg/promutils/*.go','typha/pkg/snapcache/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncclientutils/*.go','typha/pkg/syncproto/*.go','typha/pkg/syncserver/*.go','typha/pkg/tlsutils/*.go','whisker-backend/Makefile','whisker-backend/cmd/*.go','whisker-backend/cmd/app/*.go','whisker-backend/deps.txt','whisker-backend/pkg/apis/v1/*.go','whisker-backend/pkg/config/*.go','whisker-backend/pkg/handlers/v1/*.go','whisker-backend/test/fv/*.go','whisker/Makefile','whisker/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/client/clientset_generated/clientset/*_test.go','api/pkg/client/clientset_generated/clientset/scheme/*_test.go','api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','api/pkg/openapi/*_test.go','apiserver/cmd/apiserver/*_test.go','apiserver/cmd/apiserver/server/*_test.go','apiserver/pkg/apiserver/*_test.go','apiserver/pkg/printers/projectcalico/*_test.go','apiserver/pkg/rbac/*_test.go','apiserver/pkg/rbac/mock/*_test.go','apiserver/pkg/registry/projectcalico/authorizer/*_test.go','apiserver/pkg/registry/projectcalico/bgpconfiguration/*_test.go','apiserver/pkg/registry/projectcalico/bgpfilter/*_test.go','apiserver/pkg/registry/projectcalico/bgppeer/*_test.go','apiserver/pkg/registry/projectcalico/blockaffinity/*_test.go','apiserver/pkg/registry/projectcalico/caliconodestatus/*_test.go','apiserver/pkg/registry/projectcalico/clusterinformation/*_test.go','apiserver/pkg/registry/projectcalico/felixconfig/*_test.go','apiserver/pkg/registry/projectcalico/globalnetworkset/*_test.go','apiserver/pkg/registry/projectcalico/globalpolicy/*_test.go','apiserver/pkg/registry/projectcalico/hostendpoint/*_test.go','apiserver/pkg/registry/projectcalico/ipamconfig/*_test.go','apiserver/pkg/registry/projectcalico/ippool/*_test.go','apiserver/pkg/registry/projectcalico/ipreservation/*_test.go','apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*_test.go','apiserver/pkg/registry/projectcalico/networkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/networkset/*_test.go','apiserver/pkg/registry/projectcalico/profile/*_test.go','apiserver/pkg/registry/projectcalico/rest/*_test.go','apiserver/pkg/registry/projectcalico/server/*_test.go','apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*_test.go','apiserver/pkg/registry/projectcalico/tier/*_test.go','apiserver/pkg/registry/projectcalico/util/*_test.go','apiserver/pkg/storage/calico/*_test.go','apiserver/pkg/storage/etcd/*_test.go','apiserver/test/integration/*_test.go','apiserver/test/util/*_test.go','app-policy/checker/*_test.go','app-policy/policystore/*_test.go','app-policy/types/*_test.go','calicoctl/calicoctl/*_test.go','calicoctl/calicoctl/commands/*_test.go','calicoctl/calicoctl/commands/argutils/*_test.go','calicoctl/calicoctl/commands/clientmgr/*_test.go','calicoctl/calicoctl/commands/cluster/*_test.go','calicoctl/calicoctl/commands/common/*_test.go','calicoctl/calicoctl/commands/constants/*_test.go','calicoctl/calicoctl/commands/datastore/*_test.go','calicoctl/calicoctl/commands/datastore/migrate/*_test.go','calicoctl/calicoctl/commands/file/*_test.go','calicoctl/calicoctl/commands/ipam/*_test.go','calicoctl/calicoctl/commands/node/*_test.go','calicoctl/calicoctl/commands/resourceloader/*_test.go','calicoctl/calicoctl/resourcemgr/*_test.go','calicoctl/calicoctl/util/*_test.go','calicoctl/calicoctl/util/yaml/*_test.go','calicoctl/tests/fv/*_test.go','calicoctl/tests/fv/helper/*_test.go','calicoctl/tests/fv/utils/*_test.go','cni-plugin/cmd/calico/*_test.go','cni-plugin/cmd/install/*_test.go','cni-plugin/internal/pkg/azure/*_test.go','cni-plugin/internal/pkg/testutils/*_test.go','cni-plugin/internal/pkg/utils/*_test.go','cni-plugin/internal/pkg/utils/cri/*_test.go','cni-plugin/internal/pkg/utils/hcn/*_test.go','cni-plugin/internal/pkg/utils/winpol/*_test.go','cni-plugin/pkg/dataplane/*_test.go','cni-plugin/pkg/dataplane/grpc/*_test.go','cni-plugin/pkg/dataplane/grpc/proto/*_test.go','cni-plugin/pkg/dataplane/linux/*_test.go','cni-plugin/pkg/install/*_test.go','cni-plugin/pkg/ipamplugin/*_test.go','cni-plugin/pkg/k8s/*_test.go','cni-plugin/pkg/plugin/*_test.go','cni-plugin/pkg/types/*_test.go','cni-plugin/pkg/upgrade/*_test.go','cni-plugin/pkg/wait/*_test.go','cni-plugin/tests/*_test.go','cni-plugin/win_tests/*_test.go','confd/pkg/backends/*_test.go','confd/pkg/backends/calico/*_test.go','confd/pkg/config/*_test.go','confd/pkg/log/*_test.go','confd/pkg/resource/template/*_test.go','confd/pkg/run/*_test.go','crypto/pkg/tls/*_test.go','felix/aws/*_test.go','felix/bpf/*_test.go','felix/bpf/arp/*_test.go','felix/bpf/asm/*_test.go','felix/bpf/bpfdefs/*_test.go','felix/bpf/bpfmap/*_test.go','felix/bpf/conntrack/*_test.go','felix/bpf/conntrack/cleanupv1/*_test.go','felix/bpf/conntrack/timeouts/*_test.go','felix/bpf/conntrack/v2/*_test.go','felix/bpf/conntrack/v3/*_test.go','felix/bpf/conntrack/v4/*_test.go','felix/bpf/counters/*_test.go','felix/bpf/events/*_test.go','felix/bpf/failsafes/*_test.go','felix/bpf/filter/*_test.go','felix/bpf/hook/*_test.go','felix/bpf/ifstate/*_test.go','felix/bpf/ipsets/*_test.go','felix/bpf/jump/*_test.go','felix/bpf/legacy/*_test.go','felix/bpf/libbpf/*_test.go','felix/bpf/maps/*_test.go','felix/bpf/nat/*_test.go','felix/bpf/perf/*_test.go','felix/bpf/polprog/*_test.go','felix/bpf/profiling/*_test.go','felix/bpf/proxy/*_test.go','felix/bpf/qos/*_test.go','felix/bpf/routes/*_test.go','felix/bpf/state/*_test.go','felix/bpf/tc/*_test.go','felix/bpf/tc/defs/*_test.go','felix/bpf/utils/*_test.go','felix/bpf/xdp/*_test.go','felix/cachingmap/*_test.go','felix/calc/*_test.go','felix/cmd/calico-bpf/commands/*_test.go','felix/collector/*_test.go','felix/collector/flowlog/*_test.go','felix/collector/goldmane/*_test.go','felix/collector/local/*_test.go','felix/collector/types/*_test.go','felix/collector/types/counter/*_test.go','felix/collector/types/endpoint/*_test.go','felix/collector/types/metric/*_test.go','felix/collector/types/tuple/*_test.go','felix/collector/utils/*_test.go','felix/config/*_test.go','felix/conntrack/*_test.go','felix/daemon/*_test.go','felix/dataplane/*_test.go','felix/dataplane/common/*_test.go','felix/dataplane/external/*_test.go','felix/dataplane/inactive/*_test.go','felix/dataplane/ipsets/*_test.go','felix/dataplane/linux/*_test.go','felix/dataplane/linux/dataplanedefs/*_test.go','felix/dataplane/linux/qos/*_test.go','felix/deltatracker/*_test.go','felix/dispatcher/*_test.go','felix/environment/*_test.go','felix/ethtool/*_test.go','felix/fv/connectivity/*_test.go','felix/fv/containers/*_test.go','felix/fv/tcpdump/*_test.go','felix/fv/utils/*_test.go','felix/generictables/*_test.go','felix/hashutils/*_test.go','felix/idalloc/*_test.go','felix/ifacemonitor/*_test.go','felix/ip/*_test.go','felix/ipsets/*_test.go','felix/iptables/*_test.go','felix/iptables/cmdshim/*_test.go','felix/jitter/*_test.go','felix/k8sutils/*_test.go','felix/labelindex/*_test.go','felix/labelindex/ipsetmember/*_test.go','felix/labelindex/labelnamevalueindex/*_test.go','felix/labelindex/labelrestrictionindex/*_test.go','felix/linkaddrs/*_test.go','felix/logutils/*_test.go','felix/markbits/*_test.go','felix/multidict/*_test.go','felix/netlinkshim/*_test.go','felix/netlinkshim/handlemgr/*_test.go','felix/nfnetlink/*_test.go','felix/nfnetlink/nfnl/*_test.go','felix/nfnetlink/pkt/*_test.go','felix/nftables/*_test.go','felix/policysync/*_test.go','felix/proto/*_test.go','felix/routerule/*_test.go','felix/routetable/*_test.go','felix/routetable/ownershippol/*_test.go','felix/rules/*_test.go','felix/serviceindex/*_test.go','felix/statusrep/*_test.go','felix/stringutils/*_test.go','felix/throttle/*_test.go','felix/timeshim/*_test.go','felix/types/*_test.go','felix/usagerep/*_test.go','felix/vxlanfdb/*_test.go','felix/wireguard/*_test.go','goldmane/cmd/*_test.go','goldmane/cmd/flowgen/*_test.go','goldmane/cmd/health/*_test.go','goldmane/cmd/stream/*_test.go','goldmane/fv/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/client/mocks/*_test.go','goldmane/pkg/daemon/*_test.go','goldmane/pkg/emitter/*_test.go','goldmane/pkg/flowgen/*_test.go','goldmane/pkg/goldmane/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/internal/utils/*_test.go','goldmane/pkg/server/*_test.go','goldmane/pkg/storage/*_test.go','goldmane/pkg/stream/*_test.go','goldmane/pkg/testutils/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','goldmane/proto/mocks/*_test.go','kube-controllers/cmd/check-status/*_test.go','kube-controllers/cmd/kube-controllers/*_test.go','kube-controllers/cmd/wrapper/*_test.go','kube-controllers/pkg/cache/*_test.go','kube-controllers/pkg/config/*_test.go','kube-controllers/pkg/controllers/controller/*_test.go','kube-controllers/pkg/controllers/flannelmigration/*_test.go','kube-controllers/pkg/controllers/loadbalancer/*_test.go','kube-controllers/pkg/controllers/namespace/*_test.go','kube-controllers/pkg/controllers/networkpolicy/*_test.go','kube-controllers/pkg/controllers/node/*_test.go','kube-controllers/pkg/controllers/pod/*_test.go','kube-controllers/pkg/controllers/serviceaccount/*_test.go','kube-controllers/pkg/controllers/utils/*_test.go','kube-controllers/pkg/converter/*_test.go','kube-controllers/pkg/status/*_test.go','kube-controllers/tests/testutils/*_test.go','lib/httpmachinery/pkg/apiutil/*_test.go','lib/httpmachinery/pkg/codec/*_test.go','lib/httpmachinery/pkg/context/*_test.go','lib/httpmachinery/pkg/header/*_test.go','lib/httpmachinery/pkg/server/*_test.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*_test.go','lib/std/chanutil/*_test.go','lib/std/cryptoutils/*_test.go','lib/std/testutils/json/*_test.go','lib/std/time/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/config/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/dispatcher/*_test.go','libcalico-go/lib/epstatusfile/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/netlinkutils/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/packedmap/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','pkg/buildinfo/*_test.go','pkg/cmdwrapper/*_test.go','pod2daemon/binder/*_test.go','pod2daemon/csidriver/*_test.go','pod2daemon/csidriver/driver/*_test.go','pod2daemon/flexvol/*_test.go','pod2daemon/flexvol/creds/*_test.go','pod2daemon/nodeagent/*_test.go','pod2daemon/proto/*_test.go','pod2daemon/workloadapi/*_test.go','typha/cmd/calico-typha/*_test.go','typha/cmd/typha-client/*_test.go','typha/fv-tests/*_test.go','typha/pkg/calc/*_test.go','typha/pkg/config/*_test.go','typha/pkg/daemon/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/jitter/*_test.go','typha/pkg/k8s/*_test.go','typha/pkg/logutils/*_test.go','typha/pkg/promutils/*_test.go','typha/pkg/snapcache/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncclientutils/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/syncserver/*_test.go','typha/pkg/tlsutils/*_test.go','whisker-backend/cmd/*_test.go','whisker-backend/cmd/app/*_test.go','whisker-backend/pkg/apis/v1/*_test.go','whisker-backend/pkg/config/*_test.go','whisker-backend/pkg/handlers/v1/*_test.go','whisker-backend/test/fv/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd node
          - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
          - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
          - export ZONE=europe-west3-c
          - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-kind-
          - echo VM_PREFIX=${VM_PREFIX}
          - export REPO_NAME=$(basename $(pwd))
          - export VM_DISK_SIZE=80GB
          - mkdir artifacts
          - ../.semaphore/vms/create-test-vms ${ZONE} ${VM_PREFIX}
      jobs:
        - name: "Node: kind-cluster tests"
          execution_time_limit:
            minutes: 120
          commands:
            - ../.semaphore/vms/run-tests-on-vms ${ZONE} ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - ../.semaphore/vms/publish-artifacts
            - ../.semaphore/vms/clean-up-vms ${ZONE} ${VM_PREFIX}
            - test-results publish ./report/*.xml --name "node-kind-tests" || true
      secrets:
        - name: google-service-account-for-gce
  - name: pod2daemon
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','libcalico-go/lib/logutils/*.go','pod2daemon'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','libcalico-go/lib/logutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd pod2daemon
      jobs:
        - name: pod2daemon tests
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
            - test-results publish ./report/*.xml --name "pod2daemon-ut-tests" || true
  - name: "Tools (hack directory)"
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/hack/', '/api/', '/libcalico-go/'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd hack
      jobs:
        - name: "Tools (hack directory)"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: Typha
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apiconfig/*.go','libcalico-go/lib/apis/v1/*.go','libcalico-go/lib/apis/v1/unversioned/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/etcdv3/*.go','libcalico-go/lib/backend/k8s/*.go','libcalico-go/lib/backend/k8s/conversion/*.go','libcalico-go/lib/backend/k8s/resources/*.go','libcalico-go/lib/backend/k8s/scheme/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','libcalico-go/lib/backend/watchersyncer/*.go','libcalico-go/lib/clientv3/*.go','libcalico-go/lib/debugserver/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/hash/*.go','libcalico-go/lib/health/*.go','libcalico-go/lib/ipam/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/metricsserver/*.go','libcalico-go/lib/multireadbuf/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/options/*.go','libcalico-go/lib/prometheus/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/resources/*.go','libcalico-go/lib/scope/*.go','libcalico-go/lib/selector/*.go','libcalico-go/lib/selector/parser/*.go','libcalico-go/lib/selector/tokenizer/*.go','libcalico-go/lib/set/*.go','libcalico-go/lib/upgrade/converters/*.go','libcalico-go/lib/upgrade/migrator/*.go','libcalico-go/lib/upgrade/migrator/clients/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*.go','libcalico-go/lib/validator/v1/*.go','libcalico-go/lib/validator/v3/*.go','libcalico-go/lib/watch/*.go','libcalico-go/lib/winutils/*.go','libcalico-go/lib/writelogger/*.go','pkg/buildinfo/*.go','typha'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apiconfig/*_test.go','libcalico-go/lib/apis/v1/*_test.go','libcalico-go/lib/apis/v1/unversioned/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/etcdv3/*_test.go','libcalico-go/lib/backend/k8s/*_test.go','libcalico-go/lib/backend/k8s/conversion/*_test.go','libcalico-go/lib/backend/k8s/resources/*_test.go','libcalico-go/lib/backend/k8s/scheme/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/backend/syncersv1/bgpsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/dedupebuffer/*_test.go','libcalico-go/lib/backend/syncersv1/felixsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/nodestatussyncer/*_test.go','libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*_test.go','libcalico-go/lib/backend/syncersv1/updateprocessors/*_test.go','libcalico-go/lib/backend/watchersyncer/*_test.go','libcalico-go/lib/clientv3/*_test.go','libcalico-go/lib/debugserver/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/hash/*_test.go','libcalico-go/lib/health/*_test.go','libcalico-go/lib/ipam/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/metricsserver/*_test.go','libcalico-go/lib/multireadbuf/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/options/*_test.go','libcalico-go/lib/prometheus/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/resources/*_test.go','libcalico-go/lib/scope/*_test.go','libcalico-go/lib/selector/*_test.go','libcalico-go/lib/selector/parser/*_test.go','libcalico-go/lib/selector/tokenizer/*_test.go','libcalico-go/lib/set/*_test.go','libcalico-go/lib/upgrade/converters/*_test.go','libcalico-go/lib/upgrade/migrator/*_test.go','libcalico-go/lib/upgrade/migrator/clients/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/custom/*_test.go','libcalico-go/lib/upgrade/migrator/clients/v1/k8s/resources/*_test.go','libcalico-go/lib/validator/v1/*_test.go','libcalico-go/lib/validator/v3/*_test.go','libcalico-go/lib/watch/*_test.go','libcalico-go/lib/winutils/*_test.go','libcalico-go/lib/writelogger/*_test.go','pkg/buildinfo/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd typha
      jobs:
        - name: "Typha: UT and FV tests"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci EXCEPT=k8sfv-test
        - name: "Typha: UT and FV tests on UBI-minimal"
          commands:
            - ../.semaphore/run-and-monitor make-fv-ubi.log make clean image fv
          env_vars:
            - name: USE_UBI_AS_CALICO_BASE
              value: '1'
      epilogue:
        always:
          commands:
            - |
              for f in /home/semaphore/calico/typha/report/*; do
                NAME=$(basename $f)
                test-results compile --name typha-$NAME $f $NAME.json || true
              done
              for f in /home/semaphore/calico/typha/pkg/report/*; do
                NAME=$(basename $f)
                test-results compile --name typha-$NAME $f $NAME.json || true
              done
              test-results combine *.xml.json report.json || true
              artifact push job report.json -d test-results/junit.json || true
              artifact push workflow report.json -d test-results/${SEMAPHORE_PIPELINE_ID}/${SEMAPHORE_JOB_ID}.json || true
            - test-results publish /home/semaphore/calico/felix/report/k8sfv_suite.xml --name "typha-k8sfv" || true
  - name: whisker-backend
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','crypto/pkg/tls/*.go','goldmane/pkg/client/*.go','goldmane/pkg/internal/flowcache/*.go','goldmane/pkg/types/*.go','goldmane/proto/*.go','lib/httpmachinery/pkg/apiutil/*.go','lib/httpmachinery/pkg/codec/*.go','lib/httpmachinery/pkg/context/*.go','lib/httpmachinery/pkg/header/*.go','lib/httpmachinery/pkg/server/*.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','lib/std/cryptoutils/*.go','lib/std/testutils/json/*.go','lib/std/time/*.go','libcalico-go/lib/logutils/*.go','whisker-backend'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','crypto/pkg/tls/*_test.go','goldmane/pkg/client/*_test.go','goldmane/pkg/internal/flowcache/*_test.go','goldmane/pkg/types/*_test.go','goldmane/proto/*_test.go','lib/httpmachinery/pkg/apiutil/*_test.go','lib/httpmachinery/pkg/codec/*_test.go','lib/httpmachinery/pkg/context/*_test.go','lib/httpmachinery/pkg/header/*_test.go','lib/httpmachinery/pkg/server/*_test.go','lib/httpmachinery/pkg/server/adaptors/gorilla/*_test.go','lib/std/cryptoutils/*_test.go','lib/std/testutils/json/*_test.go','lib/std/time/*_test.go','libcalico-go/lib/logutils/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd whisker-backend
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: whisker
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/whisker/'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd whisker
      jobs:
        - name: make ci
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: Build binary
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: key-cert-provisioner
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','key-cert-provisioner'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd key-cert-provisioner
      jobs:
        - name: key-cert-provisioner tests
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: "OpenStack integration (Yoga)"
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/networking-calico/'])"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: f1-standard-2
          os_image: ubuntu2004
      prologue:
        commands:
          - cd networking-calico
      jobs:
        - name: "Unit and FV tests (tox) on Yoga"
          commands:
            - ../.semaphore/run-and-monitor tox.log make tox-yoga
        - name: "Mainline ST (DevStack + Tempest) on Yoga"
          commands:
            # For some reason python3-wrapt is pre-installed on a Semaphore ubuntu2004 node, but with
            # a version (1.11.2) that is different from the version that OpenStack needs (1.13.3), and
            # this was causing the DevStack setup to fail, because pip doesn't know how to uninstall
            # or replace the existing version.  Happily we do know that, so let's do it upfront here.
            - sudo apt-get remove -y python3-wrapt || true
            # Install all the packages that would trigger an initramfs update using a workaround
            # for limited /boot partition space in the ubuntu2004 image
            - sudo apt update
            - sudo rsync -av /boot/ /boot2/
            - sudo mount --bind /boot2 /boot
            - sudo apt install -y cryptsetup lsscsi open-iscsi thin-provisioning-tools
            - sudo umount /boot
            - sudo rsync -av /boot2/ /boot/ --exclude "*.new" --exclude "*.dpkg-bak" --delete --inplace
            - sudo rm -rf /boot2/
            # Set NC_PLUGIN_REPO and NC_PLUGIN_REF so that DevStack will use the networking-calico
            # code from the current PR or branch.  The following checkout is to make sure of having a
            # local ref that we can specify.
            - git checkout -b devstack-test
            - export NC_PLUGIN_REPO=$(dirname $(pwd))
            - export NC_PLUGIN_REF=$(git rev-parse --abbrev-ref HEAD)
            - sudo git config --system --add safe.directory ${NC_PLUGIN_REPO}/.git
            - TEMPEST=true DEVSTACK_BRANCH=unmaintained/yoga ./devstack/bootstrap.sh
      epilogue:
        on_fail:
          commands:
            - mkdir logs
            - sudo journalctl > logs/journalctl.txt
            - artifact push job logs

  - name: "OpenStack integration (Caracal)"
    run:
      when: "false or change_in(['/networking-calico/'])"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: f1-standard-2
          os_image: ubuntu2204
      prologue:
        commands:
          - cd networking-calico
      jobs:
        - name: "Unit and FV tests (tox) on Caracal"
          commands:
            - ../.semaphore/run-and-monitor tox.log make tox-caracal
        - name: "Mainline ST (DevStack + Tempest) on Caracal"
          commands:
            # For some reason python3-wrapt is pre-installed on a Semaphore ubuntu2004 node, but with
            # a version (1.11.2) that is different from the version that OpenStack needs (1.13.3), and
            # this was causing the DevStack setup to fail, because pip doesn't know how to uninstall
            # or replace the existing version.  Happily we do know that, so let's do it upfront here.
            - sudo apt-get remove -y python3-wrapt || true
            # Set NC_PLUGIN_REPO and NC_PLUGIN_REF so that DevStack will use the networking-calico
            # code from the current PR or branch.  The following checkout is to make sure of having a
            # local ref that we can specify.
            - git checkout -b devstack-test
            - export NC_PLUGIN_REPO=$(dirname $(pwd))
            - export NC_PLUGIN_REF=$(git rev-parse --abbrev-ref HEAD)
            - sudo git config --system --add safe.directory ${NC_PLUGIN_REPO}/.git
            - TEMPEST=true DEVSTACK_BRANCH=stable/2024.1 ./devstack/bootstrap.sh
      epilogue:
        always:
          commands:
            - mkdir logs
            - sudo journalctl > logs/journalctl.txt
            - artifact push job logs
  - name: Mock node
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','api/pkg/apis/projectcalico/v3/*.go','api/pkg/lib/numorstring/*.go','crypto/pkg/tls/*.go','felix/proto/*.go','lib/std/uniquelabels/*.go','lib/std/uniquestr/*.go','libcalico-go/lib/apis/v3/*.go','libcalico-go/lib/backend/api/*.go','libcalico-go/lib/backend/encap/*.go','libcalico-go/lib/backend/model/*.go','libcalico-go/lib/errors/*.go','libcalico-go/lib/json/*.go','libcalico-go/lib/logutils/*.go','libcalico-go/lib/names/*.go','libcalico-go/lib/namespace/*.go','libcalico-go/lib/net/*.go','libcalico-go/lib/readlogger/*.go','libcalico-go/lib/winutils/*.go','pkg/buildinfo/*.go','test-tools/mocknode','typha/pkg/discovery/*.go','typha/pkg/syncclient/*.go','typha/pkg/syncproto/*.go','typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','api/pkg/apis/projectcalico/v3/*_test.go','api/pkg/lib/numorstring/*_test.go','crypto/pkg/tls/*_test.go','felix/proto/*_test.go','lib/std/uniquelabels/*_test.go','lib/std/uniquestr/*_test.go','libcalico-go/lib/apis/v3/*_test.go','libcalico-go/lib/backend/api/*_test.go','libcalico-go/lib/backend/encap/*_test.go','libcalico-go/lib/backend/model/*_test.go','libcalico-go/lib/errors/*_test.go','libcalico-go/lib/json/*_test.go','libcalico-go/lib/logutils/*_test.go','libcalico-go/lib/names/*_test.go','libcalico-go/lib/namespace/*_test.go','libcalico-go/lib/net/*_test.go','libcalico-go/lib/readlogger/*_test.go','libcalico-go/lib/winutils/*_test.go','pkg/buildinfo/*_test.go','typha/pkg/discovery/*_test.go','typha/pkg/syncclient/*_test.go','typha/pkg/syncproto/*_test.go','typha/pkg/tlsutils/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd test-tools/mocknode
      jobs:
        - name: Mock node
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
  - name: release tooling
    run:
      when: "change_in(['/hack/test/certs/','/lib.Makefile','/metadata.mk','libcalico-go/lib/logutils/*.go','release'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','libcalico-go/lib/logutils/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd release
      jobs:
        - name: ci
          commands:
            - ../.semaphore/run-and-monitor release-ci.log make ci
            - test-results publish --name "release-tool-ut-tests" ./report/*.xml || true
        - name: build binary
          commands:
            - ../.semaphore/run-and-monitor release-build.log make build
            - cache store release-${SEMAPHORE_GIT_SHA} bin
after_pipeline:
  task:
    jobs:
      - name: Reports
        commands:
          - test-results gen-pipeline-report --force
