# !! WARNING, DO NOT EDIT !! This file is generated from the templates
# in /.semaphore/semaphore.yml.d. To update, modify the relevant
# template and then run 'make gen-semaphore-yaml'.
version: v1.0
name: Calico
execution_time_limit:
  hours: 4
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
auto_cancel:
  running:
    when: "branch != 'master'"
  queued:
    when: "branch != 'master'"
global_job_config:
  secrets:
    - name: docker-hub
    - name: google-service-account-for-gce
  env_vars:
    - name: GOOGLE_PROJECT
      value: unique-caldron-775
    - name: GCS_BUILD_CACHE_BUCKET
      value: calico-transient-build-artifacts-europe-west3
    - name: BUILDKIT_PROGRESS
      value: plain
  prologue:
    commands:
      - export CALICO_DIR_NAME=${SEMAPHORE_GIT_DIR}
      - export GCS_CACHE_DIR=gs://$GCS_BUILD_CACHE_BUCKET/cache/${CALICO_DIR_NAME}
      - export GCS_WORKFLOW_DIR=gs://$GCS_BUILD_CACHE_BUCKET/workflow/${SEMAPHORE_WORKFLOW_ID}
      - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
      - |-
        if [[ $(uname -m) != "x86_64" || -n "$ARCH" ]]; then
          echo "Non-x86_64 build: $(uname -m) / $ARCH";
          export BUILD_CACHE_GROUP=$BUILD_CACHE_GROUP-$(uname -m)-$ARCH;
        fi
      - gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS" || true
      - gcloud config set project ${GOOGLE_PROJECT} || true
      # Try to restore the working copy from the cache, if available. Then,
      # for PRs, also try to restore the build cache.  (We skip this on branch
      # builds to ensure branches build cleanly.)
      - sudo apt-get install -y zstd || true
      - restored_wc_cache=false
      - |-
        if [[ -n "${SEMAPHORE_GIT_BRANCH}" && -z "$SKIP_CACHE_RESTORE" ]]; then
          echo "Looking for cached working copy for branch ${SEMAPHORE_GIT_BRANCH}"
          gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
          if gcloud storage cp "$gcs_branch_cache_dir/working-copy.tar.zstd" /tmp/working-copy.tar.zstd; then
            echo "Restoring cache for branch ${SEMAPHORE_GIT_BRANCH}"
            tar --use-compress-program=zstd -xf /tmp/working-copy.tar.zstd & tar_pid=$!
            downloaded_build_cache=false
            if [[ -n "$BUILD_CACHE_GROUP" && -n "${SEMAPHORE_GIT_PR_NUMBER}" ]]; then
              if gcloud storage cp "$gcs_branch_cache_dir/build-cache-${BUILD_CACHE_GROUP}.tar.zstd" /tmp/build-cache.tar.zstd; then
                echo "Found build cache for group ${BUILD_CACHE_GROUP}"
                downloaded_build_cache=true
              fi
            fi
            if wait $tar_pid; then
              restored_wc_cache=true
            else
              echo "ERROR: Failed to extract working copy"
              restored_wc_cache=false
            fi
            if ${downloaded_build_cache}; then
              echo "Extracting build cache"
              tar --use-compress-program=zstd -xf /tmp/build-cache.tar.zstd -C .
              rm /tmp/build-cache.tar.zstd
            fi
            cd "${CALICO_DIR_NAME}"
          fi
        fi || true
      - |-
        if [[ ${restored_wc_cache} != true && -z "$SKIP_CHECKOUT" ]]; then
          echo "No cache restored, doing a fresh checkout..."
          cd $HOME
          rm -rf "${CALICO_DIR_NAME}"
          git clone --filter=blob:none $SEMAPHORE_GIT_URL $CALICO_DIR_NAME
          cd "${CALICO_DIR_NAME}" || exit 1
        fi
      - |-
        if [[ -z "$SKIP_CHECKOUT" ]]; then
          git fetch origin --tags --prune-tags ${SEMAPHORE_GIT_SHA}
          if [ "$SEMAPHORE_GIT_REF_TYPE" = "branch" ]; then
            git checkout ${SEMAPHORE_GIT_SHA} -B "${SEMAPHORE_GIT_BRANCH}"
          else
            git checkout ${SEMAPHORE_GIT_SHA}
          fi
          CALICO_DIR="$(pwd)"
          export CALICO_DIR
          mkdir -p artifacts
        fi
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  epilogue:
    commands:
      - cd $HOME
      - |-
        if [[ -z "${SEMAPHORE_GIT_PR_NUMBER}" && -n "$BUILD_CACHE_GROUP" && "$STORE_BUILD_CACHE" = "true" ]]; then
          echo "On branch, storing build cache group ${BUILD_CACHE_GROUP}"
          tar --use-compress-program="zstd -3" -cf /tmp/build-cache.tar.zstd go ${CALICO_DIR_NAME}/.go-pkg-cache
          gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
          gcloud storage cp /tmp/build-cache.tar.zstd "$gcs_branch_cache_dir/build-cache-${BUILD_CACHE_GROUP}.tar.zstd"
        fi
      - cd "$CALICO_DIR"
      - .semaphore/publish-artifacts
promotions:
  # Manual promotion for publishing a hashrelease.
  - name: Publish hashrelease
    pipeline_file: release/hashrelease.yml
    parameters:
      env_vars:
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "Build container images. If 'true', container images will be built as part of the hashrelease process."
          name: BUILD_CONTAINER_IMAGES
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "create tarball of images. If 'true', a tarball of images will be added to the release.tgz. Requires BUILD_CONTAINER_IMAGES to also be 'true'."
          name: ARCHIVE_IMAGES
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: "publish images. If 'true', images will be pushed to the container registry/registries as part of the hashrelease process. Requires BUILD_CONTAINER_IMAGES to also be 'true'."
          name: PUBLISH_IMAGES
  # Manual promotion for publishing a release.
  - name: Publish official release
    pipeline_file: release/release.yml
  # Cleanup after ourselves if we are stopped-short.
  - name: Cleanup
    pipeline_file: cleanup.yml
    auto_promote:
      when: "result = 'stopped'"
  # Have separate promotions for publishing images so we can re-run
  # them individually if they fail, and so we can run them in parallel.
  - name: Push apiserver images
    pipeline_file: push-images/apiserver.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push ALP images
    pipeline_file: push-images/alp.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push calicoctl images
    pipeline_file: push-images/calicoctl.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push calico-node images
    pipeline_file: push-images/node.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push mock calico-node images
    pipeline_file: push-images/mock-node.yml
    auto_promote:
      when: "branch =~ 'master|release-'"
  - name: Push cni-plugin images
    pipeline_file: push-images/cni-plugin.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push key-cert-provisioner images
    pipeline_file: push-images/key-cert-provisioner.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push kube-controllers images
    pipeline_file: push-images/kube-controllers.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push pod2daemon images
    pipeline_file: push-images/pod2daemon.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push typha images
    pipeline_file: push-images/typha.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Goldmane images
    pipeline_file: push-images/goldmane.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Whisker images
    pipeline_file: push-images/whisker.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Whisker Backend images
    pipeline_file: push-images/whisker-backend.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Guardian images
    pipeline_file: push-images/guardian.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push Envoy images
    pipeline_file: push-images/envoy.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Publish openstack packages
    pipeline_file: push-images/packaging.yaml
    auto_promote:
      when: "branch =~ 'master'"
  - name: Run Fossa scans
    pipeline_file: license-scanning/fossa-scan.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
  - name: Push E2E images
    pipeline_file: push-images/e2e-test.yml
    auto_promote:
      when: "branch =~ 'master|release-.*'"
blocks:
  - name: Check images availability
    run:
      when: "false or (branch !~ 'build-v.*' and change_in(['/charts/', '/manifests/'], {pipeline_file: 'ignore'}))"
    dependencies: []
    task:
      jobs:
        - name: Check images availability
          commands:
            - make check-images-availability
  - name: Check SemaphoreCI files
    run:
      when: >-
        false or
        change_in(['/.semaphore', '/hack', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'track'})
    dependencies: []
    task:
      jobs:
        - name: Check semaphore files
          commands:
            - make gen-semaphore-yaml
            - make check-dirty
  - name: Check YAML files
    run:
      when: >-
        false or
        change_in(['/**/*.yml', '/**/*.yaml', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'track'})
    dependencies: []
    task:
      jobs:
        - name: Check YAML files
          commands:
            - make yaml-lint
  - name: Check Go
    run:
      when: >-
        false or
        change_in(['/go.mod', '/go.sum', '/**/*.go', '/**/deps.txt', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "preflight-go-checks"
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      jobs:
        - name: Check Go files
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
          commands:
            - make check-ginkgo-v2
            - make check-go-mod
            - make verify-go-mods
            - make gen-deps-files
            - make go-vet
            - >-
              if [ -n "$SEMAPHORE_GIT_PR_NUMBER" ]; then
                make fix-changed
              else
                make fix-all
              fi
            - make check-dirty
  - name: Check Python
    run:
      when: >-
        false or
        change_in(['/networking-calico', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check Python files
          commands:
            - make -C networking-calico fmtpy
            - make -C networking-calico flake8
            - make check-dirty
  - name: Check language/Dockerfiles
    run:
      when: >-
        false or
        change_in(['/**/*'], {pipeline_file: 'track', exclude: ['libbpf', '.[a-z]*']})
    dependencies: []
    task:
      jobs:
        - name: Check language/Dockerfiles
          commands:
            # Both of these are very quick grep checks so we combine them into one job.
            - make check-language
            - make check-dockerfiles
  - name: Check protobufs
    run:
      when: >-
        false or
        change_in(['/**/*.pb.go', '/**/*.proto', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check protobufs
          commands:
            - make protobuf fix-changed
            - make check-dirty
  - name: Manifests and API docs
    run:
      when: >-
        false or
        change_in(['/api', '/manifests', '/charts', '/libcalico-go/lib/apis', '/libcalico-go/config', '/libcalico-go/Makefile', '/felix/config', '/felix/docs', '/felix/Makefile', '/goldmane', '/Makefile', '/lib.Makefile', '/metadata.mk'], {pipeline_file: 'ignore'})
    dependencies: []
    task:
      jobs:
        - name: Check manifests and API docs
          commands:
            - make -C lib gen-files
            - make -C api gen-files
            - make -C libcalico-go gen-files
            - make -C felix gen-files
            - make -C goldmane gen-files
            - make gen-manifests
            - make fix-changed
            - make check-ocp-no-crds
            - make check-dirty
  - name: Store working copy
    run:
      when: "branch =~ '.*'"
    dependencies: []
    task:
      env_vars:
        - name: SKIP_CACHE_RESTORE
          value: "true"
      jobs:
        - name: Save working copy to cache
          commands:
            - cd ..
            - tar --use-compress-program="zstd -3" -cf /tmp/working-copy.tar.zstd $CALICO_DIR_NAME
            - gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
            - gcloud storage cp /tmp/working-copy.tar.zstd "$gcs_branch_cache_dir/working-copy.tar.zstd"
  - name: Prerequisites
    skip:
      # Always skip, this is a dummy job used to group prerequisite checks.
      when: "true"
    dependencies:
      - Check SemaphoreCI files
      - Check YAML files
      - Check Go
      - Check Python
      - Check language/Dockerfiles
      - Check protobufs
      - Manifests and API docs
      - Store working copy
    task:
      jobs:
        - name: Pre-flight checks
          commands:
            - "true"
  - name: API
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/api/'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd api
      jobs:
        - name: "API: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: API Server
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-apiserver.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/client/clientset_generated/clientset/*.go','/api/pkg/client/clientset_generated/clientset/scheme/*.go','/api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/api/pkg/openapi/*.go','/apiserver/**','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "apiserver"
      prologue:
        commands:
          - cd apiserver
      jobs:
        - name: "API Server: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "API Server: Build"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: Application Layer Policy
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-app-policy.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/**','/crypto/pkg/tls/*.go','/felix/bpf/tc/defs/*.go','/felix/calc/*.go','/felix/config/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/nftables/*.go','/felix/proto/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/stringutils/*.go','/felix/types/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd app-policy
      jobs:
        - name: "Application Layer Policy: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
  - name: calicoctl
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-calicoctl.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/calicoctl/**','/crypto/pkg/tls/*.go','/hack/test/certs/','/kube-controllers/pkg/config/*.go','/kube-controllers/pkg/controllers/loadbalancer/*.go','/kube-controllers/pkg/controllers/utils/*.go','/kube-controllers/pkg/converter/*.go','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/kube-controllers/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "calicoctl"
      prologue:
        commands:
          - cd calicoctl
      jobs:
        - name: "calicoctl: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: CNI Plugin
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-cni-plugin.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/cni-plugin/**','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/cni/*.go','/pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "cni-plugin"
      prologue:
        commands:
          - cd cni-plugin
      jobs:
        - name: "CNI Plugin: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "CNI Plugin: build windows images"
          commands:
            - ../.semaphore/run-and-monitor ci.log make image-windows
  - name: "CNI Plugin: Windows"
    run:
      when: "false or change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-cni-plugin.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/cni-plugin/**','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/cni/*.go','/pkg/buildinfo/*.go','/process/testing/aso','/process/testing/utils','/process/testing/winfv-cni-plugin'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      secrets:
        - name: banzai-secrets
      prologue:
        commands:
          # Prepare azure configuration.
          - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
          - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
          - export AZURE_TENANT_ID=$AZ_TENANT_ID
          - export AZURE_CLIENT_ID=$AZ_SP_ID
          - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
          - export REPORT_DIR=/home/semaphore/calico/process/testing/winfv-cni-plugin/report
          - export LOGS_DIR=~/fv.log
          - export RG_PREFIX=${USER}-win-cni-${SEMAPHORE_GIT_SHA:0:4}-pr${SEMAPHORE_GIT_PR_NUMBER}
          - cd cni-plugin
          - ../.semaphore/run-and-monitor build.log make bin/windows/calico.exe bin/windows/calico-ipam.exe bin/windows/win-fv.exe
      epilogue:
        always:
          commands:
            - artifact push job ${REPORT_DIR} --destination semaphore/test-results || true
            - artifact push job ${LOGS_DIR} --destination semaphore/logs || true
            - cd ~/calico/process/testing/aso && make dist-clean
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "cni-plugin"
        - name: SEMAPHORE_ARTIFACT_EXPIRY
          value: 2w
        - name: AZURE_LOCATION
          value: eastus2
        - name: KUBE_VERSION
          value: v1.33.7
      jobs:
        - name: "CNI Plugin: Windows Containerd FV - overlay"
          execution_time_limit:
            minutes: 60
          commands:
            - export BACKEND=overlay
            - export AZURE_RESOURCE_GROUP=${RG_PREFIX}-${BACKEND}-rg
            - echo AZURE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}
            - ../.semaphore/run-and-monitor win-fv-containerd.log ~/calico/process/testing/winfv-cni-plugin/run-win-fv.sh
        - name: "CNI Plugin: Windows Containerd FV - l2bridge"
          execution_time_limit:
            minutes: 60
          commands:
            - export BACKEND=l2bridge
            - export AZURE_RESOURCE_GROUP=${RG_PREFIX}-${BACKEND}-rg
            - echo AZURE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}
            - ../.semaphore/run-and-monitor win-fv-containerd.log ~/calico/process/testing/winfv-cni-plugin/run-win-fv.sh
  - name: confd
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-confd.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/confd/**','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/pkg/buildinfo/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "confd"
      prologue:
        commands:
          - cd confd
      jobs:
        - name: "confd: CI"
          execution_time_limit:
            minutes: 60
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: E2E script & pipeline validations
    run:
      when: "false or change_in(['/.semaphore/end-to-end/'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 5
    dependencies:
      - Prerequisites
    task:
      jobs:
        - name: "E2E script & pipeline validations: validate yaml"
          commands:
            - ./.semaphore/end-to-end/scripts/test_scripts/e2e-validation.sh
  - name: E2E tests
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-e2e.yml','/Makefile','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/client/clientset_generated/clientset/*.go','/api/pkg/client/clientset_generated/clientset/scheme/*.go','/api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','/api/pkg/client/informers_generated/externalversions/*.go','/api/pkg/client/informers_generated/externalversions/internalinterfaces/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/v3/*.go','/api/pkg/client/listers_generated/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/api/pkg/openapi/*.go','/apiserver/cmd/apiserver/*.go','/apiserver/cmd/apiserver/server/*.go','/apiserver/pkg/apiserver/*.go','/apiserver/pkg/printers/projectcalico/*.go','/apiserver/pkg/rbac/*.go','/apiserver/pkg/registry/projectcalico/authorizer/*.go','/apiserver/pkg/registry/projectcalico/bgpconfiguration/*.go','/apiserver/pkg/registry/projectcalico/bgpfilter/*.go','/apiserver/pkg/registry/projectcalico/bgppeer/*.go','/apiserver/pkg/registry/projectcalico/blockaffinity/*.go','/apiserver/pkg/registry/projectcalico/caliconodestatus/*.go','/apiserver/pkg/registry/projectcalico/clusterinformation/*.go','/apiserver/pkg/registry/projectcalico/felixconfig/*.go','/apiserver/pkg/registry/projectcalico/globalnetworkset/*.go','/apiserver/pkg/registry/projectcalico/globalpolicy/*.go','/apiserver/pkg/registry/projectcalico/hostendpoint/*.go','/apiserver/pkg/registry/projectcalico/ipamconfig/*.go','/apiserver/pkg/registry/projectcalico/ippool/*.go','/apiserver/pkg/registry/projectcalico/ipreservation/*.go','/apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*.go','/apiserver/pkg/registry/projectcalico/networkpolicy/*.go','/apiserver/pkg/registry/projectcalico/networkset/*.go','/apiserver/pkg/registry/projectcalico/profile/*.go','/apiserver/pkg/registry/projectcalico/rest/*.go','/apiserver/pkg/registry/projectcalico/server/*.go','/apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/tier/*.go','/apiserver/pkg/registry/projectcalico/util/*.go','/apiserver/pkg/storage/calico/*.go','/apiserver/pkg/storage/etcd/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/calicoctl/calicoctl/*.go','/calicoctl/calicoctl/commands/*.go','/calicoctl/calicoctl/commands/argutils/*.go','/calicoctl/calicoctl/commands/clientmgr/*.go','/calicoctl/calicoctl/commands/cluster/*.go','/calicoctl/calicoctl/commands/common/*.go','/calicoctl/calicoctl/commands/constants/*.go','/calicoctl/calicoctl/commands/datastore/*.go','/calicoctl/calicoctl/commands/datastore/migrate/*.go','/calicoctl/calicoctl/commands/file/*.go','/calicoctl/calicoctl/commands/ipam/*.go','/calicoctl/calicoctl/commands/node/*.go','/calicoctl/calicoctl/resourcemgr/*.go','/calicoctl/calicoctl/util/*.go','/calicoctl/calicoctl/util/yaml/*.go','/calicoctl/tests/fv/helper/*.go','/cni-plugin/cmd/calico/*.go','/cni-plugin/cmd/install/*.go','/cni-plugin/internal/pkg/azure/*.go','/cni-plugin/internal/pkg/utils/*.go','/cni-plugin/internal/pkg/utils/cri/*.go','/cni-plugin/pkg/dataplane/*.go','/cni-plugin/pkg/dataplane/grpc/*.go','/cni-plugin/pkg/dataplane/grpc/proto/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/install/*.go','/cni-plugin/pkg/ipamplugin/*.go','/cni-plugin/pkg/k8s/*.go','/cni-plugin/pkg/plugin/*.go','/cni-plugin/pkg/types/*.go','/cni-plugin/pkg/upgrade/*.go','/cni-plugin/pkg/wait/*.go','/cni-plugin/tests/*.go','/confd/etc','/confd/pkg/backends/*.go','/confd/pkg/backends/calico/*.go','/confd/pkg/backends/types/*.go','/confd/pkg/config/*.go','/confd/pkg/log/*.go','/confd/pkg/resource/template/*.go','/confd/pkg/run/*.go','/crypto/pkg/tls/*.go','/e2e/**','/felix/aws/*.go','/felix/bpf-apache','/felix/bpf-gpl','/felix/bpf/*.go','/felix/bpf/arp/*.go','/felix/bpf/asm/*.go','/felix/bpf/bpfdefs/*.go','/felix/bpf/bpfmap/*.go','/felix/bpf/conntrack/*.go','/felix/bpf/conntrack/cleanupv1/*.go','/felix/bpf/conntrack/timeouts/*.go','/felix/bpf/conntrack/v2/*.go','/felix/bpf/conntrack/v3/*.go','/felix/bpf/conntrack/v4/*.go','/felix/bpf/consistenthash/*.go','/felix/bpf/counters/*.go','/felix/bpf/events/*.go','/felix/bpf/failsafes/*.go','/felix/bpf/filter/*.go','/felix/bpf/hook/*.go','/felix/bpf/ifstate/*.go','/felix/bpf/ipfrags/*.go','/felix/bpf/ipsets/*.go','/felix/bpf/jump/*.go','/felix/bpf/legacy/*.go','/felix/bpf/libbpf/*.go','/felix/bpf/maps/*.go','/felix/bpf/nat/*.go','/felix/bpf/perf/*.go','/felix/bpf/polprog/*.go','/felix/bpf/profiling/*.go','/felix/bpf/proxy/*.go','/felix/bpf/qos/*.go','/felix/bpf/routes/*.go','/felix/bpf/state/*.go','/felix/bpf/tc/*.go','/felix/bpf/tc/defs/*.go','/felix/bpf/utils/*.go','/felix/bpf/xdp/*.go','/felix/cachingmap/*.go','/felix/calc/*.go','/felix/cmd/calico-bpf/commands/*.go','/felix/collector/*.go','/felix/collector/flowlog/*.go','/felix/collector/goldmane/*.go','/felix/collector/local/*.go','/felix/collector/types/*.go','/felix/collector/types/counter/*.go','/felix/collector/types/endpoint/*.go','/felix/collector/types/metric/*.go','/felix/collector/types/tuple/*.go','/felix/collector/utils/*.go','/felix/config/*.go','/felix/conntrack/*.go','/felix/daemon/*.go','/felix/dataplane/*.go','/felix/dataplane/common/*.go','/felix/dataplane/external/*.go','/felix/dataplane/inactive/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/dataplane/linux/qos/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/ethtool/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ifacemonitor/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/jitter/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/linkaddrs/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/netlinkshim/handlemgr/*.go','/felix/nfnetlink/*.go','/felix/nfnetlink/nfnl/*.go','/felix/nfnetlink/pkt/*.go','/felix/nftables/*.go','/felix/policysync/*.go','/felix/proto/*.go','/felix/proto/protoconv/*.go','/felix/routerule/*.go','/felix/routetable/*.go','/felix/routetable/ownershippol/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/statusrep/*.go','/felix/stringutils/*.go','/felix/throttle/*.go','/felix/timeshim/*.go','/felix/types/*.go','/felix/usagerep/*.go','/felix/vxlanfdb/*.go','/felix/wireguard/*.go','/goldmane/cmd/*.go','/goldmane/cmd/flowgen/*.go','/goldmane/cmd/health/*.go','/goldmane/cmd/stream/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/daemon/*.go','/goldmane/pkg/emitter/*.go','/goldmane/pkg/flowgen/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/internal/utils/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/kube-controllers/cmd/check-status/*.go','/kube-controllers/cmd/kube-controllers/*.go','/kube-controllers/cmd/wrapper/*.go','/kube-controllers/pkg/cache/*.go','/kube-controllers/pkg/config/*.go','/kube-controllers/pkg/controllers/controller/*.go','/kube-controllers/pkg/controllers/flannelmigration/*.go','/kube-controllers/pkg/controllers/ippool/*.go','/kube-controllers/pkg/controllers/loadbalancer/*.go','/kube-controllers/pkg/controllers/namespace/*.go','/kube-controllers/pkg/controllers/networkpolicy/*.go','/kube-controllers/pkg/controllers/node/*.go','/kube-controllers/pkg/controllers/pod/*.go','/kube-controllers/pkg/controllers/serviceaccount/*.go','/kube-controllers/pkg/controllers/utils/*.go','/kube-controllers/pkg/converter/*.go','/kube-controllers/pkg/status/*.go','/lib.Makefile','/lib/httpmachinery/pkg/apiutil/*.go','/lib/httpmachinery/pkg/codec/*.go','/lib/httpmachinery/pkg/context/*.go','/lib/httpmachinery/pkg/header/*.go','/lib/httpmachinery/pkg/server/*.go','/lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/cmd/calico-ipam/*.go','/node/cmd/calico-node/*.go','/node/cmd/calico-node/bpf/*.go','/node/cmd/calico/*.go','/node/cmd/mountns/*.go','/node/pkg/allocateip/*.go','/node/pkg/calicoclient/*.go','/node/pkg/cni/*.go','/node/pkg/flowlogs/*.go','/node/pkg/health/*.go','/node/pkg/health/bird/*.go','/node/pkg/hostpathinit/*.go','/node/pkg/lifecycle/shutdown/*.go','/node/pkg/lifecycle/startup/*.go','/node/pkg/lifecycle/startup/autodetection/*.go','/node/pkg/lifecycle/startup/autodetection/ipv4/*.go','/node/pkg/lifecycle/utils/*.go','/node/pkg/nodeinit/*.go','/node/pkg/status/*.go','/node/pkg/status/populators/*.go','/node/windows-packaging/tests/*.go','/pkg/buildinfo/*.go','/pkg/cmdwrapper/*.go','/pod2daemon/binder/*.go','/pod2daemon/csidriver/*.go','/pod2daemon/csidriver/driver/*.go','/pod2daemon/flexvol/*.go','/pod2daemon/flexvol/creds/*.go','/pod2daemon/nodeagent/*.go','/pod2daemon/proto/*.go','/pod2daemon/workloadapi/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','/whisker','/whisker-backend/cmd/*.go','/whisker-backend/cmd/app/*.go','/whisker-backend/pkg/apis/v1/*.go','/whisker-backend/pkg/config/*.go','/whisker-backend/pkg/handlers/v1/*.go','apiserver/**/*Dockerfile*','apiserver/Makefile','apiserver/deps.txt','calicoctl/**/*Dockerfile*','calicoctl/Makefile','calicoctl/deps.txt','cni-plugin/**/*Dockerfile*','cni-plugin/Makefile','cni-plugin/deps.txt','goldmane/**/*Dockerfile*','goldmane/Makefile','goldmane/deps.txt','kube-controllers/**/*Dockerfile*','kube-controllers/Makefile','kube-controllers/deps.txt','node/**/*Dockerfile*','node/Makefile','node/deps.txt','pod2daemon/**/*Dockerfile*','pod2daemon/Makefile','pod2daemon/deps.txt','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt','whisker-backend/**/*Dockerfile*','whisker-backend/Makefile','whisker-backend/deps.txt','whisker/**/*Dockerfile*','whisker/Makefile','whisker/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/apiserver/**/*_test.go','/app-policy/**/*_test.go','/calicoctl/**/*_test.go','/cni-plugin/**/*_test.go','/confd/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/kube-controllers/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go','/whisker-backend/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "e2e-tests"
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      jobs:
        - name: "E2E tests: Conformance"
          commands:
            - .semaphore/run-and-monitor e2e-test.log make e2e-test
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: Envoy Gateway
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-gateway'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-gateway
      jobs:
        - name: "Envoy Gateway: CI"
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: "Envoy Gateway: build multi-arch binaries"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: Envoy Proxy
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-proxy'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-proxy
      jobs:
        - name: "Envoy Proxy: CI"
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: "Envoy Proxy: build multi-arch binaries"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: "Envoy Ratelimit"
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/third_party/envoy-ratelimit'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd third_party/envoy-ratelimit
      jobs:
        - name: "Envoy Ratelimit: CI"
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
        - name: "Envoy Ratelimit: build multi-arch binaries"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: "Felix: Build"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "felix"
      prologue:
        commands:
          - cd felix
          - gcloud config set project unique-caldron-775
          - gcloud auth activate-service-account --key-file=$HOME/secrets/secret.google-service-account-key.json
      secrets:
        - name: google-service-account-for-gce
      jobs:
        - name: "Felix: Build and cache FV prerequisites"
          priority:
          # This job is on the critical path so we increase its priority.
            - value: 51
              when: "pull_request =~ '.+'"
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
          execution_time_limit:
            minutes: 20
          commands:
            - make build image ut-bpf-prereqs fv-prereqs
            - ./.semaphore/cache-test-artifacts
        - name: "Felix: UT"
          priority:
            # This job is on the critical path so we increase its priority.
            - value: 51
              when: "pull_request =~ '.+'"
          execution_time_limit:
            minutes: 30
          commands:
            - ../.semaphore/run-and-monitor ut.log make ut
        - name: "Felix: k8sfv"
          priority:
            # This job is on the critical path so we increase its priority.
            - value: 51
              when: "pull_request =~ '.+'"
          execution_time_limit:
            minutes: 15
          commands:
            - ../.semaphore/run-and-monitor k8sfv-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=true
            - ../.semaphore/run-and-monitor k8sfv-no-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=false
        - name: "Felix: Static checks"
          priority:
            # This job is on the critical path so we increase its priority.
            - value: 51
              when: "pull_request =~ '.+'"
          execution_time_limit:
            minutes: 15
          commands:
            - ../.semaphore/run-and-monitor static-checks.log make static-checks
      epilogue:
        always:
          commands:
            - 'test-results publish --name "${SEMAPHORE_JOB_NAME}" ./report/*.xml || true'
  - name: "Felix: multi-arch build"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      prologue:
        commands:
          - cd felix
      jobs:
        - name: "Felix: build multi-arch binaries"
          matrix:
            - env_var: ARCH
              values:
                - ppc64le
                - s390x
          commands:
            # Only building the code, not the image here because the felix image is now only used for FV tests, which
            # only run on AMD64 at the moment.
            - ../.semaphore/run-and-monitor build-$ARCH.log make build ARCH=$ARCH
  - name: "Felix: Build - native arm64 runner"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      agent:
        machine:
          type: s1-aws-arm64-2
      prologue:
        commands:
          - cd felix
      jobs:
        - name: "Felix: build arm64 binaries"
          commands:
            - ../.semaphore/run-and-monitor build-arm64.log make build ARCH=arm64
  - name: "Felix: Build Windows binaries"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "felix"
      jobs:
        - name: "Felix: Build Windows binaries"
          commands:
            - cd felix
            - make bin/calico-felix.exe fv/win-fv.exe
  - name: "Felix: Windows FV"
    run:
      when: "false or change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/process/testing/aso','/process/testing/utils','/process/testing/winfv-felix','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies: ["Felix: Build Windows binaries"]
    task:
      secrets:
        - name: banzai-secrets
        - name: private-repo
      prologue:
        commands:
          - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
          - export REPORT_DIR=/home/semaphore/report
          - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
          - export AZURE_TENANT_ID=$AZ_TENANT_ID
          - export AZURE_CLIENT_ID=$AZ_SP_ID
          - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
          - export REPORT_DIR=/home/semaphore/calico/process/testing/winfv-felix/report
          - export LOGS_DIR=~/fv.log
          - export RG_PREFIX=${USER}-win-felix-${SEMAPHORE_GIT_SHA:0:4}-pr${SEMAPHORE_GIT_PR_NUMBER}
          - cd felix
      epilogue:
        always:
          commands:
            - artifact push job ${REPORT_DIR} --destination semaphore/test-results || true
            - artifact push job ${LOGS_DIR} --destination semaphore/logs || true
            - cd ~/calico/process/testing/aso && make dist-clean
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "felix"
        - name: FV_TYPE
          value: "calico-felix"
        - name: SEMAPHORE_ARTIFACT_EXPIRY
          value: 2w
        - name: CONTAINERD_VERSION
          value: 1.7.28
      jobs:
        - name: "Felix: Windows FV"
          commands:
            - export AZURE_RESOURCE_GROUP=${RG_PREFIX}-rg
            - echo AZURE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}
            - ../.semaphore/run-and-monitor win-fv-felix.log ~/calico/process/testing/winfv-felix/run-win-fv.sh
  - name: "Felix: iptables tests on Ubuntu 22.04"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: iptables tests on Ubuntu 22.04"
          execution_time_limit:
            minutes: 60
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "22.04-ipt"
          commands:
            - source felix/.semaphore/fv-prologue
            - export NUM_FV_BATCHES=16
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: nftables tests on Ubuntu 22.04"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: nftables tests on Ubuntu 22.04"
          execution_time_limit:
            minutes: 60
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "22.04-nft"
          commands:
            - source felix/.semaphore/fv-prologue
            - export NUM_FV_BATCHES=16
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: BPF tests on Ubuntu 24.04 (iptables)"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: BPF tests on Ubuntu 24.04"
          execution_time_limit:
            minutes: 60
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "bpf-24.04-ipt-with-ut"
          commands:
            - source felix/.semaphore/fv-prologue
            - export NUM_FV_BATCHES=60
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
          execution_time_limit:
            minutes: 60
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "bpf-22.04-nft-with-ut"
            - name: FELIX_FV_BPFATTACHTYPE
              value: "tc"
          commands:
            - source felix/.semaphore/fv-prologue
            # Limit to BPF conntrack tests to reduce overall runtime.
            - export FV_FOCUS='_BPF_.*ct=true'
            - export NUM_FV_BATCHES=10
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: BPF program-loading check on 25.10 (nftables)"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: BPF program-loading check on 25.10"
          execution_time_limit:
            minutes: 30
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "bpf-25.10-nft-no-fv-with-ut"
            - name: FELIX_FV_BPFATTACHTYPE
              value: "tc"
          commands:
            - source felix/.semaphore/fv-prologue
            # Only run the UT that checks that the precompiled BPF binaries are loadable.
            - export UT_FOCUS="TestPrecompiledBinariesAreLoadable"
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: "Felix: BPF tests on Ubuntu 25.10 with jitharden=2 (nftables)"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-felix.yml','/.semaphore/vms/','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/types/*.go','/crypto/pkg/tls/*.go','/felix/**','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/crypto/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Felix: Build"
    task:
      jobs:
        - name: "Felix: BPF tests on Ubuntu 25.10 with jitharden=2"
          execution_time_limit:
            minutes: 60
          env_vars:
            - name: FELIX_TEST_GROUP
              value: "bpf-25.10-nft-with-ut-jitharden"
            - name: FELIX_FV_BPFATTACHTYPE
              value: "tc"
          commands:
            - source felix/.semaphore/fv-prologue
            # Limit to BPF TCP+conntrack tests to reduce overall runtime.
            - export FV_FOCUS='_BPF_.*tcp.*ct=true'
            - export NUM_FV_BATCHES=16
            - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - source felix/.semaphore/fv-epilogue
      secrets:
        - name: google-service-account-for-gce
  - name: Goldmane
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-goldmane.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/felix/proto/*.go','/felix/types/*.go','/goldmane/**','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/set/*.go','/metadata.mk'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "goldmane"
      prologue:
        commands:
          # The Makefile sometimes tries to rebuild the protobuf files on non-amd architectures
          # even when they don't need to be. Touch the file to update the timestamp. We know
          # they will be up-to-date due to preflight checks.
          - touch goldmane/proto/api.pb.go
          - cd goldmane
      jobs:
        - name: "Goldmane: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "Goldmane: build multi-arch"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: Guardian
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-guardian.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/guardian/**','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/cryptoutils/*.go','/lib/std/time/*.go','/libcalico-go/lib/logutils/*.go','/metadata.mk','/pkg/buildinfo/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "guardian"
      prologue:
        commands:
          - cd guardian
      jobs:
        - name: "Guardian: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "Guardian: build multi-arch"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: kube-controllers
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-kube-controllers.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/client/clientset_generated/clientset/*.go','/api/pkg/client/clientset_generated/clientset/scheme/*.go','/api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','/api/pkg/client/informers_generated/externalversions/*.go','/api/pkg/client/informers_generated/externalversions/internalinterfaces/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/v3/*.go','/api/pkg/client/listers_generated/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/felix/bpf/tc/defs/*.go','/felix/calc/*.go','/felix/config/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/fv/connectivity/*.go','/felix/fv/containers/*.go','/felix/fv/tcpdump/*.go','/felix/fv/utils/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/nftables/*.go','/felix/proto/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/stringutils/*.go','/felix/types/*.go','/hack/test/certs/','/kube-controllers/**','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/testutils/stacktrace/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/pkg/lifecycle/utils/*.go','/pkg/buildinfo/*.go','/pkg/cmdwrapper/*.go','/typha/pkg/config/*.go','/typha/pkg/logutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/node/**/*_test.go','/pkg/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "kube-controllers"
      prologue:
        commands:
          - cd kube-controllers
      jobs:
        - name: "kube-controllers: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        # Run a subset of the kube-controllers CI tests that use the projectcalico.org/v3 API group for CRDs.
        - name: "kube-controllers: CI (projectcalico.org/v3)"
          commands:
            - ../.semaphore/run-and-monitor ut.log make image ut
          env_vars:
            - name: CALICO_API_GROUP
              value: "projectcalico.org/v3"
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: Libraries (lib)
    run:
      when: "false or change_in(['/lib/'], {pipeline_file: 'ignore'})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd lib
      jobs:
        - name: "Libraries: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: libcalico-go
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-libcalico-go.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/**','/metadata.mk','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "libcalico-go"
      prologue:
        commands:
          - cd libcalico-go
      jobs:
        # Run the tests twice, once for each backing API version.
        - name: "libcalico-go: CI (crd.projectcalico.org/v1)"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "libcalico-go: CI (projectcalico.org/v3)"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
            - name: CALICO_API_GROUP
              value: projectcalico.org/v3
            - name: GINKGO_SKIP
              value: "etcdv3 backend"
  - name: "Node: Build"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-node.yml','/Makefile','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/internal/pkg/azure/*.go','/cni-plugin/internal/pkg/utils/*.go','/cni-plugin/internal/pkg/utils/cri/*.go','/cni-plugin/pkg/dataplane/*.go','/cni-plugin/pkg/dataplane/grpc/*.go','/cni-plugin/pkg/dataplane/grpc/proto/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/ipamplugin/*.go','/cni-plugin/pkg/k8s/*.go','/cni-plugin/pkg/plugin/*.go','/cni-plugin/pkg/types/*.go','/cni-plugin/pkg/upgrade/*.go','/cni-plugin/pkg/wait/*.go','/confd/etc','/confd/pkg/backends/*.go','/confd/pkg/backends/calico/*.go','/confd/pkg/backends/types/*.go','/confd/pkg/config/*.go','/confd/pkg/log/*.go','/confd/pkg/resource/template/*.go','/confd/pkg/run/*.go','/crypto/pkg/tls/*.go','/felix/aws/*.go','/felix/bpf-apache','/felix/bpf-gpl','/felix/bpf/*.go','/felix/bpf/arp/*.go','/felix/bpf/asm/*.go','/felix/bpf/bpfdefs/*.go','/felix/bpf/bpfmap/*.go','/felix/bpf/conntrack/*.go','/felix/bpf/conntrack/cleanupv1/*.go','/felix/bpf/conntrack/timeouts/*.go','/felix/bpf/conntrack/v2/*.go','/felix/bpf/conntrack/v3/*.go','/felix/bpf/conntrack/v4/*.go','/felix/bpf/consistenthash/*.go','/felix/bpf/counters/*.go','/felix/bpf/events/*.go','/felix/bpf/failsafes/*.go','/felix/bpf/filter/*.go','/felix/bpf/hook/*.go','/felix/bpf/ifstate/*.go','/felix/bpf/ipfrags/*.go','/felix/bpf/ipsets/*.go','/felix/bpf/jump/*.go','/felix/bpf/legacy/*.go','/felix/bpf/libbpf/*.go','/felix/bpf/maps/*.go','/felix/bpf/nat/*.go','/felix/bpf/perf/*.go','/felix/bpf/polprog/*.go','/felix/bpf/profiling/*.go','/felix/bpf/proxy/*.go','/felix/bpf/qos/*.go','/felix/bpf/routes/*.go','/felix/bpf/state/*.go','/felix/bpf/tc/*.go','/felix/bpf/tc/defs/*.go','/felix/bpf/utils/*.go','/felix/bpf/xdp/*.go','/felix/cachingmap/*.go','/felix/calc/*.go','/felix/cmd/calico-bpf/commands/*.go','/felix/collector/*.go','/felix/collector/flowlog/*.go','/felix/collector/goldmane/*.go','/felix/collector/local/*.go','/felix/collector/types/*.go','/felix/collector/types/counter/*.go','/felix/collector/types/endpoint/*.go','/felix/collector/types/metric/*.go','/felix/collector/types/tuple/*.go','/felix/collector/utils/*.go','/felix/config/*.go','/felix/conntrack/*.go','/felix/daemon/*.go','/felix/dataplane/*.go','/felix/dataplane/common/*.go','/felix/dataplane/external/*.go','/felix/dataplane/inactive/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/dataplane/linux/qos/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/ethtool/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ifacemonitor/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/jitter/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/linkaddrs/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/netlinkshim/handlemgr/*.go','/felix/nfnetlink/*.go','/felix/nfnetlink/nfnl/*.go','/felix/nfnetlink/pkt/*.go','/felix/nftables/*.go','/felix/policysync/*.go','/felix/proto/*.go','/felix/proto/protoconv/*.go','/felix/routerule/*.go','/felix/routetable/*.go','/felix/routetable/ownershippol/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/statusrep/*.go','/felix/stringutils/*.go','/felix/throttle/*.go','/felix/timeshim/*.go','/felix/types/*.go','/felix/usagerep/*.go','/felix/vxlanfdb/*.go','/felix/wireguard/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/**','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/confd/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "node"
      agent:
        machine:
          type: f1-standard-4
          os_image: ubuntu2204
      prologue:
        commands:
          - cd node
      jobs:
        - name: "Node: CI"
          priority:
            # This job is on the critical path so we increase its priority.
            - value: 51
              when: "pull_request =~ '.+'"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: "Node: multi-arch build"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-node.yml','/Makefile','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/internal/pkg/azure/*.go','/cni-plugin/internal/pkg/utils/*.go','/cni-plugin/internal/pkg/utils/cri/*.go','/cni-plugin/pkg/dataplane/*.go','/cni-plugin/pkg/dataplane/grpc/*.go','/cni-plugin/pkg/dataplane/grpc/proto/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/ipamplugin/*.go','/cni-plugin/pkg/k8s/*.go','/cni-plugin/pkg/plugin/*.go','/cni-plugin/pkg/types/*.go','/cni-plugin/pkg/upgrade/*.go','/cni-plugin/pkg/wait/*.go','/confd/etc','/confd/pkg/backends/*.go','/confd/pkg/backends/calico/*.go','/confd/pkg/backends/types/*.go','/confd/pkg/config/*.go','/confd/pkg/log/*.go','/confd/pkg/resource/template/*.go','/confd/pkg/run/*.go','/crypto/pkg/tls/*.go','/felix/aws/*.go','/felix/bpf-apache','/felix/bpf-gpl','/felix/bpf/*.go','/felix/bpf/arp/*.go','/felix/bpf/asm/*.go','/felix/bpf/bpfdefs/*.go','/felix/bpf/bpfmap/*.go','/felix/bpf/conntrack/*.go','/felix/bpf/conntrack/cleanupv1/*.go','/felix/bpf/conntrack/timeouts/*.go','/felix/bpf/conntrack/v2/*.go','/felix/bpf/conntrack/v3/*.go','/felix/bpf/conntrack/v4/*.go','/felix/bpf/consistenthash/*.go','/felix/bpf/counters/*.go','/felix/bpf/events/*.go','/felix/bpf/failsafes/*.go','/felix/bpf/filter/*.go','/felix/bpf/hook/*.go','/felix/bpf/ifstate/*.go','/felix/bpf/ipfrags/*.go','/felix/bpf/ipsets/*.go','/felix/bpf/jump/*.go','/felix/bpf/legacy/*.go','/felix/bpf/libbpf/*.go','/felix/bpf/maps/*.go','/felix/bpf/nat/*.go','/felix/bpf/perf/*.go','/felix/bpf/polprog/*.go','/felix/bpf/profiling/*.go','/felix/bpf/proxy/*.go','/felix/bpf/qos/*.go','/felix/bpf/routes/*.go','/felix/bpf/state/*.go','/felix/bpf/tc/*.go','/felix/bpf/tc/defs/*.go','/felix/bpf/utils/*.go','/felix/bpf/xdp/*.go','/felix/cachingmap/*.go','/felix/calc/*.go','/felix/cmd/calico-bpf/commands/*.go','/felix/collector/*.go','/felix/collector/flowlog/*.go','/felix/collector/goldmane/*.go','/felix/collector/local/*.go','/felix/collector/types/*.go','/felix/collector/types/counter/*.go','/felix/collector/types/endpoint/*.go','/felix/collector/types/metric/*.go','/felix/collector/types/tuple/*.go','/felix/collector/utils/*.go','/felix/config/*.go','/felix/conntrack/*.go','/felix/daemon/*.go','/felix/dataplane/*.go','/felix/dataplane/common/*.go','/felix/dataplane/external/*.go','/felix/dataplane/inactive/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/dataplane/linux/qos/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/ethtool/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ifacemonitor/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/jitter/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/linkaddrs/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/netlinkshim/handlemgr/*.go','/felix/nfnetlink/*.go','/felix/nfnetlink/nfnl/*.go','/felix/nfnetlink/pkt/*.go','/felix/nftables/*.go','/felix/policysync/*.go','/felix/proto/*.go','/felix/proto/protoconv/*.go','/felix/routerule/*.go','/felix/routetable/*.go','/felix/routetable/ownershippol/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/statusrep/*.go','/felix/stringutils/*.go','/felix/throttle/*.go','/felix/timeshim/*.go','/felix/types/*.go','/felix/usagerep/*.go','/felix/vxlanfdb/*.go','/felix/wireguard/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/**','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/confd/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Node: Build"
    task:
      prologue:
        commands:
          - cd node
      jobs:
        - name: "Node: build multi-arch images"
          matrix:
            - env_var: ARCH
              values:
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make image ARCH=$ARCH
        - name: "Node: build Windows archive"
          commands:
            - ../.semaphore/run-and-monitor build-windows-archive.log make build-windows-archive
        - name: "Node: build Windows image"
          commands:
            - ../.semaphore/run-and-monitor build-windows-image.log make image-windows
  - name: "Node: Build - native arm64 runner"
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-node.yml','/Makefile','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/cni-plugin/internal/pkg/azure/*.go','/cni-plugin/internal/pkg/utils/*.go','/cni-plugin/internal/pkg/utils/cri/*.go','/cni-plugin/pkg/dataplane/*.go','/cni-plugin/pkg/dataplane/grpc/*.go','/cni-plugin/pkg/dataplane/grpc/proto/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/ipamplugin/*.go','/cni-plugin/pkg/k8s/*.go','/cni-plugin/pkg/plugin/*.go','/cni-plugin/pkg/types/*.go','/cni-plugin/pkg/upgrade/*.go','/cni-plugin/pkg/wait/*.go','/confd/etc','/confd/pkg/backends/*.go','/confd/pkg/backends/calico/*.go','/confd/pkg/backends/types/*.go','/confd/pkg/config/*.go','/confd/pkg/log/*.go','/confd/pkg/resource/template/*.go','/confd/pkg/run/*.go','/crypto/pkg/tls/*.go','/felix/aws/*.go','/felix/bpf-apache','/felix/bpf-gpl','/felix/bpf/*.go','/felix/bpf/arp/*.go','/felix/bpf/asm/*.go','/felix/bpf/bpfdefs/*.go','/felix/bpf/bpfmap/*.go','/felix/bpf/conntrack/*.go','/felix/bpf/conntrack/cleanupv1/*.go','/felix/bpf/conntrack/timeouts/*.go','/felix/bpf/conntrack/v2/*.go','/felix/bpf/conntrack/v3/*.go','/felix/bpf/conntrack/v4/*.go','/felix/bpf/consistenthash/*.go','/felix/bpf/counters/*.go','/felix/bpf/events/*.go','/felix/bpf/failsafes/*.go','/felix/bpf/filter/*.go','/felix/bpf/hook/*.go','/felix/bpf/ifstate/*.go','/felix/bpf/ipfrags/*.go','/felix/bpf/ipsets/*.go','/felix/bpf/jump/*.go','/felix/bpf/legacy/*.go','/felix/bpf/libbpf/*.go','/felix/bpf/maps/*.go','/felix/bpf/nat/*.go','/felix/bpf/perf/*.go','/felix/bpf/polprog/*.go','/felix/bpf/profiling/*.go','/felix/bpf/proxy/*.go','/felix/bpf/qos/*.go','/felix/bpf/routes/*.go','/felix/bpf/state/*.go','/felix/bpf/tc/*.go','/felix/bpf/tc/defs/*.go','/felix/bpf/utils/*.go','/felix/bpf/xdp/*.go','/felix/cachingmap/*.go','/felix/calc/*.go','/felix/cmd/calico-bpf/commands/*.go','/felix/collector/*.go','/felix/collector/flowlog/*.go','/felix/collector/goldmane/*.go','/felix/collector/local/*.go','/felix/collector/types/*.go','/felix/collector/types/counter/*.go','/felix/collector/types/endpoint/*.go','/felix/collector/types/metric/*.go','/felix/collector/types/tuple/*.go','/felix/collector/utils/*.go','/felix/config/*.go','/felix/conntrack/*.go','/felix/daemon/*.go','/felix/dataplane/*.go','/felix/dataplane/common/*.go','/felix/dataplane/external/*.go','/felix/dataplane/inactive/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/dataplane/linux/qos/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/ethtool/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ifacemonitor/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/jitter/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/linkaddrs/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/netlinkshim/handlemgr/*.go','/felix/nfnetlink/*.go','/felix/nfnetlink/nfnl/*.go','/felix/nfnetlink/pkt/*.go','/felix/nftables/*.go','/felix/policysync/*.go','/felix/proto/*.go','/felix/proto/protoconv/*.go','/felix/routerule/*.go','/felix/routetable/*.go','/felix/routetable/ownershippol/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/statusrep/*.go','/felix/stringutils/*.go','/felix/throttle/*.go','/felix/timeshim/*.go','/felix/types/*.go','/felix/usagerep/*.go','/felix/vxlanfdb/*.go','/felix/wireguard/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/node/**','/pkg/buildinfo/*.go','/pod2daemon/binder/*.go','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/app-policy/**/*_test.go','/cni-plugin/**/*_test.go','/confd/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - "Node: Build"
    task:
      agent:
        machine:
          type: s1-aws-arm64-2
      prologue:
        commands:
          - cd node
      jobs:
        - name: "Node: build arm64 image"
          commands:
            - ../.semaphore/run-and-monitor build-arm64.log make image ARCH=arm64
  - name: "Node: kind-cluster tests"
    run:
      # KinD tests also build and run all the other images.
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-node.yml','/.semaphore/vms/','/Makefile','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/client/clientset_generated/clientset/*.go','/api/pkg/client/clientset_generated/clientset/scheme/*.go','/api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','/api/pkg/client/informers_generated/externalversions/*.go','/api/pkg/client/informers_generated/externalversions/internalinterfaces/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/*.go','/api/pkg/client/informers_generated/externalversions/projectcalico/v3/*.go','/api/pkg/client/listers_generated/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/api/pkg/openapi/*.go','/apiserver/cmd/apiserver/*.go','/apiserver/cmd/apiserver/server/*.go','/apiserver/pkg/apiserver/*.go','/apiserver/pkg/printers/projectcalico/*.go','/apiserver/pkg/rbac/*.go','/apiserver/pkg/registry/projectcalico/authorizer/*.go','/apiserver/pkg/registry/projectcalico/bgpconfiguration/*.go','/apiserver/pkg/registry/projectcalico/bgpfilter/*.go','/apiserver/pkg/registry/projectcalico/bgppeer/*.go','/apiserver/pkg/registry/projectcalico/blockaffinity/*.go','/apiserver/pkg/registry/projectcalico/caliconodestatus/*.go','/apiserver/pkg/registry/projectcalico/clusterinformation/*.go','/apiserver/pkg/registry/projectcalico/felixconfig/*.go','/apiserver/pkg/registry/projectcalico/globalnetworkset/*.go','/apiserver/pkg/registry/projectcalico/globalpolicy/*.go','/apiserver/pkg/registry/projectcalico/hostendpoint/*.go','/apiserver/pkg/registry/projectcalico/ipamconfig/*.go','/apiserver/pkg/registry/projectcalico/ippool/*.go','/apiserver/pkg/registry/projectcalico/ipreservation/*.go','/apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*.go','/apiserver/pkg/registry/projectcalico/networkpolicy/*.go','/apiserver/pkg/registry/projectcalico/networkset/*.go','/apiserver/pkg/registry/projectcalico/profile/*.go','/apiserver/pkg/registry/projectcalico/rest/*.go','/apiserver/pkg/registry/projectcalico/server/*.go','/apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/tier/*.go','/apiserver/pkg/registry/projectcalico/util/*.go','/apiserver/pkg/storage/calico/*.go','/apiserver/pkg/storage/etcd/*.go','/app-policy/checker/*.go','/app-policy/policystore/*.go','/app-policy/types/*.go','/calicoctl/calicoctl/*.go','/calicoctl/calicoctl/commands/*.go','/calicoctl/calicoctl/commands/argutils/*.go','/calicoctl/calicoctl/commands/clientmgr/*.go','/calicoctl/calicoctl/commands/cluster/*.go','/calicoctl/calicoctl/commands/common/*.go','/calicoctl/calicoctl/commands/constants/*.go','/calicoctl/calicoctl/commands/datastore/*.go','/calicoctl/calicoctl/commands/datastore/migrate/*.go','/calicoctl/calicoctl/commands/file/*.go','/calicoctl/calicoctl/commands/ipam/*.go','/calicoctl/calicoctl/commands/node/*.go','/calicoctl/calicoctl/resourcemgr/*.go','/calicoctl/calicoctl/util/*.go','/calicoctl/calicoctl/util/yaml/*.go','/calicoctl/tests/fv/helper/*.go','/cni-plugin/cmd/calico/*.go','/cni-plugin/cmd/install/*.go','/cni-plugin/internal/pkg/azure/*.go','/cni-plugin/internal/pkg/utils/*.go','/cni-plugin/internal/pkg/utils/cri/*.go','/cni-plugin/pkg/dataplane/*.go','/cni-plugin/pkg/dataplane/grpc/*.go','/cni-plugin/pkg/dataplane/grpc/proto/*.go','/cni-plugin/pkg/dataplane/linux/*.go','/cni-plugin/pkg/install/*.go','/cni-plugin/pkg/ipamplugin/*.go','/cni-plugin/pkg/k8s/*.go','/cni-plugin/pkg/plugin/*.go','/cni-plugin/pkg/types/*.go','/cni-plugin/pkg/upgrade/*.go','/cni-plugin/pkg/wait/*.go','/cni-plugin/tests/*.go','/confd/etc','/confd/pkg/backends/*.go','/confd/pkg/backends/calico/*.go','/confd/pkg/backends/types/*.go','/confd/pkg/config/*.go','/confd/pkg/log/*.go','/confd/pkg/resource/template/*.go','/confd/pkg/run/*.go','/crypto/pkg/tls/*.go','/felix/aws/*.go','/felix/bpf-apache','/felix/bpf-gpl','/felix/bpf/*.go','/felix/bpf/arp/*.go','/felix/bpf/asm/*.go','/felix/bpf/bpfdefs/*.go','/felix/bpf/bpfmap/*.go','/felix/bpf/conntrack/*.go','/felix/bpf/conntrack/cleanupv1/*.go','/felix/bpf/conntrack/timeouts/*.go','/felix/bpf/conntrack/v2/*.go','/felix/bpf/conntrack/v3/*.go','/felix/bpf/conntrack/v4/*.go','/felix/bpf/consistenthash/*.go','/felix/bpf/counters/*.go','/felix/bpf/events/*.go','/felix/bpf/failsafes/*.go','/felix/bpf/filter/*.go','/felix/bpf/hook/*.go','/felix/bpf/ifstate/*.go','/felix/bpf/ipfrags/*.go','/felix/bpf/ipsets/*.go','/felix/bpf/jump/*.go','/felix/bpf/legacy/*.go','/felix/bpf/libbpf/*.go','/felix/bpf/maps/*.go','/felix/bpf/nat/*.go','/felix/bpf/perf/*.go','/felix/bpf/polprog/*.go','/felix/bpf/profiling/*.go','/felix/bpf/proxy/*.go','/felix/bpf/qos/*.go','/felix/bpf/routes/*.go','/felix/bpf/state/*.go','/felix/bpf/tc/*.go','/felix/bpf/tc/defs/*.go','/felix/bpf/utils/*.go','/felix/bpf/xdp/*.go','/felix/cachingmap/*.go','/felix/calc/*.go','/felix/cmd/calico-bpf/commands/*.go','/felix/collector/*.go','/felix/collector/flowlog/*.go','/felix/collector/goldmane/*.go','/felix/collector/local/*.go','/felix/collector/types/*.go','/felix/collector/types/counter/*.go','/felix/collector/types/endpoint/*.go','/felix/collector/types/metric/*.go','/felix/collector/types/tuple/*.go','/felix/collector/utils/*.go','/felix/config/*.go','/felix/conntrack/*.go','/felix/daemon/*.go','/felix/dataplane/*.go','/felix/dataplane/common/*.go','/felix/dataplane/external/*.go','/felix/dataplane/inactive/*.go','/felix/dataplane/ipsets/*.go','/felix/dataplane/linux/*.go','/felix/dataplane/linux/dataplanedefs/*.go','/felix/dataplane/linux/qos/*.go','/felix/deltatracker/*.go','/felix/dispatcher/*.go','/felix/environment/*.go','/felix/ethtool/*.go','/felix/generictables/*.go','/felix/hashutils/*.go','/felix/idalloc/*.go','/felix/ifacemonitor/*.go','/felix/ip/*.go','/felix/ipsets/*.go','/felix/iptables/*.go','/felix/iptables/cmdshim/*.go','/felix/jitter/*.go','/felix/k8sutils/*.go','/felix/labelindex/*.go','/felix/labelindex/ipsetmember/*.go','/felix/labelindex/labelnamevalueindex/*.go','/felix/labelindex/labelrestrictionindex/*.go','/felix/linkaddrs/*.go','/felix/logutils/*.go','/felix/markbits/*.go','/felix/multidict/*.go','/felix/netlinkshim/*.go','/felix/netlinkshim/handlemgr/*.go','/felix/nfnetlink/*.go','/felix/nfnetlink/nfnl/*.go','/felix/nfnetlink/pkt/*.go','/felix/nftables/*.go','/felix/policysync/*.go','/felix/proto/*.go','/felix/proto/protoconv/*.go','/felix/routerule/*.go','/felix/routetable/*.go','/felix/routetable/ownershippol/*.go','/felix/rules/*.go','/felix/serviceindex/*.go','/felix/statusrep/*.go','/felix/stringutils/*.go','/felix/throttle/*.go','/felix/timeshim/*.go','/felix/types/*.go','/felix/usagerep/*.go','/felix/vxlanfdb/*.go','/felix/wireguard/*.go','/goldmane/cmd/*.go','/goldmane/cmd/flowgen/*.go','/goldmane/cmd/health/*.go','/goldmane/cmd/stream/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/daemon/*.go','/goldmane/pkg/emitter/*.go','/goldmane/pkg/flowgen/*.go','/goldmane/pkg/goldmane/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/internal/utils/*.go','/goldmane/pkg/server/*.go','/goldmane/pkg/storage/*.go','/goldmane/pkg/stream/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/kube-controllers/cmd/check-status/*.go','/kube-controllers/cmd/kube-controllers/*.go','/kube-controllers/cmd/wrapper/*.go','/kube-controllers/pkg/cache/*.go','/kube-controllers/pkg/config/*.go','/kube-controllers/pkg/controllers/controller/*.go','/kube-controllers/pkg/controllers/flannelmigration/*.go','/kube-controllers/pkg/controllers/ippool/*.go','/kube-controllers/pkg/controllers/loadbalancer/*.go','/kube-controllers/pkg/controllers/namespace/*.go','/kube-controllers/pkg/controllers/networkpolicy/*.go','/kube-controllers/pkg/controllers/node/*.go','/kube-controllers/pkg/controllers/pod/*.go','/kube-controllers/pkg/controllers/serviceaccount/*.go','/kube-controllers/pkg/controllers/utils/*.go','/kube-controllers/pkg/converter/*.go','/kube-controllers/pkg/status/*.go','/lib.Makefile','/lib/httpmachinery/pkg/apiutil/*.go','/lib/httpmachinery/pkg/codec/*.go','/lib/httpmachinery/pkg/context/*.go','/lib/httpmachinery/pkg/header/*.go','/lib/httpmachinery/pkg/server/*.go','/lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','/lib/std/chanutil/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/config/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/consistenthash/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/dispatcher/*.go','/libcalico-go/lib/epstatusfile/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/ipam/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/netlinkutils/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/packedmap/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/node/**','/node/pkg/cni/*.go','/pkg/buildinfo/*.go','/pkg/cmdwrapper/*.go','/pod2daemon/binder/*.go','/pod2daemon/csidriver/*.go','/pod2daemon/csidriver/driver/*.go','/pod2daemon/flexvol/*.go','/pod2daemon/flexvol/creds/*.go','/pod2daemon/nodeagent/*.go','/pod2daemon/proto/*.go','/pod2daemon/workloadapi/*.go','/typha/cmd/calico-typha/*.go','/typha/cmd/typha-client/*.go','/typha/pkg/calc/*.go','/typha/pkg/config/*.go','/typha/pkg/daemon/*.go','/typha/pkg/discovery/*.go','/typha/pkg/jitter/*.go','/typha/pkg/k8s/*.go','/typha/pkg/logutils/*.go','/typha/pkg/promutils/*.go','/typha/pkg/snapcache/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncclientutils/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/syncserver/*.go','/typha/pkg/tlsutils/*.go','/whisker','/whisker-backend/cmd/*.go','/whisker-backend/cmd/app/*.go','/whisker-backend/pkg/apis/v1/*.go','/whisker-backend/pkg/config/*.go','/whisker-backend/pkg/handlers/v1/*.go','apiserver/**/*Dockerfile*','apiserver/Makefile','apiserver/deps.txt','calicoctl/**/*Dockerfile*','calicoctl/Makefile','calicoctl/deps.txt','cni-plugin/**/*Dockerfile*','cni-plugin/Makefile','cni-plugin/deps.txt','goldmane/**/*Dockerfile*','goldmane/Makefile','goldmane/deps.txt','kube-controllers/**/*Dockerfile*','kube-controllers/Makefile','kube-controllers/deps.txt','pod2daemon/**/*Dockerfile*','pod2daemon/Makefile','pod2daemon/deps.txt','typha/**/*Dockerfile*','typha/Makefile','typha/deps.txt','whisker-backend/**/*Dockerfile*','whisker-backend/Makefile','whisker-backend/deps.txt','whisker/**/*Dockerfile*','whisker/Makefile','whisker/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/apiserver/**/*_test.go','/app-policy/**/*_test.go','/calicoctl/**/*_test.go','/cni-plugin/**/*_test.go','/confd/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/kube-controllers/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/pod2daemon/**/*_test.go','/typha/**/*_test.go','/whisker-backend/**/*_test.go']})"
    dependencies:
      - "Prerequisites"
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "node"
        - name: CI_GROUP_LABEL
          value: "node"
        - name: CI_JOB_LABEL
          value: "kind-cluster-tests"
      prologue:
        commands:
          # Set up access to GCP buckets.
          - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
          - gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          - gcloud config set project unique-caldron-775
          - cd node
          - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
          - export ZONE=europe-west3-c
          - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-kind-
          - echo VM_PREFIX=${VM_PREFIX}
          - export COMPONENT=node
          - export VM_DISK_SIZE=80GB
          - mkdir artifacts
          - ./.semaphore/cache-test-artifacts
      jobs:
        - name: "Node: kind-cluster tests"
          execution_time_limit:
            minutes: 120
          commands:
            - ../.semaphore/vms/run-tests-on-vms ${VM_PREFIX}
      epilogue:
        always:
          commands:
            - '../.semaphore/vms/publish-reports "Node: KinD STs"'
            - ../.semaphore/vms/clean-up-vms ${VM_PREFIX}
      secrets:
        - name: google-service-account-for-gce
  - name: pod2daemon
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-pod2daemon.yml','/hack/test/certs/','/lib.Makefile','/libcalico-go/lib/logutils/*.go','/metadata.mk','/pod2daemon/**'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/libcalico-go/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd pod2daemon
      jobs:
        - name: "pod2daemon: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
            - 'test-results publish ./report/*.xml --name "pod2daemon: UT" || true'
  - name: "Tools (hack directory)"
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/hack/', '/api/', '/libcalico-go/'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd hack
      jobs:
        - name: "Tools (hack directory): CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
  - name: Typha
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-typha.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/apis/v1/*.go','/libcalico-go/lib/apis/v1/unversioned/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/syncersv1/bgpsyncer/*.go','/libcalico-go/lib/backend/syncersv1/dedupebuffer/*.go','/libcalico-go/lib/backend/syncersv1/felixsyncer/*.go','/libcalico-go/lib/backend/syncersv1/nodestatussyncer/*.go','/libcalico-go/lib/backend/syncersv1/tunnelipsyncer/*.go','/libcalico-go/lib/backend/syncersv1/updateprocessors/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/debugserver/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/health/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/metricsserver/*.go','/libcalico-go/lib/multireadbuf/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/prometheus/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/scope/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v1/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/libcalico-go/lib/writelogger/*.go','/metadata.mk','/pkg/buildinfo/*.go','/typha/**'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "typha"
      prologue:
        commands:
          - cd typha
      jobs:
        - name: "Typha: UT and FV tests"
          commands:
            - export TEST_SUITE_PREFIX="calico/base"
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "Typha: FV tests on UBI-minimal"
          commands:
            - 'export TEST_SUITE_PREFIX="UBI-minimal"'
            - ../.semaphore/run-and-monitor make-fv-ubi.log make clean image fv
          env_vars:
            - name: USE_UBI_AS_CALICO_BASE
              value: '1'
      epilogue:
        always:
          commands:
            - 'test-results publish --ignore-missing ./report/*.xml ../felix/report/*.xml --suite-prefix="$TEST_SUITE_PREFIX" --name "Typha" || true'
  - name: webhooks
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-webhooks.yml','/api/examples/list-gnp/*.go','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/client/clientset_generated/clientset/*.go','/api/pkg/client/clientset_generated/clientset/scheme/*.go','/api/pkg/client/clientset_generated/clientset/typed/projectcalico/v3/*.go','/api/pkg/defaults/*.go','/api/pkg/lib/numorstring/*.go','/api/pkg/openapi/*.go','/apiserver/cmd/apiserver/*.go','/apiserver/cmd/apiserver/server/*.go','/apiserver/pkg/apiserver/*.go','/apiserver/pkg/printers/projectcalico/*.go','/apiserver/pkg/rbac/*.go','/apiserver/pkg/registry/projectcalico/authorizer/*.go','/apiserver/pkg/registry/projectcalico/bgpconfiguration/*.go','/apiserver/pkg/registry/projectcalico/bgpfilter/*.go','/apiserver/pkg/registry/projectcalico/bgppeer/*.go','/apiserver/pkg/registry/projectcalico/blockaffinity/*.go','/apiserver/pkg/registry/projectcalico/caliconodestatus/*.go','/apiserver/pkg/registry/projectcalico/clusterinformation/*.go','/apiserver/pkg/registry/projectcalico/felixconfig/*.go','/apiserver/pkg/registry/projectcalico/globalnetworkset/*.go','/apiserver/pkg/registry/projectcalico/globalpolicy/*.go','/apiserver/pkg/registry/projectcalico/hostendpoint/*.go','/apiserver/pkg/registry/projectcalico/ipamconfig/*.go','/apiserver/pkg/registry/projectcalico/ippool/*.go','/apiserver/pkg/registry/projectcalico/ipreservation/*.go','/apiserver/pkg/registry/projectcalico/kubecontrollersconfig/*.go','/apiserver/pkg/registry/projectcalico/networkpolicy/*.go','/apiserver/pkg/registry/projectcalico/networkset/*.go','/apiserver/pkg/registry/projectcalico/profile/*.go','/apiserver/pkg/registry/projectcalico/rest/*.go','/apiserver/pkg/registry/projectcalico/server/*.go','/apiserver/pkg/registry/projectcalico/stagedglobalnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagedkubernetesnetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/stagednetworkpolicy/*.go','/apiserver/pkg/registry/projectcalico/tier/*.go','/apiserver/pkg/registry/projectcalico/util/*.go','/apiserver/pkg/storage/calico/*.go','/apiserver/pkg/storage/etcd/*.go','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apiconfig/*.go','/libcalico-go/lib/apis/crd.projectcalico.org/v1/scheme/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/etcdv3/*.go','/libcalico-go/lib/backend/k8s/*.go','/libcalico-go/lib/backend/k8s/conversion/*.go','/libcalico-go/lib/backend/k8s/resources/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/backend/watchersyncer/*.go','/libcalico-go/lib/clientv3/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/hash/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/options/*.go','/libcalico-go/lib/resources/*.go','/libcalico-go/lib/selector/*.go','/libcalico-go/lib/selector/parser/*.go','/libcalico-go/lib/selector/tokenizer/*.go','/libcalico-go/lib/set/*.go','/libcalico-go/lib/validator/v3/*.go','/libcalico-go/lib/watch/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/pkg/buildinfo/*.go','/webhooks/**','api/**/*Dockerfile*','api/Makefile','api/deps.txt','apiserver/**/*Dockerfile*','apiserver/Makefile','apiserver/deps.txt'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/apiserver/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "webhooks"
      prologue:
        commands:
          - cd webhooks
      jobs:
        - name: "webhooks: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: Whisker backend
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/20-whisker-backend.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/felix/proto/*.go','/felix/types/*.go','/goldmane/pkg/client/*.go','/goldmane/pkg/internal/flowcache/*.go','/goldmane/pkg/types/*.go','/goldmane/proto/*.go','/hack/test/certs/','/lib.Makefile','/lib/httpmachinery/pkg/apiutil/*.go','/lib/httpmachinery/pkg/codec/*.go','/lib/httpmachinery/pkg/context/*.go','/lib/httpmachinery/pkg/header/*.go','/lib/httpmachinery/pkg/server/*.go','/lib/httpmachinery/pkg/server/adaptors/gorilla/*.go','/lib/std/cryptoutils/*.go','/lib/std/testutils/json/*.go','/lib/std/time/*.go','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/metadata.mk','/whisker-backend/**'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/felix/**/*_test.go','/goldmane/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd whisker-backend
      jobs:
        - name: "Whisker backend: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
        - name: "Whisker backend: build multi-arch"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: Whisker
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/whisker/'], {pipeline_file: 'ignore', exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "whisker"
      prologue:
        commands:
          - cd whisker
      jobs:
        - name: "Whisker: CI"
          commands:
            - ../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
        - name: "Whisker: build multi-arch images"
          matrix:
            - env_var: ARCH
              values:
                - arm64
                - ppc64le
                - s390x
          commands:
            - ../.semaphore/run-and-monitor image-$ARCH.log make build ARCH=$ARCH
  - name: key-cert-provisioner
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/30-key-cert-provisioner.yml','/hack/test/certs/','/key-cert-provisioner/**','/lib.Makefile','/metadata.mk'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "key-cert-provisioner"
      prologue:
        commands:
          - cd key-cert-provisioner
      jobs:
        - name: "key-cert-provisioner: CI"
          commands:
            - ../.semaphore/run-and-monitor ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: "OpenStack integration (Caracal)"
    run:
      when: "false or change_in(['/metadata.mk', '/lib.Makefile', '/networking-calico/', '/.semaphore/semaphore.yml.d/blocks/40-openstack.yml'], {pipeline_file: 'ignore'})"
    dependencies:
      - Prerequisites
    task:
      agent:
        machine:
          type: f1-standard-2
          os_image: ubuntu2204
      prologue:
        commands:
          - cd networking-calico
      jobs:
        - name: "OpenStack: Unit and FV tests (tox) on Caracal"
          commands:
            - ../.semaphore/run-and-monitor tox.log make tox-caracal
        - name: "OpenStack: Mainline ST (DevStack + Tempest) on Caracal"
          commands:
            # For some reason python3-wrapt is pre-installed on a Semaphore ubuntu2004 node, but with
            # a version (1.11.2) that is different from the version that OpenStack needs (1.13.3), and
            # this was causing the DevStack setup to fail, because pip doesn't know how to uninstall
            # or replace the existing version.  Happily we do know that, so let's do it upfront here.
            - sudo apt-get remove -y python3-wrapt || true
            # Set NC_PLUGIN_REPO and NC_PLUGIN_REF so that DevStack will use the networking-calico
            # code from the current PR or branch.  The following checkout is to make sure of having a
            # local ref that we can specify.
            - git checkout -b devstack-test
            - export NC_PLUGIN_REPO=$(dirname $(pwd))
            - export NC_PLUGIN_REF=$(git rev-parse --abbrev-ref HEAD)
            - sudo git config --system --add safe.directory ${NC_PLUGIN_REPO}/.git
            # The BIRD config in our DevStack setup is thoroughly broken and generates loads of errors
            # in the log.  But we don't need it for a single node setup anyway, so let's disable it.
            - export CALICO_BGP_MODE=none
            - TEMPEST=true OPENSTACK_RELEASE=caracal ./devstack/bootstrap.sh
      epilogue:
        always:
          commands:
            - mkdir logs
            - sudo journalctl > logs/journalctl.txt
            - artifact push job logs
  - name: Mock node
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/60-mock-node.yml','/api/pkg/apis/projectcalico/v3/*.go','/api/pkg/lib/numorstring/*.go','/crypto/pkg/tls/*.go','/hack/test/certs/','/lib.Makefile','/lib/std/uniquelabels/*.go','/lib/std/uniquestr/*.go','/libcalico-go/lib/apis/internalapi/*.go','/libcalico-go/lib/backend/api/*.go','/libcalico-go/lib/backend/encap/*.go','/libcalico-go/lib/backend/model/*.go','/libcalico-go/lib/errors/*.go','/libcalico-go/lib/json/*.go','/libcalico-go/lib/logutils/*.go','/libcalico-go/lib/names/*.go','/libcalico-go/lib/namespace/*.go','/libcalico-go/lib/net/*.go','/libcalico-go/lib/readlogger/*.go','/libcalico-go/lib/winutils/*.go','/metadata.mk','/pkg/buildinfo/*.go','/test-tools/mocknode/**','/typha/pkg/discovery/*.go','/typha/pkg/syncclient/*.go','/typha/pkg/syncproto/*.go','/typha/pkg/tlsutils/*.go'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/api/**/*_test.go','/crypto/**/*_test.go','/lib/**/*_test.go','/libcalico-go/**/*_test.go','/pkg/**/*_test.go','/typha/**/*_test.go']})"
    dependencies:
      - Prerequisites
    task:
      env_vars:
        - name: BUILD_CACHE_GROUP
          value: "mock-node"
      prologue:
        commands:
          - cd test-tools/mocknode
      jobs:
        - name: "Mock node: CI"
          commands:
            - ../../.semaphore/run-and-monitor make-ci.log make ci
          env_vars:
            - name: STORE_BUILD_CACHE
              value: "true"
  - name: Release tooling
    run:
      when: "change_in(['/.semaphore/semaphore.yml.d/01-preamble.yml','/.semaphore/semaphore.yml.d/02-global_job_config.yml','/.semaphore/semaphore.yml.d/03-promotions.yml','/.semaphore/semaphore.yml.d/09-blocks.yml','/.semaphore/semaphore.yml.d/99-after_pipeline.yml','/.semaphore/semaphore.yml.d/blocks/90-release.yml','/hack/test/certs/','/lib.Makefile','/libcalico-go/lib/logutils/*.go','/metadata.mk','/release/**'], {pipeline_file: 'ignore', exclude: ['/**/*.md','/**/.gitignore','/**/AUTHORS*','/**/CONTRIBUTING*','/**/DEVELOPER_GUIDE*','/**/LICENSE*','/**/README*','/**/SECURITY.md','/libcalico-go/**/*_test.go']})"
    execution_time_limit:
      minutes: 30
    dependencies:
      - Prerequisites
    task:
      prologue:
        commands:
          - cd release
      jobs:
        - name: "Release tooling: CI"
          commands:
            - ../.semaphore/run-and-monitor release-ci.log make ci
            - 'test-results publish --name "Release tool: UT" ./report/*.xml || true'
        - name: "Release tooling: build"
          commands:
            - ../.semaphore/run-and-monitor release-build.log make build
            - cache store release-${SEMAPHORE_GIT_SHA} bin
after_pipeline:
  task:
    jobs:
      - name: Reports
        commands:
          - test-results gen-pipeline-report --force
