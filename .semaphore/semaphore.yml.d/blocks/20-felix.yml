- name: "Felix: Build"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
        - gcloud config set project unique-caldron-775
        - gcloud auth activate-service-account --key-file=$HOME/secrets/secret.google-service-account-key.json
    secrets:
      - name: google-service-account-for-gce
    jobs:
      - name: "Felix: Build and run UT, k8sfv"
        execution_time_limit:
          minutes: 60
        commands:
          - make build image fv-prereqs
          - ./.semaphore/cache-test-artifacts
          - ../.semaphore/run-and-monitor ut.log make ut
          - ../.semaphore/run-and-monitor k8sfv-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=true
          - ../.semaphore/run-and-monitor k8sfv-no-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=false
      - name: "Felix: Static checks"
        execution_time_limit:
          minutes: 60
        commands:
          - ../.semaphore/run-and-monitor static-checks.log make static-checks
    epilogue:
      always:
        commands:
          - 'test-results compile --name "Felix: FV" ./report/*k8sfv*.xml ./report/k8sfv_sem.json || true'
          - rm -f ./report/*k8sfv*.xml
          - 'test-results compile --name "Felix: UT" ./report/*.xml ./report/ut_sem.json || true'
          - test-results combine report/*_sem.json report/report.json
          - artifact push job report/report.json -d test-results/junit.json || true
          - artifact push workflow report/report.json -d test-results/${SEMAPHORE_PIPELINE_ID}/${SEMAPHORE_JOB_ID}.json || true
- name: "Felix: multi-arch build"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - "Felix: Build"
  task:
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
    jobs:
      - name: "Felix: build multi-arch binaries"
        matrix:
          - env_var: ARCH
            values:
              - ppc64le
              - s390x
        commands:
          # Only building the code, not the image here because the felix image is now only used for FV tests, which
          # only run on AMD64 at the moment.
          - ../.semaphore/run-and-monitor build-$ARCH.log make build ARCH=$ARCH
- name: "Felix: Build - native arm64 runner"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - "Felix: Build"
  task:
    agent:
      machine:
        type: s1-aws-arm64-2
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
    jobs:
      - name: "Felix: build arm64 binaries"
        commands:
          - ../.semaphore/run-and-monitor build-arm64.log make build ARCH=arm64
- name: "Felix: Build Windows binaries"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - Prerequisites
  task:
    jobs:
      - name: "Felix: Build Windows binaries"
        commands:
          - cd felix
          - make bin/calico-felix.exe fv/win-fv.exe
- name: "Felix: Windows FV capz"
  run:
    when: "false"
  dependencies: ["Felix: Build Windows binaries"]
  task:
    secrets:
      - name: banzai-secrets
      - name: private-repo
    prologue:
      commands:
        - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
        - export REPORT_DIR=/home/semaphore/report
        - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
        - export AZURE_TENANT_ID=$AZ_TENANT_ID
        - export AZURE_CLIENT_ID=$AZ_SP_ID
        - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
        - export AZURE_SUBSCRIPTION_ID_B64="$(echo -n "$AZ_SUBSCRIPTION_ID" | base64 | tr -d '\n')"
        - export AZURE_TENANT_ID_B64="$(echo -n "$AZ_TENANT_ID" | base64 | tr -d '\n')"
        - export AZURE_CLIENT_ID_B64="$(echo -n "$AZ_SP_ID" | base64 | tr -d '\n')"
        - export AZURE_CLIENT_SECRET_B64="$(echo -n "$AZ_SP_PASSWORD" | base64 | tr -d '\n')"
        - cd felix
    epilogue:
      always:
        commands:
          - artifact push job ${REPORT_DIR} --destination test-results || true
    env_vars:
      - name: FV_PROVISIONER
        value: "capz"
      - name: FV_TYPE
        value: "calico-felix"
      - name: SEMAPHORE_ARTIFACT_EXPIRY
        value: 2w
      - name: CONTAINERD_VERSION
        value: 1.7.22
    jobs:
      - name: "Felix: Windows FV - CAPZ"
        commands:
          - ./.semaphore/run-win-fv
- name: "Felix: iptables tests on Ubuntu 22.04"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: iptables tests on Ubuntu 22.04"
        execution_time_limit:
          minutes: 180
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "22.04-ipt"
        commands:
          - source felix/.semaphore/fv-prologue
          - export NUM_FV_BATCHES=16
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: nftables tests on Ubuntu 22.04"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: nftables tests on Ubuntu 22.04"
        execution_time_limit:
          minutes: 180
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "22.04-nft"
        commands:
          - source felix/.semaphore/fv-prologue
          - export NUM_FV_BATCHES=16
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests on Ubuntu 24.04 (iptables)"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: BPF tests on Ubuntu 24.04"
        execution_time_limit:
          minutes: 180
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "bpf-24.04-ipt-with-ut"
        commands:
          - source felix/.semaphore/fv-prologue
          - export NUM_FV_BATCHES=60
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
        execution_time_limit:
          minutes: 180
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "bpf-22.04-nft-with-ut"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
        commands:
          - source felix/.semaphore/fv-prologue
          # Limit to BPF conntrack tests to reduce overall runtime.
          - export FV_FOCUS='_BPF_.*ct=true'
          - export NUM_FV_BATCHES=10
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF program-loading check on 25.04 (nftables)"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: BPF program-loading check on 25.04"
        execution_time_limit:
          minutes: 60
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "bpf-25.04-nft-no-fv-with-ut"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
        commands:
          - source felix/.semaphore/fv-prologue
          # Only run the UT that checks that the precompiled BPF binaries are loadable.
          - export UT_FOCUS="TestPrecompiledBinariesAreLoadable"
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests on Ubuntu 25.04 with jitharden=2 (nftables)"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - "Felix: Build"
  task:
    jobs:
      - name: "Felix: BPF tests on Ubuntu 25.04 with jitharden=2"
        execution_time_limit:
          minutes: 180
        env_vars:
          - name: FELIX_TEST_GROUP
            value: "bpf-25.04-nft-with-ut-jitharden"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
        commands:
          - source felix/.semaphore/fv-prologue
          # Limit to BPF TCP+conntrack tests to reduce overall runtime.
          - export FV_FOCUS='_BPF_.*tcp.*ct=true'
          - export NUM_FV_BATCHES=16
          - .semaphore/vms/create-test-vms ${VM_PREFIX}
          - .semaphore/vms/run-on-vms ${VM_PREFIX} "sudo sysctl -w net.core.bpf_jit_harden=2"
          - .semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - source felix/.semaphore/fv-epilogue
    secrets:
      - name: google-service-account-for-gce
