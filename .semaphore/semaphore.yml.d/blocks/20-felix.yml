- name: "Felix: Build"
  run:
    when: "${CHANGE_IN(felix,typha)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
    jobs:
      - name: "Felix: Build and run UT, k8sfv"
        execution_time_limit:
          minutes: 60
        commands:
          - make build image fv-prereqs
          - "cache store bin-${SEMAPHORE_GIT_SHA} bin"
          - "cache store fv.test-${SEMAPHORE_GIT_SHA} fv/fv.test"
          - cache store go-pkg-cache .go-pkg-cache
          - "cache store go-mod-cache ${HOME}/go/pkg/mod/cache"
          - docker save -o /tmp/calico-felix-test.tar calico/felix-test:latest-amd64
          - "cache store felix-image-${SEMAPHORE_GIT_SHA} /tmp/calico-felix-test.tar"
          - docker save -o /tmp/felixtest-typha.tar felix-test/typha:latest-amd64
          - "cache store felixtest-typha-image-${SEMAPHORE_GIT_SHA} /tmp/felixtest-typha.tar"
          - ../.semaphore/run-and-monitor ut.log make ut
          - ../.semaphore/run-and-monitor k8sfv-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=true
          - ../.semaphore/run-and-monitor k8sfv-no-typha.log make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=false
      - name: "Felix: Static checks"
        execution_time_limit:
          minutes: 60
        commands:
          - ../.semaphore/run-and-monitor static-checks.log make static-checks
    epilogue:
      always:
        commands:
          - 'test-results compile --name "Felix: FV" ./report/*k8sfv*.xml ./report/k8sfv_sem.json || true'
          - rm -f ./report/*k8sfv*.xml
          - 'test-results compile --name "Felix: UT" ./report/*.xml ./report/ut_sem.json || true'
          - test-results combine report/*_sem.json report/report.json
          - artifact push job report/report.json -d test-results/junit.json || true
          - artifact push workflow report/report.json -d test-results/${SEMAPHORE_PIPELINE_ID}/${SEMAPHORE_JOB_ID}.json || true
- name: "Felix: multi-arch build"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - "Felix: Build"
  task:
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
    jobs:
      - name: "Felix: build multi-arch binaries"
        matrix:
          - env_var: ARCH
            values:
              - ppc64le
              - s390x
        commands:
          # Only building the code, not the image here because the felix image is now only used for FV tests, which
          # only run on AMD64 at the moment.
          - ../.semaphore/run-and-monitor build-$ARCH.log make build ARCH=$ARCH
- name: "Felix: Build - native arm64 runner"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - "Felix: Build"
  task:
    agent:
      machine:
        type: s1-aws-arm64-2
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
    jobs:
      - name: "Felix: build arm64 binaries"
        commands:
          - ../.semaphore/run-and-monitor build-arm64.log make build ARCH=arm64
- name: "Felix: Build Windows binaries"
  run:
    when: "${CHANGE_IN(felix)}"
  dependencies:
    - Prerequisites
  task:
    jobs:
      - name: "Felix: Build Windows binaries"
        commands:
          - cd felix
          - make bin/calico-felix.exe fv/win-fv.exe
- name: "Felix: Windows FV capz"
  run:
    when: "false"
  dependencies: ["Felix: Build Windows binaries"]
  task:
    secrets:
      - name: banzai-secrets
      - name: private-repo
    prologue:
      commands:
        - az login --service-principal -u "${AZ_SP_ID}" -p "${AZ_SP_PASSWORD}" --tenant "${AZ_TENANT_ID}" --output none
        - export REPORT_DIR=/home/semaphore/report
        - export AZURE_SUBSCRIPTION_ID=$AZ_SUBSCRIPTION_ID
        - export AZURE_TENANT_ID=$AZ_TENANT_ID
        - export AZURE_CLIENT_ID=$AZ_SP_ID
        - export AZURE_CLIENT_SECRET=$AZ_SP_PASSWORD
        - export AZURE_SUBSCRIPTION_ID_B64="$(echo -n "$AZ_SUBSCRIPTION_ID" | base64 | tr -d '\n')"
        - export AZURE_TENANT_ID_B64="$(echo -n "$AZ_TENANT_ID" | base64 | tr -d '\n')"
        - export AZURE_CLIENT_ID_B64="$(echo -n "$AZ_SP_ID" | base64 | tr -d '\n')"
        - export AZURE_CLIENT_SECRET_B64="$(echo -n "$AZ_SP_PASSWORD" | base64 | tr -d '\n')"
        - cd felix
    epilogue:
      always:
        commands:
          - artifact push job ${REPORT_DIR} --destination test-results || true
    env_vars:
      - name: FV_PROVISIONER
        value: "capz"
      - name: FV_TYPE
        value: "calico-felix"
      - name: SEMAPHORE_ARTIFACT_EXPIRY
        value: 2w
      - name: CONTAINERD_VERSION
        value: 1.7.22
    jobs:
      - name: "Felix: Windows FV - CAPZ"
        commands:
          - ./.semaphore/run-win-fv
- name: "Felix: FV Tests"
  run:
    when: "${CHANGE_IN(felix,typha)}"
  dependencies:
    - "Felix: Build"
  task:
    agent:
      machine:
        type: f1-standard-4
        os_image: ubuntu2204
    prologue:
      commands:
        - cd felix
        - cache restore go-pkg-cache
        - cache restore go-mod-cache
        - "cache restore bin-${SEMAPHORE_GIT_SHA}"
        - "cache restore fv.test-${SEMAPHORE_GIT_SHA}"
        - "cache restore felix-image-${SEMAPHORE_GIT_SHA}"
        - "cache restore felixtest-typha-image-${SEMAPHORE_GIT_SHA}"
        - |-
          if [ -s /etc/docker/daemon.json  ]; then
          sudo sed -i '$d' /etc/docker/daemon.json && sudo sed -i '$s/$/,/' /etc/docker/daemon.json && sudo bash -c ' cat >> /etc/docker/daemon.json << EOF
            "ipv6": true,
            "fixed-cidr-v6": "2001:db8:1::/64"
          }
          EOF
          ' ; else sudo bash -c ' cat > /etc/docker/daemon.json << EOF
          {
            "ipv6": true,
            "fixed-cidr-v6": "2001:db8:1::/64"
          }
          EOF
          ' ; fi
        - sudo systemctl restart docker
        # Load in the docker images pre-built by the build job.
        - docker load -i /tmp/calico-felix-test.tar
        - docker tag calico/felix-test:latest-amd64 felix-test:latest-amd64
        - rm /tmp/calico-felix-test.tar
        - docker load -i /tmp/felixtest-typha.tar
        - docker tag felix-test/typha:latest-amd64 typha:latest-amd64
        - rm /tmp/felixtest-typha.tar
        # Pre-loading the IPIP module prevents a flake where the first felix to use IPIP loads the module and
        # routing in that first felix container chooses different source IPs than the tests are expecting.
        - sudo modprobe ipip
    jobs:
      - name: "Felix: FV Tests (iptables)"
        execution_time_limit:
          minutes: 120
        commands:
          - make check-wireguard
          - ../.semaphore/run-and-monitor fv-${SEMAPHORE_JOB_INDEX}.log make fv-no-prereqs FV_BATCHES_TO_RUN="${SEMAPHORE_JOB_INDEX}" FV_NUM_BATCHES=${SEMAPHORE_JOB_COUNT}
        parallelism: 3
      - name: "Felix: FV Tests (nftables)"
        execution_time_limit:
          minutes: 120
        env_vars:
          - name: FELIX_FV_NFTABLES
            value: "Enabled"
        commands:
          - make check-wireguard
          - ../.semaphore/run-and-monitor fv-${SEMAPHORE_JOB_INDEX}.log make fv-no-prereqs FV_BATCHES_TO_RUN="${SEMAPHORE_JOB_INDEX}" FV_NUM_BATCHES=${SEMAPHORE_JOB_COUNT}
        parallelism: 3
    epilogue:
      always:
        commands:
          # We're still in the felix directory here.
          - 'test-results publish report/*.xml --name "Felix: FV" || true'
          - ../.semaphore/collect-artifacts
- name: "Felix: BPF tests on Ubuntu 24.04"
  run:
    when: "${CHANGE_IN(felix,typha)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - cd felix
        - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
        - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
        - export ZONE=europe-west3-c
        - export JOB_TAG=felix-ipt
        - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-${JOB_TAG}-
        - echo VM_PREFIX=${VM_PREFIX}
        - export COMPONENT=felix
        - export NUM_FV_BATCHES=8
        - export RUN_UT=true
        - export FV_FOCUS=BPF-SAFE
        - export IMAGE=ubuntu-2404-noble-amd64-v20250502a
        - export UBUNTU_VERSION=noble
        - export DOCKER_VERSION=5:27.5.1-1~ubuntu.24.04~noble
        - mkdir artifacts
        - ../.semaphore/vms/create-test-vms ${VM_PREFIX}
    jobs:
      - name: "Felix: BPF tests on Ubuntu 24.04"
        execution_time_limit:
          minutes: 180
        commands:
          - ../.semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - ../.semaphore/vms/collect-artifacts-from-vms ${VM_PREFIX}
          - '../.semaphore/vms/publish-reports "BPF/Ubuntu-24.04/nftables"'
          - ../.semaphore/vms/clean-up-vms ${VM_PREFIX}
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - cd felix
        - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
        - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
        - export ZONE=europe-west3-c
        - export JOB_TAG=felix-nft
        - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-${JOB_TAG}-
        - echo VM_PREFIX=${VM_PREFIX}
        - export COMPONENT=felix
        - export NUM_FV_BATCHES=4
        - export RUN_UT=true
        - export FV_FOCUS='_BPF_.*ct=true'
        - mkdir artifacts
        - ../.semaphore/vms/create-test-vms ${VM_PREFIX}
    jobs:
      - name: "Felix: BPF tests on Ubuntu 22.04 (nftables)"
        env_vars:
          - name: FELIX_FV_NFTABLES
            value: "Enabled"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
        execution_time_limit:
          minutes: 180
        commands:
          - ../.semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - ../.semaphore/vms/collect-artifacts-from-vms ${VM_PREFIX}
          - '../.semaphore/vms/publish-reports "BPF/Ubuntu-22.04/nftables"'
          - ../.semaphore/vms/clean-up-vms ${VM_PREFIX}
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests on Ubuntu 25.04"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - cd felix
        - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
        - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
        - export ZONE=europe-west3-c
        - export JOB_TAG=felix-2504
        - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-${JOB_TAG}-
        - echo VM_PREFIX=${VM_PREFIX}
        - export COMPONENT=felix
        - export IMAGE=ubuntu-2504-plucky-amd64-v20250805
        - export UBUNTU_VERSION=plucky
        - export DOCKER_VERSION=5:28.3.3-1~ubuntu.25.04~plucky
        - export NUM_FV_BATCHES=0
        - export RUN_UT=true
        - export UT_FOCUS="TestPrecompiledBinariesAreLoadable"
        - mkdir artifacts
        - ../.semaphore/vms/create-test-vms ${VM_PREFIX}
    jobs:
      - name: "Felix: BPF tests on Ubuntu 25.04, load/verify programs"
        env_vars:
          - name: FELIX_FV_NFTABLES
            value: "Enabled"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
        execution_time_limit:
          minutes: 60
        commands:
          - ../.semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - ../.semaphore/vms/collect-artifacts-from-vms ${VM_PREFIX}
          - '../.semaphore/vms/publish-reports "BPF/Ubuntu-25.04/nftables"'
          - ../.semaphore/vms/clean-up-vms ${VM_PREFIX}
    secrets:
      - name: google-service-account-for-gce
- name: "Felix: BPF tests with bpf_jit_harden=2"
  run:
    when: "${CHANGE_IN(felix,typha,non-go:/.semaphore/vms/)}"
  dependencies:
    - Prerequisites
  task:
    prologue:
      commands:
        - mkdir -p artifacts
        - cd felix
        - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
        - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
        - export ZONE=europe-west3-c
        - export JOB_TAG=felix-jithard
        - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-${JOB_TAG}-
        - echo VM_PREFIX=${VM_PREFIX}
        - export COMPONENT=felix
        - export IMAGE=ubuntu-2504-plucky-amd64-v20250805
        - export UBUNTU_VERSION=plucky
        - export DOCKER_VERSION=5:28.3.3-1~ubuntu.25.04~plucky
        - export NUM_FV_BATCHES=2
        - export RUN_UT=true
        - export FV_FOCUS='_BPF_.*tcp.*ct=true'
        - ../.semaphore/vms/create-test-vms ${VM_PREFIX}
        - ../.semaphore/vms/run-on-vms ${VM_PREFIX} "sudo sysctl -w net.core.bpf_jit_harden=2"
    jobs:
      - name: "Felix: BPF tests with bpf_jit_harden=2"
        env_vars:
          - name: FELIX_FV_NFTABLES
            value: "Enabled"
          - name: FELIX_FV_BPFATTACHTYPE
            value: "tc"
          - name: FV_EXTRA_REPORT_SUFFIX
            value: "bpf_jit_harden=2"
        execution_time_limit:
          minutes: 180
        commands:
          - ../.semaphore/vms/run-tests-on-vms ${VM_PREFIX}
    epilogue:
      always:
        commands:
          - ../.semaphore/vms/collect-artifacts-from-vms ${VM_PREFIX}
          - '../.semaphore/vms/publish-reports "BPF/Ubuntu-25.04/nftables/bpf_jit_harden=2"'
          - ../.semaphore/vms/clean-up-vms ${VM_PREFIX}
    secrets:
      - name: google-service-account-for-gce
