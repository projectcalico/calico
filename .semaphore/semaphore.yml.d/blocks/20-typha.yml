- name: Typha
  run:
    when: "${CHANGE_IN(typha)}"
  dependencies:
    - Prerequisites
  task:
    env_vars:
      - name: BUILD_CACHE_GROUP
        value: "typha"
    prologue:
      commands:
        - cd typha
    jobs:
      - name: "Typha: UT and FV tests"
        commands:
          - export TEST_SUITE_PREFIX="calico/base"
          - ../.semaphore/run-and-monitor make-ci.log make ci
        env_vars:
          - name: STORE_BUILD_CACHE
            value: "true"
      - name: "Typha: FV tests on UBI-minimal"
        commands:
          - 'export TEST_SUITE_PREFIX="UBI-minimal"'
          - ../.semaphore/run-and-monitor make-fv-ubi.log make clean image fv
        env_vars:
          - name: USE_UBI_AS_CALICO_BASE
            value: '1'
    epilogue:
      always:
        commands:
          - 'test-results publish --ignore-missing ./report/*.xml ../felix/report/*.xml --suite-prefix="$TEST_SUITE_PREFIX" --name "Typha" || true'
