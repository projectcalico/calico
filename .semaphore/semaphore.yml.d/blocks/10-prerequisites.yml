- name: Prerequisites
  run:
    when: "${FORCE_RUN} or change_in(['/'], {pipeline_file: 'track'})"
  dependencies: []
  task:
    agent:
      machine:
        type: f1-standard-2
        os_image: ubuntu2204
    jobs:
      - name: Pre-flight checks
        commands:
          - make ci-preflight-checks
- name: Store working copy
  run:
    when: "branch =~ '.*'"
  dependencies: []
  task:
    env_vars:
      - name: SKIP_CACHE_RESTORE
        value: "true"
    jobs:
      - name: Save working copy to cache
        commands:
          - cd ..
          - tar --use-compress-program="zstd -3" -cf /tmp/working-copy.tar.zstd $CALICO_DIR_NAME
          - gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
          - gcloud storage cp /tmp/working-copy.tar.zstd "$gcs_branch_cache_dir/working-copy.tar.zstd"
