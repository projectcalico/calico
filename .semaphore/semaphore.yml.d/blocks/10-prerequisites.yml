- name: Prerequisites
  run:
    when: "${FORCE_RUN} or change_in(['/'], {pipeline_file: 'track'})"
  dependencies: []
  task:
    agent:
      machine:
        type: f1-standard-2
        os_image: ubuntu2204
    jobs:
      - name: Pre-flight checks
        commands:
          - make ci-preflight-checks
- name: Build core components
  run:
    when: "true"
  dependencies: []
  jobs:
  - name: Build and save build cache
    commands:
      - make -C felix build
      - make -C cni-plugin build
      - make -C typha build
      - make -C apiserver build
      - make -C kube-controllers build
      - cd ..
      - tar -czf /tmp/working-copy.tar.gz $CALICO_DIR go
      - gcs_branch_cache_dir="${GCS_CACHE_DIR}/${SEMAPHORE_GIT_BRANCH}"
      - gcloud storage cp /tmp/working-copy.tar.gz "$gcs_branch_cache_dir/working-copy.tar.gz"