version: v1.0
name: Publish hashrelease
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
execution_time_limit:
  hours: 4

global_job_config:
  secrets:
    - name: docs-ssh
    - name: marvin-github-token
    - name: gcloud-registry-access
    - name: hashrelease-docker-auth
    - name: iss-image-scanning
    - name: releasebot-slack
  prologue:
    commands:
      - chmod 0600 ~/.keys/*
      - ssh-add ~/.keys/*
      # Credentials for accessing gcloud, needed to push images to gcr
      - export GOOGLE_APPLICATION_CREDENTIALS=${HOME}/keys/.registry-viewer-serviceaccount.json
      - gcloud auth activate-service-account --key-file=${GOOGLE_APPLICATION_CREDENTIALS}
      - docker login
      - checkout

blocks:
  - name: Publish hashrelease
    task:
      jobs:
        - name: Build and publish hashrelease
          commands:
            - ./bin/release hashrelease build
            - ./bin/release hashrelease publish
      prologue:
        commands:
          - cache restore release-${SEMAPHORE_GIT_SHA}
          - cd release
      env_vars:
        - name: OPERATOR_BRANCH
          value: master
        - name: IS_HASHRELEASE
          value: true
