#!/bin/bash

set -e

echo "Removing old coverprofiles..."
find . -name "*.coverprofile" -type f -delete

echo "Calculating packages to cover..."

# Run tests in random order find tests recursively (-r).
echo WHAT: $@
echo SKIP: $SKIP
echo GINKGO_ARGS: $GINKGO_ARGS

# Go through each package we've been told to test. If there are actually test files present,
# then run those tests. If the package is included in UT_PACKAGES_TO_SKIP, we'll skip them.
for PKG in "$@"; do 
	# Skip any tests we've been told to skip.
	if [[ "$UT_PACKAGES_TO_SKIP" == *"$PKG"* ]]; then
	  echo "Skipping tests for package: ${PKG}"
	  continue
	fi

	HAS_TESTS=$(find ${PKG} -name "ut.test")
	if [ ! -z "${HAS_TESTS}" ]; then 
		echo "Running tests for package: ${PKG}";
		${PKG}/ut.test ${GINKGO_ARGS}
	else 
		echo "WARNING: No tests to run in ${PKG}, skipping"
	fi
done
