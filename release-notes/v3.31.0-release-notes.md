# Release Notes - Calico vX.XX.X

## Bug Fixes

### Critical: Fixed silent policy enforcement failure during datastore reconnection

**Impact:** HIGH  
**Severity:** Critical  
**Components:** Felix, libcalico-go

#### Problem Description

Prior to this fix, Felix could silently fail to enforce network policies when experiencing datastore watch connection interruptions. During connection loss and subsequent reconnection, Felix's calculation graph did not properly track datastore freshness states, leading to a dangerous scenario where:

- Felix believed it had up-to-date policy information
- Network policies were not being correctly enforced
- No errors or warnings were logged
- Operators had no visibility into the issue

This issue primarily affected environments with:
- Intermittent network connectivity between Felix and the datastore
- High-availability configurations with datastore failovers
- Any scenario involving temporary datastore unavailability

#### Solution

This release introduces comprehensive datastore freshness tracking in Felix's calculation graph:

**New Features:**
- **State machine for datastore freshness**: Felix now tracks four distinct states:
  - `DataFresh`: Normal operation with fresh data
  - `DataReconnecting`: Actively reconnecting to datastore
  - `DataStale`: Data is too old and may be unreliable
  - `DataUnknown`: Initial or error state

- **Age-based thresholds**: Automatic detection of stale data:
  - Event age threshold: 60 seconds
  - Per-resource age threshold: 120 seconds

- **Enhanced observability**: 
  - Detailed logging of state transitions
  - Metrics for monitoring datastore connection health
  - Clear indication when policies may not be current

**Technical Changes:**
- Enhanced `AsyncCalcGraph` to track connection state transitions
- Improved watcher cache reconnection logic in libcalico-go
- Added comprehensive test coverage for all state transition scenarios

#### Upgrade Impact

- **No configuration changes required**
- **No API changes**
- **Fully backwards compatible**
- **Safe for rolling updates**

#### Verification

After upgrading, you can verify the fix is working by:

1. Monitoring Felix logs for datastore freshness state transitions
2. Checking that Felix correctly reports reconnection events
3. Verifying that policies are enforced correctly after any connection interruptions

Look for log messages like:
```
Datastore freshness state transition: Fresh -> Reconnecting
Datastore freshness state transition: Reconnecting -> Fresh
```

#### Recommendations

1. **Monitor Felix logs** after upgrade to observe normal state transitions
2. **Consider backporting** this fix to any production clusters running earlier versions
3. **Review alerting** - ensure you have monitoring for Felix's datastore connectivity

#### Related Changes

- `felix/calc/async_calc_graph.go`: Enhanced datastore freshness tracking (113 line changes)
- `libcalico-go/lib/backend/watchersyncer/watchercache.go`: Improved reconnection handling (73 line changes)
- `felix/calc/datastore_freshness_test.go`: New comprehensive test coverage (228 lines)

#### Credits

- Issue reported by: Community
- Fixed by: @iUseArchBtw21110
- Reviewed by: Calico maintainers

---

## Other Changes

<!-- Additional changes would be listed here -->

---

## Known Issues

<!-- Any known issues would be listed here -->

---

## Installation and Upgrade Notes

### Recommended Upgrade Path

This release can be deployed as a standard rolling update. No special upgrade procedures are required.

### Compatibility

- **Kubernetes**: 1.24+
- **Container Runtimes**: Docker, containerd, CRI-O
- **Datastores**: Kubernetes API, etcd v3

### Breaking Changes

None.

---

## For More Information

- [Documentation](https://docs.tigera.io/calico)
- [Release Downloads](https://github.com/projectcalico/calico/releases)
- [Getting Started](https://docs.tigera.io/calico/latest/getting-started/)
- [Troubleshooting](https://docs.tigera.io/calico/latest/operations/troubleshoot/)
